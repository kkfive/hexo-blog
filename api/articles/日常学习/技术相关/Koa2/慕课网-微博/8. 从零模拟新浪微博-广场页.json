{"title":"八、从零模拟新浪微博-广场页面","slug":"日常学习/技术相关/Koa2/慕课网-微博/8. 从零模拟新浪微博-广场页","date":"2020-12-19T07:15:00.000Z","updated":"2022-02-21T05:08:50.402Z","comments":true,"path":"api/articles/日常学习/技术相关/Koa2/慕课网-微博/8. 从零模拟新浪微博-广场页.json","excerpt":null,"covers":null,"content":"<p>代码仓库：<a href=\"https://github.com/changeclass/koa2-weibo\">https://github.com/changeclass/koa2-weibo</a></p>\n<p>广场页与个人页面相似度很高，唯一不同的就是广场页的数据需要进行缓存。</p>\n<ol>\n<li>\n<p>控制器层</p>\n<pre class=\"line-numbers language-javascript\" data-language=\"javascript\"><code class=\"language-javascript\"><span class=\"token comment\">/**\n * @description: 微博广场\n * @author: 小康\n * @url: https://xiaokang.me\n * @Date: 2020-12-19 14:38:57\n * @LastEditTime: 2020-12-19 14:38:58\n * @LastEditors: 小康\n */</span>\n\n<span class=\"token keyword\">const</span> <span class=\"token punctuation\">&#123;</span> getSquareCacheList <span class=\"token punctuation\">&#125;</span> <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'../cache/blog'</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">const</span> <span class=\"token punctuation\">&#123;</span> <span class=\"token constant\">PAGE_SIZE</span> <span class=\"token punctuation\">&#125;</span> <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'../config/constant'</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">const</span> <span class=\"token punctuation\">&#123;</span> SuccessModel <span class=\"token punctuation\">&#125;</span> <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'../model/ResModel'</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token comment\">/**\n * @author: 小康\n * @url: https://xiaokang.me\n * @param &#123;*&#125; pageIndex 页面索引\n * @description: 获得广场的微博列表\n */</span>\n<span class=\"token keyword\">async</span> <span class=\"token keyword\">function</span> <span class=\"token function\">getSquareBlogList</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">pageIndex <span class=\"token operator\">=</span> <span class=\"token number\">0</span></span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n  <span class=\"token comment\">// cache</span>\n  <span class=\"token keyword\">const</span> result <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> <span class=\"token function\">getSquareCacheList</span><span class=\"token punctuation\">(</span>pageIndex<span class=\"token punctuation\">,</span> <span class=\"token constant\">PAGE_SIZE</span><span class=\"token punctuation\">)</span>\n  <span class=\"token keyword\">const</span> blogList <span class=\"token operator\">=</span> result<span class=\"token punctuation\">.</span>blogList\n\n  <span class=\"token keyword\">return</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">SuccessModel</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">&#123;</span>\n    isEmpty<span class=\"token operator\">:</span> blogList<span class=\"token punctuation\">.</span>length <span class=\"token operator\">===</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span>\n    blogList<span class=\"token punctuation\">,</span>\n    pageSize<span class=\"token operator\">:</span> <span class=\"token constant\">PAGE_SIZE</span><span class=\"token punctuation\">,</span>\n    pageIndex<span class=\"token punctuation\">,</span>\n    count<span class=\"token operator\">:</span> result<span class=\"token punctuation\">.</span>count\n  <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">&#125;</span>\n\nmodule<span class=\"token punctuation\">.</span>exports <span class=\"token operator\">=</span> <span class=\"token punctuation\">&#123;</span> getSquareBlogList <span class=\"token punctuation\">&#125;</span>\n<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n</li>\n<li>\n<p>缓存层</p>\n<pre class=\"line-numbers language-javascript\" data-language=\"javascript\"><code class=\"language-javascript\"><span class=\"token comment\">/**\n * @description: 微博缓存层\n * @author: 小康\n * @url: https://xiaokang.me\n * @Date: 2020-12-19 14:53:13\n * @LastEditTime: 2020-12-19 14:53:13\n * @LastEditors: 小康\n */</span>\n\n<span class=\"token keyword\">const</span> <span class=\"token punctuation\">&#123;</span> get<span class=\"token punctuation\">,</span> set <span class=\"token punctuation\">&#125;</span> <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'./_redis'</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token keyword\">const</span> <span class=\"token punctuation\">&#123;</span> getBlogListByUser <span class=\"token punctuation\">&#125;</span> <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'../services/blog'</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token comment\">// redis key 前缀</span>\n<span class=\"token keyword\">const</span> <span class=\"token constant\">KEY_PREFIX</span> <span class=\"token operator\">=</span> <span class=\"token string\">'weibo:square'</span>\n\n<span class=\"token comment\">/**\n * @author: 小康\n * @url: https://xiaokang.me\n * @param &#123;*&#125; pageIndex\n * @param &#123;*&#125; pageSize\n * @description: 获取广场列表的缓存\n */</span>\n<span class=\"token keyword\">async</span> <span class=\"token keyword\">function</span> <span class=\"token function\">getSquareCacheList</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">pageIndex<span class=\"token punctuation\">,</span> pageSize</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n  <span class=\"token keyword\">const</span> key <span class=\"token operator\">=</span> <span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">$&#123;</span><span class=\"token constant\">KEY_PREFIX</span><span class=\"token interpolation-punctuation punctuation\">&#125;</span></span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">$&#123;</span>pageIndex<span class=\"token interpolation-punctuation punctuation\">&#125;</span></span><span class=\"token string\">_</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">$&#123;</span>pageSize<span class=\"token interpolation-punctuation punctuation\">&#125;</span></span><span class=\"token template-punctuation string\">`</span></span>\n  <span class=\"token comment\">// 尝试获取缓存</span>\n  <span class=\"token keyword\">const</span> cacheResult <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> <span class=\"token function\">get</span><span class=\"token punctuation\">(</span>key<span class=\"token punctuation\">)</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>cacheResult <span class=\"token operator\">!=</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n    <span class=\"token keyword\">return</span> cacheResult\n  <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">&#123;</span>\n    <span class=\"token comment\">// 没有缓存则读取数据库</span>\n    <span class=\"token keyword\">const</span> result <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> <span class=\"token function\">getBlogListByUser</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">&#123;</span> pageIndex<span class=\"token punctuation\">,</span> pageSize <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span>\n    <span class=\"token comment\">// 设置缓存 过期时间1分钟</span>\n    <span class=\"token function\">set</span><span class=\"token punctuation\">(</span>key<span class=\"token punctuation\">,</span> result<span class=\"token punctuation\">,</span> <span class=\"token number\">60</span><span class=\"token punctuation\">)</span>\n    <span class=\"token comment\">// 返回数据</span>\n    <span class=\"token keyword\">return</span> result\n  <span class=\"token punctuation\">&#125;</span>\n<span class=\"token punctuation\">&#125;</span>\n\nmodule<span class=\"token punctuation\">.</span>exports <span class=\"token operator\">=</span> <span class=\"token punctuation\">&#123;</span>\n  getSquareCacheList\n<span class=\"token punctuation\">&#125;</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n</li>\n</ol>\n","more":"<p>代码仓库：<a href=\"https://github.com/changeclass/koa2-weibo\">https://github.com/changeclass/koa2-weibo</a></p>\n<p>广场页与个人页面相似度很高，唯一不同的就是广场页的数据需要进行缓存。</p>\n<ol>\n<li>\n<p>控制器层</p>\n<pre class=\"line-numbers language-javascript\" data-language=\"javascript\"><code class=\"language-javascript\"><span class=\"token comment\">/**\n * @description: 微博广场\n * @author: 小康\n * @url: https://xiaokang.me\n * @Date: 2020-12-19 14:38:57\n * @LastEditTime: 2020-12-19 14:38:58\n * @LastEditors: 小康\n */</span>\n\n<span class=\"token keyword\">const</span> <span class=\"token punctuation\">&#123;</span> getSquareCacheList <span class=\"token punctuation\">&#125;</span> <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'../cache/blog'</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">const</span> <span class=\"token punctuation\">&#123;</span> <span class=\"token constant\">PAGE_SIZE</span> <span class=\"token punctuation\">&#125;</span> <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'../config/constant'</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">const</span> <span class=\"token punctuation\">&#123;</span> SuccessModel <span class=\"token punctuation\">&#125;</span> <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'../model/ResModel'</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token comment\">/**\n * @author: 小康\n * @url: https://xiaokang.me\n * @param &#123;*&#125; pageIndex 页面索引\n * @description: 获得广场的微博列表\n */</span>\n<span class=\"token keyword\">async</span> <span class=\"token keyword\">function</span> <span class=\"token function\">getSquareBlogList</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">pageIndex <span class=\"token operator\">=</span> <span class=\"token number\">0</span></span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n  <span class=\"token comment\">// cache</span>\n  <span class=\"token keyword\">const</span> result <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> <span class=\"token function\">getSquareCacheList</span><span class=\"token punctuation\">(</span>pageIndex<span class=\"token punctuation\">,</span> <span class=\"token constant\">PAGE_SIZE</span><span class=\"token punctuation\">)</span>\n  <span class=\"token keyword\">const</span> blogList <span class=\"token operator\">=</span> result<span class=\"token punctuation\">.</span>blogList\n\n  <span class=\"token keyword\">return</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">SuccessModel</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">&#123;</span>\n    isEmpty<span class=\"token operator\">:</span> blogList<span class=\"token punctuation\">.</span>length <span class=\"token operator\">===</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span>\n    blogList<span class=\"token punctuation\">,</span>\n    pageSize<span class=\"token operator\">:</span> <span class=\"token constant\">PAGE_SIZE</span><span class=\"token punctuation\">,</span>\n    pageIndex<span class=\"token punctuation\">,</span>\n    count<span class=\"token operator\">:</span> result<span class=\"token punctuation\">.</span>count\n  <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">&#125;</span>\n\nmodule<span class=\"token punctuation\">.</span>exports <span class=\"token operator\">=</span> <span class=\"token punctuation\">&#123;</span> getSquareBlogList <span class=\"token punctuation\">&#125;</span>\n<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n</li>\n<li>\n<p>缓存层</p>\n<pre class=\"line-numbers language-javascript\" data-language=\"javascript\"><code class=\"language-javascript\"><span class=\"token comment\">/**\n * @description: 微博缓存层\n * @author: 小康\n * @url: https://xiaokang.me\n * @Date: 2020-12-19 14:53:13\n * @LastEditTime: 2020-12-19 14:53:13\n * @LastEditors: 小康\n */</span>\n\n<span class=\"token keyword\">const</span> <span class=\"token punctuation\">&#123;</span> get<span class=\"token punctuation\">,</span> set <span class=\"token punctuation\">&#125;</span> <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'./_redis'</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token keyword\">const</span> <span class=\"token punctuation\">&#123;</span> getBlogListByUser <span class=\"token punctuation\">&#125;</span> <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'../services/blog'</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token comment\">// redis key 前缀</span>\n<span class=\"token keyword\">const</span> <span class=\"token constant\">KEY_PREFIX</span> <span class=\"token operator\">=</span> <span class=\"token string\">'weibo:square'</span>\n\n<span class=\"token comment\">/**\n * @author: 小康\n * @url: https://xiaokang.me\n * @param &#123;*&#125; pageIndex\n * @param &#123;*&#125; pageSize\n * @description: 获取广场列表的缓存\n */</span>\n<span class=\"token keyword\">async</span> <span class=\"token keyword\">function</span> <span class=\"token function\">getSquareCacheList</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">pageIndex<span class=\"token punctuation\">,</span> pageSize</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n  <span class=\"token keyword\">const</span> key <span class=\"token operator\">=</span> <span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">$&#123;</span><span class=\"token constant\">KEY_PREFIX</span><span class=\"token interpolation-punctuation punctuation\">&#125;</span></span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">$&#123;</span>pageIndex<span class=\"token interpolation-punctuation punctuation\">&#125;</span></span><span class=\"token string\">_</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">$&#123;</span>pageSize<span class=\"token interpolation-punctuation punctuation\">&#125;</span></span><span class=\"token template-punctuation string\">`</span></span>\n  <span class=\"token comment\">// 尝试获取缓存</span>\n  <span class=\"token keyword\">const</span> cacheResult <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> <span class=\"token function\">get</span><span class=\"token punctuation\">(</span>key<span class=\"token punctuation\">)</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>cacheResult <span class=\"token operator\">!=</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n    <span class=\"token keyword\">return</span> cacheResult\n  <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">&#123;</span>\n    <span class=\"token comment\">// 没有缓存则读取数据库</span>\n    <span class=\"token keyword\">const</span> result <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> <span class=\"token function\">getBlogListByUser</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">&#123;</span> pageIndex<span class=\"token punctuation\">,</span> pageSize <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span>\n    <span class=\"token comment\">// 设置缓存 过期时间1分钟</span>\n    <span class=\"token function\">set</span><span class=\"token punctuation\">(</span>key<span class=\"token punctuation\">,</span> result<span class=\"token punctuation\">,</span> <span class=\"token number\">60</span><span class=\"token punctuation\">)</span>\n    <span class=\"token comment\">// 返回数据</span>\n    <span class=\"token keyword\">return</span> result\n  <span class=\"token punctuation\">&#125;</span>\n<span class=\"token punctuation\">&#125;</span>\n\nmodule<span class=\"token punctuation\">.</span>exports <span class=\"token operator\">=</span> <span class=\"token punctuation\">&#123;</span>\n  getSquareCacheList\n<span class=\"token punctuation\">&#125;</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n</li>\n</ol>\n","categories":[{"name":"慕课网","path":"api/categories/慕课网.json"},{"name":"Koa2","path":"api/categories/Koa2.json"}],"tags":[{"name":"koa2","path":"api/tags/koa2.json"}]}