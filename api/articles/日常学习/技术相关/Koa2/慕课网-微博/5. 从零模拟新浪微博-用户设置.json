{"title":"五、从零模拟新浪微博-用户设置","slug":"日常学习/技术相关/Koa2/慕课网-微博/5. 从零模拟新浪微博-用户设置","date":"2020-12-18T05:37:00.000Z","updated":"2022-02-21T04:45:27.392Z","comments":true,"path":"api/articles/日常学习/技术相关/Koa2/慕课网-微博/5. 从零模拟新浪微博-用户设置.json","excerpt":null,"covers":null,"content":"<p>代码仓库：<a href=\"https://github.com/changeclass/koa2-weibo\">https://github.com/changeclass/koa2-weibo</a></p>\n<h2 id=\"文件上传\"><a class=\"markdownIt-Anchor\" href=\"#文件上传\"></a> 文件上传</h2>\n<p>安装插件(<a href=\"https://www.npmjs.com/package/formidable-upload-koa\">https://www.npmjs.com/package/formidable-upload-koa</a>)</p>\n<pre class=\"line-numbers language-bash\" data-language=\"bash\"><code class=\"language-bash\"><span class=\"token function\">yarn</span> <span class=\"token function\">add</span> formidable-upload-koa fs-extra<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n<ol>\n<li>\n<p><code>api</code>路由层实现</p>\n<pre class=\"line-numbers language-javascript\" data-language=\"javascript\"><code class=\"language-javascript\"><span class=\"token comment\">/**\n * @description:utils api 路由\n * @author: 小康\n * @url: https://xiaokang.me\n * @Date: 2020-12-18 14:08:00\n * @LastEditTime: 2020-12-18 14:08:03\n * @LastEditors: 小康\n */</span>\n\n<span class=\"token keyword\">const</span> router <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'koa-router'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">const</span> koaFrom <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'formidable-upload-koa'</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">const</span> <span class=\"token punctuation\">&#123;</span> saveFile <span class=\"token punctuation\">&#125;</span> <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'../../controller/utils'</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">const</span> <span class=\"token punctuation\">&#123;</span> loginCheck <span class=\"token punctuation\">&#125;</span> <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'../../middlewares/loginChecks'</span><span class=\"token punctuation\">)</span>\nrouter<span class=\"token punctuation\">.</span><span class=\"token function\">prefix</span><span class=\"token punctuation\">(</span><span class=\"token string\">'/api/utils'</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token comment\">// 上传图片</span>\nrouter<span class=\"token punctuation\">.</span><span class=\"token function\">post</span><span class=\"token punctuation\">(</span><span class=\"token string\">'/upload'</span><span class=\"token punctuation\">,</span> loginCheck<span class=\"token punctuation\">,</span> <span class=\"token function\">koaFrom</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">async</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">ctx<span class=\"token punctuation\">,</span> next</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span>\n  <span class=\"token comment\">// 获取文件</span>\n  <span class=\"token keyword\">const</span> file <span class=\"token operator\">=</span> ctx<span class=\"token punctuation\">.</span>req<span class=\"token punctuation\">.</span>files<span class=\"token punctuation\">[</span><span class=\"token string\">'file'</span><span class=\"token punctuation\">]</span>\n  <span class=\"token comment\">// 获取文件信息</span>\n  <span class=\"token keyword\">const</span> <span class=\"token punctuation\">&#123;</span> size<span class=\"token punctuation\">,</span> path<span class=\"token punctuation\">,</span> name<span class=\"token punctuation\">,</span> type <span class=\"token punctuation\">&#125;</span> <span class=\"token operator\">=</span> file\n  ctx<span class=\"token punctuation\">.</span>body <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> <span class=\"token function\">saveFile</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">&#123;</span> size<span class=\"token punctuation\">,</span> filePath<span class=\"token operator\">:</span> path<span class=\"token punctuation\">,</span> name<span class=\"token punctuation\">,</span> type <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span>\n\nmodule<span class=\"token punctuation\">.</span>exports <span class=\"token operator\">=</span> router<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n</li>\n<li>\n<p><code>controller</code>层实现</p>\n<pre class=\"line-numbers language-javascript\" data-language=\"javascript\"><code class=\"language-javascript\"><span class=\"token comment\">/**\n * @description: utils controller\n * @author: 小康\n * @url: https://xiaokang.me\n * @Date: 2020-12-18 14:13:20\n * @LastEditTime: 2020-12-18 14:13:20\n * @LastEditors: 小康\n */</span>\n<span class=\"token keyword\">const</span> path <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'path'</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">const</span> <span class=\"token punctuation\">&#123;</span> uploadFileSizeFailInfo <span class=\"token punctuation\">&#125;</span> <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'../model/ErrorInfo'</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">const</span> <span class=\"token punctuation\">&#123;</span> SuccessModel<span class=\"token punctuation\">,</span> ErrorModel <span class=\"token punctuation\">&#125;</span> <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'../model/ResModel'</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">const</span> fse <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'fs-extra'</span><span class=\"token punctuation\">)</span>\n<span class=\"token comment\">// 文件最大体积 （5m）</span>\n<span class=\"token keyword\">const</span> <span class=\"token constant\">MAX_SIZE</span> <span class=\"token operator\">=</span> <span class=\"token number\">5</span> <span class=\"token operator\">*</span> <span class=\"token number\">1024</span> <span class=\"token operator\">*</span> <span class=\"token number\">1024</span> <span class=\"token operator\">*</span> <span class=\"token number\">1024</span>\n<span class=\"token comment\">// 存储目录</span>\n<span class=\"token keyword\">const</span> <span class=\"token constant\">DIST_FOLDER_PATH</span> <span class=\"token operator\">=</span> path<span class=\"token punctuation\">.</span><span class=\"token function\">join</span><span class=\"token punctuation\">(</span>__dirname<span class=\"token punctuation\">,</span> <span class=\"token string\">'..'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'..'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'uploadFiles'</span><span class=\"token punctuation\">)</span>\n<span class=\"token comment\">// 是否需要创建目录</span>\nfse<span class=\"token punctuation\">.</span><span class=\"token function\">pathExists</span><span class=\"token punctuation\">(</span><span class=\"token constant\">DIST_FOLDER_PATH</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">exist</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>exist<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n    fse<span class=\"token punctuation\">.</span><span class=\"token function\">ensureDir</span><span class=\"token punctuation\">(</span><span class=\"token constant\">DIST_FOLDER_PATH</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">&#125;</span>\n<span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span>\n<span class=\"token comment\">/**\n * @author: 小康\n * @url: https://xiaokang.me\n * @param &#123;string&#125; name 文件名\n * @param &#123;String&#125; type 文件类型\n * @param &#123;String&#125; size 文件大小\n * @param &#123;String&#125; filePath 文件地址\n * @description: 存储文件\n */</span>\n<span class=\"token keyword\">async</span> <span class=\"token keyword\">function</span> <span class=\"token function\">saveFile</span><span class=\"token punctuation\">(</span><span class=\"token parameter\"><span class=\"token punctuation\">&#123;</span> name<span class=\"token punctuation\">,</span> type<span class=\"token punctuation\">,</span> size<span class=\"token punctuation\">,</span> filePath <span class=\"token punctuation\">&#125;</span></span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n  <span class=\"token comment\">// 如果文件大小超过设定</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>size <span class=\"token operator\">></span> <span class=\"token constant\">MAX_SIZE</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n    <span class=\"token comment\">// 删除文件</span>\n    <span class=\"token keyword\">await</span> fse<span class=\"token punctuation\">.</span><span class=\"token function\">remove</span><span class=\"token punctuation\">(</span>filePath<span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">return</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">ErrorModel</span><span class=\"token punctuation\">(</span>uploadFileSizeFailInfo<span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">&#125;</span>\n  <span class=\"token comment\">// 移动文件</span>\n  <span class=\"token keyword\">const</span> fileName <span class=\"token operator\">=</span> Date<span class=\"token punctuation\">.</span><span class=\"token function\">now</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> <span class=\"token string\">'.'</span> <span class=\"token operator\">+</span> name <span class=\"token comment\">// 防止重名</span>\n  <span class=\"token keyword\">const</span> distFilePath <span class=\"token operator\">=</span> path<span class=\"token punctuation\">.</span><span class=\"token function\">join</span><span class=\"token punctuation\">(</span><span class=\"token constant\">DIST_FOLDER_PATH</span><span class=\"token punctuation\">,</span> fileName<span class=\"token punctuation\">)</span> <span class=\"token comment\">// 目的地</span>\n  <span class=\"token keyword\">await</span> fse<span class=\"token punctuation\">.</span><span class=\"token function\">move</span><span class=\"token punctuation\">(</span>filePath<span class=\"token punctuation\">,</span> distFilePath<span class=\"token punctuation\">)</span>\n  <span class=\"token comment\">// 返回信息</span>\n  <span class=\"token keyword\">return</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">SuccessModel</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">&#123;</span>\n    url<span class=\"token operator\">:</span> <span class=\"token string\">'/'</span> <span class=\"token operator\">+</span> fileName\n  <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">&#125;</span>\n\nmodule<span class=\"token punctuation\">.</span>exports <span class=\"token operator\">=</span> <span class=\"token punctuation\">&#123;</span>\n  saveFile\n<span class=\"token punctuation\">&#125;</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n</li>\n<li>\n<p>最后在入口文件注册路由并且开发目录即可。</p>\n<pre class=\"line-numbers language-javascript\" data-language=\"javascript\"><code class=\"language-javascript\">app<span class=\"token punctuation\">.</span><span class=\"token function\">use</span><span class=\"token punctuation\">(</span><span class=\"token function\">koaStatic</span><span class=\"token punctuation\">(</span>path<span class=\"token punctuation\">.</span><span class=\"token function\">join</span><span class=\"token punctuation\">(</span>__dirname<span class=\"token punctuation\">,</span> <span class=\"token string\">'..'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'uploadFiles'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\napp<span class=\"token punctuation\">.</span><span class=\"token function\">use</span><span class=\"token punctuation\">(</span>utilsAPIRouter<span class=\"token punctuation\">.</span><span class=\"token function\">routes</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> utilsAPIRouter<span class=\"token punctuation\">.</span><span class=\"token function\">allowedMethods</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span></span></code></pre>\n</li>\n</ol>\n<h2 id=\"修改个人基本信息\"><a class=\"markdownIt-Anchor\" href=\"#修改个人基本信息\"></a> 修改个人基本信息</h2>\n<ol>\n<li>\n<p><code>api</code>路由层</p>\n<pre class=\"line-numbers language-javascript\" data-language=\"javascript\"><code class=\"language-javascript\">router<span class=\"token punctuation\">.</span><span class=\"token function\">patch</span><span class=\"token punctuation\">(</span>\n  <span class=\"token string\">'/changeInfo'</span><span class=\"token punctuation\">,</span>\n  loginCheck<span class=\"token punctuation\">,</span>\n  <span class=\"token function\">genValidator</span><span class=\"token punctuation\">(</span>userValidate<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n  <span class=\"token keyword\">async</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">ctx<span class=\"token punctuation\">,</span> next</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span>\n    <span class=\"token keyword\">const</span> <span class=\"token punctuation\">&#123;</span> nickName<span class=\"token punctuation\">,</span> city<span class=\"token punctuation\">,</span> picture <span class=\"token punctuation\">&#125;</span> <span class=\"token operator\">=</span> ctx<span class=\"token punctuation\">.</span>request<span class=\"token punctuation\">.</span>body\n    ctx<span class=\"token punctuation\">.</span>body <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> <span class=\"token function\">changeInfo</span><span class=\"token punctuation\">(</span>ctx<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">&#123;</span> nickName<span class=\"token punctuation\">,</span> city<span class=\"token punctuation\">,</span> picture <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">&#125;</span>\n<span class=\"token punctuation\">)</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n</li>\n<li>\n<p><code>controller</code>层</p>\n<pre class=\"line-numbers language-javascript\" data-language=\"javascript\"><code class=\"language-javascript\">\n<span class=\"token comment\">/**\n * @author: 小康\n * @url: https://xiaokang.me\n * @param &#123;Object&#125; ctx\n * @param &#123;string&#125; nickName 昵称\n * @param &#123;string&#125; city 地区\n * @param &#123;string&#125; picture 头像地址\n * @description: 修改个人信息\n */</span>\n<span class=\"token keyword\">async</span> <span class=\"token keyword\">function</span> <span class=\"token function\">changeInfo</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">ctx<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">&#123;</span> nickName<span class=\"token punctuation\">,</span> city<span class=\"token punctuation\">,</span> picture <span class=\"token punctuation\">&#125;</span></span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n  <span class=\"token keyword\">const</span> <span class=\"token punctuation\">&#123;</span> userName <span class=\"token punctuation\">&#125;</span> <span class=\"token operator\">=</span> ctx<span class=\"token punctuation\">.</span>session<span class=\"token punctuation\">.</span>userInfo\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>nickName<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n    nickName <span class=\"token operator\">=</span> userName\n  <span class=\"token punctuation\">&#125;</span>\n  <span class=\"token comment\">// servers</span>\n  <span class=\"token keyword\">const</span> result <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> <span class=\"token function\">updateUser</span><span class=\"token punctuation\">(</span>\n    <span class=\"token punctuation\">&#123;</span>\n      newNickName<span class=\"token operator\">:</span> nickName<span class=\"token punctuation\">,</span>\n      newCity<span class=\"token operator\">:</span> city<span class=\"token punctuation\">,</span>\n      newPicture<span class=\"token operator\">:</span> picture\n    <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">&#123;</span> userName <span class=\"token punctuation\">&#125;</span>\n  <span class=\"token punctuation\">)</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>result<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n    Object<span class=\"token punctuation\">.</span><span class=\"token function\">assign</span><span class=\"token punctuation\">(</span>ctx<span class=\"token punctuation\">.</span>session<span class=\"token punctuation\">.</span>userInfo<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">&#123;</span>\n      nickName<span class=\"token punctuation\">,</span>\n      city<span class=\"token punctuation\">,</span>\n      picture\n    <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">return</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">SuccessModel</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">&#123;</span>\n    <span class=\"token keyword\">return</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">ErrorModel</span><span class=\"token punctuation\">(</span>changeInfoFailInfo<span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">&#125;</span>\n<span class=\"token punctuation\">&#125;</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n</li>\n<li>\n<p><code>server</code>层</p>\n<pre class=\"line-numbers language-javascript\" data-language=\"javascript\"><code class=\"language-javascript\">\n<span class=\"token comment\">/**\n * 更新用户个人信息\n * @author 小康\n * @date 2020-12-18\n * @param &#123;Object&#125; &#123; newPassword,newNickName,newPicture,newcity &#125;\n * @param &#123;Object&#125; &#123; userName,password &#125;\n * @returns &#123;Boolean&#125; 是否修改成功\n */</span>\n<span class=\"token keyword\">async</span> <span class=\"token keyword\">function</span> <span class=\"token function\">updateUser</span><span class=\"token punctuation\">(</span>\n  <span class=\"token parameter\"><span class=\"token punctuation\">&#123;</span> newPassword<span class=\"token punctuation\">,</span> newNickName<span class=\"token punctuation\">,</span> newPicture<span class=\"token punctuation\">,</span> newCity <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">&#123;</span> userName<span class=\"token punctuation\">,</span> password <span class=\"token punctuation\">&#125;</span></span>\n<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n  <span class=\"token keyword\">const</span> updateData <span class=\"token operator\">=</span> <span class=\"token punctuation\">&#123;</span><span class=\"token punctuation\">&#125;</span>\n  <span class=\"token comment\">// 拼接修改内容</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>newPassword<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n    updateData<span class=\"token punctuation\">.</span>password <span class=\"token operator\">=</span> newPassword\n  <span class=\"token punctuation\">&#125;</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>newNickName<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n    updateData<span class=\"token punctuation\">.</span>nickName <span class=\"token operator\">=</span> newNickName\n  <span class=\"token punctuation\">&#125;</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>newPicture<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n    updateData<span class=\"token punctuation\">.</span>picture <span class=\"token operator\">=</span> newPicture\n  <span class=\"token punctuation\">&#125;</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>newCity<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n    updateData<span class=\"token punctuation\">.</span>city <span class=\"token operator\">=</span> newCity\n  <span class=\"token punctuation\">&#125;</span>\n  <span class=\"token comment\">// 拼接查询条件</span>\n  <span class=\"token keyword\">const</span> whereData <span class=\"token operator\">=</span> <span class=\"token punctuation\">&#123;</span> userName <span class=\"token punctuation\">&#125;</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>password<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n    whereData<span class=\"token punctuation\">.</span>password <span class=\"token operator\">=</span> password\n  <span class=\"token punctuation\">&#125;</span>\n  <span class=\"token comment\">// 执行修改</span>\n  <span class=\"token keyword\">const</span> result <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> User<span class=\"token punctuation\">.</span><span class=\"token function\">update</span><span class=\"token punctuation\">(</span>updateData<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">&#123;</span>\n    where<span class=\"token operator\">:</span> whereData\n  <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span>\n  <span class=\"token keyword\">return</span> result<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">></span> <span class=\"token number\">0</span>\n<span class=\"token punctuation\">&#125;</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n</li>\n</ol>\n","more":"<p>代码仓库：<a href=\"https://github.com/changeclass/koa2-weibo\">https://github.com/changeclass/koa2-weibo</a></p>\n<h2 id=\"文件上传\"><a class=\"markdownIt-Anchor\" href=\"#文件上传\"></a> 文件上传</h2>\n<p>安装插件(<a href=\"https://www.npmjs.com/package/formidable-upload-koa\">https://www.npmjs.com/package/formidable-upload-koa</a>)</p>\n<pre class=\"line-numbers language-bash\" data-language=\"bash\"><code class=\"language-bash\"><span class=\"token function\">yarn</span> <span class=\"token function\">add</span> formidable-upload-koa fs-extra<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n<ol>\n<li>\n<p><code>api</code>路由层实现</p>\n<pre class=\"line-numbers language-javascript\" data-language=\"javascript\"><code class=\"language-javascript\"><span class=\"token comment\">/**\n * @description:utils api 路由\n * @author: 小康\n * @url: https://xiaokang.me\n * @Date: 2020-12-18 14:08:00\n * @LastEditTime: 2020-12-18 14:08:03\n * @LastEditors: 小康\n */</span>\n\n<span class=\"token keyword\">const</span> router <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'koa-router'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">const</span> koaFrom <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'formidable-upload-koa'</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">const</span> <span class=\"token punctuation\">&#123;</span> saveFile <span class=\"token punctuation\">&#125;</span> <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'../../controller/utils'</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">const</span> <span class=\"token punctuation\">&#123;</span> loginCheck <span class=\"token punctuation\">&#125;</span> <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'../../middlewares/loginChecks'</span><span class=\"token punctuation\">)</span>\nrouter<span class=\"token punctuation\">.</span><span class=\"token function\">prefix</span><span class=\"token punctuation\">(</span><span class=\"token string\">'/api/utils'</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token comment\">// 上传图片</span>\nrouter<span class=\"token punctuation\">.</span><span class=\"token function\">post</span><span class=\"token punctuation\">(</span><span class=\"token string\">'/upload'</span><span class=\"token punctuation\">,</span> loginCheck<span class=\"token punctuation\">,</span> <span class=\"token function\">koaFrom</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">async</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">ctx<span class=\"token punctuation\">,</span> next</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span>\n  <span class=\"token comment\">// 获取文件</span>\n  <span class=\"token keyword\">const</span> file <span class=\"token operator\">=</span> ctx<span class=\"token punctuation\">.</span>req<span class=\"token punctuation\">.</span>files<span class=\"token punctuation\">[</span><span class=\"token string\">'file'</span><span class=\"token punctuation\">]</span>\n  <span class=\"token comment\">// 获取文件信息</span>\n  <span class=\"token keyword\">const</span> <span class=\"token punctuation\">&#123;</span> size<span class=\"token punctuation\">,</span> path<span class=\"token punctuation\">,</span> name<span class=\"token punctuation\">,</span> type <span class=\"token punctuation\">&#125;</span> <span class=\"token operator\">=</span> file\n  ctx<span class=\"token punctuation\">.</span>body <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> <span class=\"token function\">saveFile</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">&#123;</span> size<span class=\"token punctuation\">,</span> filePath<span class=\"token operator\">:</span> path<span class=\"token punctuation\">,</span> name<span class=\"token punctuation\">,</span> type <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span>\n\nmodule<span class=\"token punctuation\">.</span>exports <span class=\"token operator\">=</span> router<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n</li>\n<li>\n<p><code>controller</code>层实现</p>\n<pre class=\"line-numbers language-javascript\" data-language=\"javascript\"><code class=\"language-javascript\"><span class=\"token comment\">/**\n * @description: utils controller\n * @author: 小康\n * @url: https://xiaokang.me\n * @Date: 2020-12-18 14:13:20\n * @LastEditTime: 2020-12-18 14:13:20\n * @LastEditors: 小康\n */</span>\n<span class=\"token keyword\">const</span> path <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'path'</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">const</span> <span class=\"token punctuation\">&#123;</span> uploadFileSizeFailInfo <span class=\"token punctuation\">&#125;</span> <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'../model/ErrorInfo'</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">const</span> <span class=\"token punctuation\">&#123;</span> SuccessModel<span class=\"token punctuation\">,</span> ErrorModel <span class=\"token punctuation\">&#125;</span> <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'../model/ResModel'</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">const</span> fse <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'fs-extra'</span><span class=\"token punctuation\">)</span>\n<span class=\"token comment\">// 文件最大体积 （5m）</span>\n<span class=\"token keyword\">const</span> <span class=\"token constant\">MAX_SIZE</span> <span class=\"token operator\">=</span> <span class=\"token number\">5</span> <span class=\"token operator\">*</span> <span class=\"token number\">1024</span> <span class=\"token operator\">*</span> <span class=\"token number\">1024</span> <span class=\"token operator\">*</span> <span class=\"token number\">1024</span>\n<span class=\"token comment\">// 存储目录</span>\n<span class=\"token keyword\">const</span> <span class=\"token constant\">DIST_FOLDER_PATH</span> <span class=\"token operator\">=</span> path<span class=\"token punctuation\">.</span><span class=\"token function\">join</span><span class=\"token punctuation\">(</span>__dirname<span class=\"token punctuation\">,</span> <span class=\"token string\">'..'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'..'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'uploadFiles'</span><span class=\"token punctuation\">)</span>\n<span class=\"token comment\">// 是否需要创建目录</span>\nfse<span class=\"token punctuation\">.</span><span class=\"token function\">pathExists</span><span class=\"token punctuation\">(</span><span class=\"token constant\">DIST_FOLDER_PATH</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">exist</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>exist<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n    fse<span class=\"token punctuation\">.</span><span class=\"token function\">ensureDir</span><span class=\"token punctuation\">(</span><span class=\"token constant\">DIST_FOLDER_PATH</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">&#125;</span>\n<span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span>\n<span class=\"token comment\">/**\n * @author: 小康\n * @url: https://xiaokang.me\n * @param &#123;string&#125; name 文件名\n * @param &#123;String&#125; type 文件类型\n * @param &#123;String&#125; size 文件大小\n * @param &#123;String&#125; filePath 文件地址\n * @description: 存储文件\n */</span>\n<span class=\"token keyword\">async</span> <span class=\"token keyword\">function</span> <span class=\"token function\">saveFile</span><span class=\"token punctuation\">(</span><span class=\"token parameter\"><span class=\"token punctuation\">&#123;</span> name<span class=\"token punctuation\">,</span> type<span class=\"token punctuation\">,</span> size<span class=\"token punctuation\">,</span> filePath <span class=\"token punctuation\">&#125;</span></span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n  <span class=\"token comment\">// 如果文件大小超过设定</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>size <span class=\"token operator\">></span> <span class=\"token constant\">MAX_SIZE</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n    <span class=\"token comment\">// 删除文件</span>\n    <span class=\"token keyword\">await</span> fse<span class=\"token punctuation\">.</span><span class=\"token function\">remove</span><span class=\"token punctuation\">(</span>filePath<span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">return</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">ErrorModel</span><span class=\"token punctuation\">(</span>uploadFileSizeFailInfo<span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">&#125;</span>\n  <span class=\"token comment\">// 移动文件</span>\n  <span class=\"token keyword\">const</span> fileName <span class=\"token operator\">=</span> Date<span class=\"token punctuation\">.</span><span class=\"token function\">now</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> <span class=\"token string\">'.'</span> <span class=\"token operator\">+</span> name <span class=\"token comment\">// 防止重名</span>\n  <span class=\"token keyword\">const</span> distFilePath <span class=\"token operator\">=</span> path<span class=\"token punctuation\">.</span><span class=\"token function\">join</span><span class=\"token punctuation\">(</span><span class=\"token constant\">DIST_FOLDER_PATH</span><span class=\"token punctuation\">,</span> fileName<span class=\"token punctuation\">)</span> <span class=\"token comment\">// 目的地</span>\n  <span class=\"token keyword\">await</span> fse<span class=\"token punctuation\">.</span><span class=\"token function\">move</span><span class=\"token punctuation\">(</span>filePath<span class=\"token punctuation\">,</span> distFilePath<span class=\"token punctuation\">)</span>\n  <span class=\"token comment\">// 返回信息</span>\n  <span class=\"token keyword\">return</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">SuccessModel</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">&#123;</span>\n    url<span class=\"token operator\">:</span> <span class=\"token string\">'/'</span> <span class=\"token operator\">+</span> fileName\n  <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">&#125;</span>\n\nmodule<span class=\"token punctuation\">.</span>exports <span class=\"token operator\">=</span> <span class=\"token punctuation\">&#123;</span>\n  saveFile\n<span class=\"token punctuation\">&#125;</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n</li>\n<li>\n<p>最后在入口文件注册路由并且开发目录即可。</p>\n<pre class=\"line-numbers language-javascript\" data-language=\"javascript\"><code class=\"language-javascript\">app<span class=\"token punctuation\">.</span><span class=\"token function\">use</span><span class=\"token punctuation\">(</span><span class=\"token function\">koaStatic</span><span class=\"token punctuation\">(</span>path<span class=\"token punctuation\">.</span><span class=\"token function\">join</span><span class=\"token punctuation\">(</span>__dirname<span class=\"token punctuation\">,</span> <span class=\"token string\">'..'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'uploadFiles'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\napp<span class=\"token punctuation\">.</span><span class=\"token function\">use</span><span class=\"token punctuation\">(</span>utilsAPIRouter<span class=\"token punctuation\">.</span><span class=\"token function\">routes</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> utilsAPIRouter<span class=\"token punctuation\">.</span><span class=\"token function\">allowedMethods</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span></span></code></pre>\n</li>\n</ol>\n<h2 id=\"修改个人基本信息\"><a class=\"markdownIt-Anchor\" href=\"#修改个人基本信息\"></a> 修改个人基本信息</h2>\n<ol>\n<li>\n<p><code>api</code>路由层</p>\n<pre class=\"line-numbers language-javascript\" data-language=\"javascript\"><code class=\"language-javascript\">router<span class=\"token punctuation\">.</span><span class=\"token function\">patch</span><span class=\"token punctuation\">(</span>\n  <span class=\"token string\">'/changeInfo'</span><span class=\"token punctuation\">,</span>\n  loginCheck<span class=\"token punctuation\">,</span>\n  <span class=\"token function\">genValidator</span><span class=\"token punctuation\">(</span>userValidate<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n  <span class=\"token keyword\">async</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">ctx<span class=\"token punctuation\">,</span> next</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span>\n    <span class=\"token keyword\">const</span> <span class=\"token punctuation\">&#123;</span> nickName<span class=\"token punctuation\">,</span> city<span class=\"token punctuation\">,</span> picture <span class=\"token punctuation\">&#125;</span> <span class=\"token operator\">=</span> ctx<span class=\"token punctuation\">.</span>request<span class=\"token punctuation\">.</span>body\n    ctx<span class=\"token punctuation\">.</span>body <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> <span class=\"token function\">changeInfo</span><span class=\"token punctuation\">(</span>ctx<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">&#123;</span> nickName<span class=\"token punctuation\">,</span> city<span class=\"token punctuation\">,</span> picture <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">&#125;</span>\n<span class=\"token punctuation\">)</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n</li>\n<li>\n<p><code>controller</code>层</p>\n<pre class=\"line-numbers language-javascript\" data-language=\"javascript\"><code class=\"language-javascript\">\n<span class=\"token comment\">/**\n * @author: 小康\n * @url: https://xiaokang.me\n * @param &#123;Object&#125; ctx\n * @param &#123;string&#125; nickName 昵称\n * @param &#123;string&#125; city 地区\n * @param &#123;string&#125; picture 头像地址\n * @description: 修改个人信息\n */</span>\n<span class=\"token keyword\">async</span> <span class=\"token keyword\">function</span> <span class=\"token function\">changeInfo</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">ctx<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">&#123;</span> nickName<span class=\"token punctuation\">,</span> city<span class=\"token punctuation\">,</span> picture <span class=\"token punctuation\">&#125;</span></span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n  <span class=\"token keyword\">const</span> <span class=\"token punctuation\">&#123;</span> userName <span class=\"token punctuation\">&#125;</span> <span class=\"token operator\">=</span> ctx<span class=\"token punctuation\">.</span>session<span class=\"token punctuation\">.</span>userInfo\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>nickName<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n    nickName <span class=\"token operator\">=</span> userName\n  <span class=\"token punctuation\">&#125;</span>\n  <span class=\"token comment\">// servers</span>\n  <span class=\"token keyword\">const</span> result <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> <span class=\"token function\">updateUser</span><span class=\"token punctuation\">(</span>\n    <span class=\"token punctuation\">&#123;</span>\n      newNickName<span class=\"token operator\">:</span> nickName<span class=\"token punctuation\">,</span>\n      newCity<span class=\"token operator\">:</span> city<span class=\"token punctuation\">,</span>\n      newPicture<span class=\"token operator\">:</span> picture\n    <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">&#123;</span> userName <span class=\"token punctuation\">&#125;</span>\n  <span class=\"token punctuation\">)</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>result<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n    Object<span class=\"token punctuation\">.</span><span class=\"token function\">assign</span><span class=\"token punctuation\">(</span>ctx<span class=\"token punctuation\">.</span>session<span class=\"token punctuation\">.</span>userInfo<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">&#123;</span>\n      nickName<span class=\"token punctuation\">,</span>\n      city<span class=\"token punctuation\">,</span>\n      picture\n    <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">return</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">SuccessModel</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">&#123;</span>\n    <span class=\"token keyword\">return</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">ErrorModel</span><span class=\"token punctuation\">(</span>changeInfoFailInfo<span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">&#125;</span>\n<span class=\"token punctuation\">&#125;</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n</li>\n<li>\n<p><code>server</code>层</p>\n<pre class=\"line-numbers language-javascript\" data-language=\"javascript\"><code class=\"language-javascript\">\n<span class=\"token comment\">/**\n * 更新用户个人信息\n * @author 小康\n * @date 2020-12-18\n * @param &#123;Object&#125; &#123; newPassword,newNickName,newPicture,newcity &#125;\n * @param &#123;Object&#125; &#123; userName,password &#125;\n * @returns &#123;Boolean&#125; 是否修改成功\n */</span>\n<span class=\"token keyword\">async</span> <span class=\"token keyword\">function</span> <span class=\"token function\">updateUser</span><span class=\"token punctuation\">(</span>\n  <span class=\"token parameter\"><span class=\"token punctuation\">&#123;</span> newPassword<span class=\"token punctuation\">,</span> newNickName<span class=\"token punctuation\">,</span> newPicture<span class=\"token punctuation\">,</span> newCity <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">&#123;</span> userName<span class=\"token punctuation\">,</span> password <span class=\"token punctuation\">&#125;</span></span>\n<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n  <span class=\"token keyword\">const</span> updateData <span class=\"token operator\">=</span> <span class=\"token punctuation\">&#123;</span><span class=\"token punctuation\">&#125;</span>\n  <span class=\"token comment\">// 拼接修改内容</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>newPassword<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n    updateData<span class=\"token punctuation\">.</span>password <span class=\"token operator\">=</span> newPassword\n  <span class=\"token punctuation\">&#125;</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>newNickName<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n    updateData<span class=\"token punctuation\">.</span>nickName <span class=\"token operator\">=</span> newNickName\n  <span class=\"token punctuation\">&#125;</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>newPicture<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n    updateData<span class=\"token punctuation\">.</span>picture <span class=\"token operator\">=</span> newPicture\n  <span class=\"token punctuation\">&#125;</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>newCity<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n    updateData<span class=\"token punctuation\">.</span>city <span class=\"token operator\">=</span> newCity\n  <span class=\"token punctuation\">&#125;</span>\n  <span class=\"token comment\">// 拼接查询条件</span>\n  <span class=\"token keyword\">const</span> whereData <span class=\"token operator\">=</span> <span class=\"token punctuation\">&#123;</span> userName <span class=\"token punctuation\">&#125;</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>password<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n    whereData<span class=\"token punctuation\">.</span>password <span class=\"token operator\">=</span> password\n  <span class=\"token punctuation\">&#125;</span>\n  <span class=\"token comment\">// 执行修改</span>\n  <span class=\"token keyword\">const</span> result <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> User<span class=\"token punctuation\">.</span><span class=\"token function\">update</span><span class=\"token punctuation\">(</span>updateData<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">&#123;</span>\n    where<span class=\"token operator\">:</span> whereData\n  <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span>\n  <span class=\"token keyword\">return</span> result<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">></span> <span class=\"token number\">0</span>\n<span class=\"token punctuation\">&#125;</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n</li>\n</ol>\n","categories":[{"name":"慕课网","path":"api/categories/慕课网.json"},{"name":"Koa2","path":"api/categories/Koa2.json"}],"tags":[{"name":"koa2","path":"api/tags/koa2.json"}]}