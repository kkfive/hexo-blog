{"title":"四、从零模拟新浪微博-用户管理","slug":"日常学习/技术相关/Koa2/慕课网-微博/4. 从零模拟新浪微博-用户管理","date":"2020-12-17T02:24:00.000Z","updated":"2022-02-21T06:11:10.020Z","comments":true,"path":"api/articles/日常学习/技术相关/Koa2/慕课网-微博/4. 从零模拟新浪微博-用户管理.json","excerpt":null,"covers":["https://rmt.ladydaily.com/fetch/tzk/storage/20201217142759.png?w=1280&amp;fmt=jpg"],"content":"<p>代码仓库：<a href=\"https://github.com/changeclass/koa2-weibo\">https://github.com/changeclass/koa2-weibo</a></p>\n<h2 id=\"数据同步\"><a class=\"markdownIt-Anchor\" href=\"#数据同步\"></a> 数据同步</h2>\n<p>user表数据模型</p>\n<pre class=\"line-numbers language-javascript\" data-language=\"javascript\"><code class=\"language-javascript\"><span class=\"token comment\">/**\n * @description 用户数据模型\n * @author 小康\n */</span>\n\n<span class=\"token keyword\">const</span> seq <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'../seq'</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">const</span> <span class=\"token punctuation\">&#123;</span> <span class=\"token constant\">STRING</span><span class=\"token punctuation\">,</span> <span class=\"token constant\">DECIMAL</span> <span class=\"token punctuation\">&#125;</span> <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'../type'</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">const</span> User <span class=\"token operator\">=</span> seq<span class=\"token punctuation\">.</span><span class=\"token function\">define</span><span class=\"token punctuation\">(</span><span class=\"token string\">'user'</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">&#123;</span>\n    userName<span class=\"token operator\">:</span> <span class=\"token punctuation\">&#123;</span>\n        type<span class=\"token operator\">:</span> <span class=\"token constant\">STRING</span><span class=\"token punctuation\">,</span>\n        allowNull<span class=\"token operator\">:</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">,</span>\n        unique<span class=\"token operator\">:</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">,</span>\n        comment<span class=\"token operator\">:</span> <span class=\"token string\">'唯一'</span>\n    <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span>\n    password<span class=\"token operator\">:</span> <span class=\"token punctuation\">&#123;</span>\n        type<span class=\"token operator\">:</span> <span class=\"token constant\">STRING</span><span class=\"token punctuation\">,</span>\n        allowNull<span class=\"token operator\">:</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">,</span>\n        comment<span class=\"token operator\">:</span> <span class=\"token string\">'密码'</span>\n    <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span>\n    nickName<span class=\"token operator\">:</span> <span class=\"token punctuation\">&#123;</span>\n        type<span class=\"token operator\">:</span> <span class=\"token constant\">STRING</span><span class=\"token punctuation\">,</span>\n        allowNull<span class=\"token operator\">:</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">,</span>\n        comment<span class=\"token operator\">:</span> <span class=\"token string\">'昵称'</span>\n    <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span>\n    gender<span class=\"token operator\">:</span> <span class=\"token punctuation\">&#123;</span>\n        type<span class=\"token operator\">:</span> <span class=\"token constant\">DECIMAL</span><span class=\"token punctuation\">,</span>\n        allowNull<span class=\"token operator\">:</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">,</span>\n        defaultValue<span class=\"token operator\">:</span> <span class=\"token number\">3</span><span class=\"token punctuation\">,</span>\n        comment<span class=\"token operator\">:</span> <span class=\"token string\">'性别 (1男性2女性3保密)'</span>\n    <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span>\n    picture<span class=\"token operator\">:</span> <span class=\"token punctuation\">&#123;</span>\n        type<span class=\"token operator\">:</span> <span class=\"token constant\">STRING</span><span class=\"token punctuation\">,</span>\n        comment<span class=\"token operator\">:</span> <span class=\"token string\">'图片地址'</span>\n    <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span>\n    city<span class=\"token operator\">:</span> <span class=\"token punctuation\">&#123;</span>\n        type<span class=\"token operator\">:</span> <span class=\"token constant\">STRING</span><span class=\"token punctuation\">,</span>\n        comment<span class=\"token operator\">:</span> <span class=\"token string\">'城市'</span>\n    <span class=\"token punctuation\">&#125;</span>\n<span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span>\nmodule<span class=\"token punctuation\">.</span>exports <span class=\"token operator\">=</span> User\n<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n<h2 id=\"分层\"><a class=\"markdownIt-Anchor\" href=\"#分层\"></a> 分层</h2>\n<p><img src=\"https://rmt.ladydaily.com/fetch/tzk/storage/20201217142759.png?w=1280&amp;fmt=jpg\" alt=\"image-20201217142759378\" /></p>\n<h2 id=\"业务分层\"><a class=\"markdownIt-Anchor\" href=\"#业务分层\"></a> 业务分层</h2>\n<pre class=\"line-numbers language-src\" data-language=\"src\"><code class=\"language-src\">src                        \n├─ cache                   \n│  └─ _redis.js            \n├─ config                  \n│  ├─ constant.js  常量        \n│  └─ db.js 数据库配置               \n├─ controller 控制器             \n│  └─ user.js 用户控制器            \n├─ db  数据库                    \n│  ├─ model  数据库模型              \n│  │  ├─ index.js          \n│  │  └─ User.js           \n│  ├─ seq.js  数据库链接              \n│  ├─ sync.js 数据库同步             \n│  └─ type.js 数据类型             \n├─ model    业务模型               \n│  ├─ ErrorInfo.js  错误信息       \n│  └─ ResModel.js   规范返回格式       \n├─ public                  \n│  ├─ css                  \n│  │  ├─ jquery.atwho.css  \n│  │  ├─ list.css          \n│  │  ├─ main.css          \n│  │  └─ right.css         \n│  ├─ images               \n│  ├─ javascripts          \n│  │  ├─ jquery.atwho.js   \n│  │  ├─ jquery.caret.js   \n│  │  ├─ my-ajax.js        \n│  │  └─ query-object.js   \n│  └─ stylesheets          \n│     └─ style.css         \n├─ routes 路由                 \n│  ├─ api  API路由                \n│  │  └─ user.js          \n│  ├─ view 视图路由               \n│  │  ├─ error.js          \n│  │  └─ users.js          \n│  └─ index.js             \n├─ services  数据库服务层              \n│  ├─ user.js              \n│  └─ _format.js           \n├─ utils 工具库                  \n│  └─ env.js               \n├─ views 视图层                  \n│  ├─ layout               \n│  │  ├─ footer.ejs        \n│  │  └─ header.ejs        \n│  ├─ widgets              \n│  │  ├─ blog-list.ejs     \n│  │  ├─ fans.ejs          \n│  │  ├─ followers.ejs     \n│  │  ├─ input.ejs         \n│  │  ├─ load-more.ejs     \n│  │  └─ user-info.ejs     \n│  ├─ 404.ejs              \n│  ├─ atMe.ejs             \n│  ├─ error.ejs            \n│  ├─ index.ejs            \n│  ├─ login.ejs            \n│  ├─ profile.ejs          \n│  ├─ register.ejs         \n│  ├─ setting.ejs          \n│  └─ square.ejs           \n└─ app.js 入口文件                 <span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n<p>将各个功能模块进行分层可以是代码逻辑更加清晰。定义业务模型层，例如错误信息（统一返回格式）。定义<code>server</code>层用于与数据库进行交互。</p>\n<ul>\n<li>\n<p>业务模型层（统一返回格式）</p>\n<pre class=\"line-numbers language-javascript\" data-language=\"javascript\"><code class=\"language-javascript\"><span class=\"token comment\">/**\n * @description: res的数据模型\n * @author: 小康\n * @url: https://xiaokang.me\n * @Date: 2020-12-17 14:44:52\n * @LastEditTime: 2020-12-17 14:44:52\n * @LastEditors: 小康\n */</span>\n\n<span class=\"token comment\">/**\n * @author: 小康\n * @url: https://xiaokang.me\n * @description: 基础模块\n */</span>\n<span class=\"token keyword\">class</span> <span class=\"token class-name\">BaseModel</span> <span class=\"token punctuation\">&#123;</span>\n  <span class=\"token function\">constructor</span><span class=\"token punctuation\">(</span><span class=\"token parameter\"><span class=\"token punctuation\">&#123;</span> errno<span class=\"token punctuation\">,</span> data<span class=\"token punctuation\">,</span> message <span class=\"token punctuation\">&#125;</span></span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>errno <span class=\"token operator\">=</span> errno\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>data<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n      <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>data <span class=\"token operator\">=</span> data\n    <span class=\"token punctuation\">&#125;</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>message<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n      <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>message <span class=\"token operator\">=</span> message\n    <span class=\"token punctuation\">&#125;</span>\n  <span class=\"token punctuation\">&#125;</span>\n<span class=\"token punctuation\">&#125;</span>\n\n<span class=\"token comment\">/**\n * @author: 小康\n * @url: https://xiaokang.me\n * @description: 成功的模型\n */</span>\n<span class=\"token keyword\">class</span> <span class=\"token class-name\">SuccessModel</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">BaseModel</span> <span class=\"token punctuation\">&#123;</span>\n  <span class=\"token function\">constructor</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">data <span class=\"token operator\">=</span> <span class=\"token punctuation\">&#123;</span><span class=\"token punctuation\">&#125;</span></span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n    <span class=\"token keyword\">super</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">&#123;</span>\n      errno<span class=\"token operator\">:</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span>\n      data\n    <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">&#125;</span>\n<span class=\"token punctuation\">&#125;</span>\n\n<span class=\"token comment\">/**\n * @author: 小康\n * @url: https://xiaokang.me\n * @description: 失败的模型\n */</span>\n<span class=\"token keyword\">class</span> <span class=\"token class-name\">ErrorModel</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">BaseModel</span> <span class=\"token punctuation\">&#123;</span>\n  <span class=\"token function\">constructor</span><span class=\"token punctuation\">(</span><span class=\"token parameter\"><span class=\"token punctuation\">&#123;</span> errno<span class=\"token punctuation\">,</span> message <span class=\"token punctuation\">&#125;</span></span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n    <span class=\"token keyword\">super</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">&#123;</span>\n      errno<span class=\"token punctuation\">,</span>\n      message\n    <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">&#125;</span>\n<span class=\"token punctuation\">&#125;</span>\n\nmodule<span class=\"token punctuation\">.</span>exports <span class=\"token operator\">=</span> <span class=\"token punctuation\">&#123;</span>\n  SuccessModel<span class=\"token punctuation\">,</span>\n  ErrorModel\n<span class=\"token punctuation\">&#125;</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n</li>\n<li>\n<p>业务模型层（失败信息集合）</p>\n<pre class=\"line-numbers language-javascript\" data-language=\"javascript\"><code class=\"language-javascript\"><span class=\"token comment\">/**\n * @description: 失败信息集合\n * @author: 小康\n * @url: https://xiaokang.me\n * @Date: 2020-12-17 14:54:07\n * @LastEditTime: 2020-12-17 14:54:08\n * @LastEditors: 小康\n */</span>\n\nmodule<span class=\"token punctuation\">.</span>exports <span class=\"token operator\">=</span> <span class=\"token punctuation\">&#123;</span>\n  <span class=\"token comment\">// 用户名已存在</span>\n  registerUserNameExistInfo<span class=\"token operator\">:</span> <span class=\"token punctuation\">&#123;</span>\n    errno<span class=\"token operator\">:</span> <span class=\"token number\">10001</span><span class=\"token punctuation\">,</span>\n    message<span class=\"token operator\">:</span> <span class=\"token string\">'用户名已存在'</span>\n  <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span>\n  <span class=\"token comment\">// 注册失败</span>\n  registerFailInfo<span class=\"token operator\">:</span> <span class=\"token punctuation\">&#123;</span>\n    errno<span class=\"token operator\">:</span> <span class=\"token number\">10002</span><span class=\"token punctuation\">,</span>\n    message<span class=\"token operator\">:</span> <span class=\"token string\">'注册失败，请重试'</span>\n  <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span>\n  <span class=\"token comment\">// 用户名不存在</span>\n  registerUserNameNotExistInfo<span class=\"token operator\">:</span> <span class=\"token punctuation\">&#123;</span>\n    errno<span class=\"token operator\">:</span> <span class=\"token number\">10003</span><span class=\"token punctuation\">,</span>\n    message<span class=\"token operator\">:</span> <span class=\"token string\">'用户名未存在'</span>\n  <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span>\n  <span class=\"token comment\">// 登录失败</span>\n  loginFailInfo<span class=\"token operator\">:</span> <span class=\"token punctuation\">&#123;</span>\n    errno<span class=\"token operator\">:</span> <span class=\"token number\">10004</span><span class=\"token punctuation\">,</span>\n    message<span class=\"token operator\">:</span> <span class=\"token string\">'登录失败，用户名或密码错误'</span>\n  <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span>\n  <span class=\"token comment\">// 未登录</span>\n  loginCheckFailInfo<span class=\"token operator\">:</span> <span class=\"token punctuation\">&#123;</span>\n    errno<span class=\"token operator\">:</span> <span class=\"token number\">10005</span><span class=\"token punctuation\">,</span>\n    message<span class=\"token operator\">:</span> <span class=\"token string\">'您尚未登录'</span>\n  <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span>\n  <span class=\"token comment\">// 修改密码失败</span>\n  changePasswordFailInfo<span class=\"token operator\">:</span> <span class=\"token punctuation\">&#123;</span>\n    errno<span class=\"token operator\">:</span> <span class=\"token number\">10006</span><span class=\"token punctuation\">,</span>\n    message<span class=\"token operator\">:</span> <span class=\"token string\">'修改密码失败，请重试'</span>\n  <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span>\n  <span class=\"token comment\">// 上传文件过大</span>\n  uploadFileSizeFailInfo<span class=\"token operator\">:</span> <span class=\"token punctuation\">&#123;</span>\n    errno<span class=\"token operator\">:</span> <span class=\"token number\">10007</span><span class=\"token punctuation\">,</span>\n    message<span class=\"token operator\">:</span> <span class=\"token string\">'上传文件尺寸过大'</span>\n  <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span>\n  <span class=\"token comment\">// 修改基本信息失败</span>\n  changeInfoFailInfo<span class=\"token operator\">:</span> <span class=\"token punctuation\">&#123;</span>\n    errno<span class=\"token operator\">:</span> <span class=\"token number\">10008</span><span class=\"token punctuation\">,</span>\n    message<span class=\"token operator\">:</span> <span class=\"token string\">'修改基本信息失败'</span>\n  <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span>\n  <span class=\"token comment\">// json schema 校验失败</span>\n  jsonSchemaFileInfo<span class=\"token operator\">:</span> <span class=\"token punctuation\">&#123;</span>\n    errno<span class=\"token operator\">:</span> <span class=\"token number\">10009</span><span class=\"token punctuation\">,</span>\n    message<span class=\"token operator\">:</span> <span class=\"token string\">'数据格式校验错误'</span>\n  <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span>\n  <span class=\"token comment\">// 删除用户失败</span>\n  deleteUserFailInfo<span class=\"token operator\">:</span> <span class=\"token punctuation\">&#123;</span>\n    errno<span class=\"token operator\">:</span> <span class=\"token number\">10010</span><span class=\"token punctuation\">,</span>\n    message<span class=\"token operator\">:</span> <span class=\"token string\">'删除用户失败'</span>\n  <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span>\n  <span class=\"token comment\">// 添加关注失败</span>\n  addFollowerFailInfo<span class=\"token operator\">:</span> <span class=\"token punctuation\">&#123;</span>\n    errno<span class=\"token operator\">:</span> <span class=\"token number\">10011</span><span class=\"token punctuation\">,</span>\n    message<span class=\"token operator\">:</span> <span class=\"token string\">'添加关注失败'</span>\n  <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span>\n  <span class=\"token comment\">// 取消关注失败</span>\n  deleteFollowerFailInfo<span class=\"token operator\">:</span> <span class=\"token punctuation\">&#123;</span>\n    errno<span class=\"token operator\">:</span> <span class=\"token number\">10012</span><span class=\"token punctuation\">,</span>\n    message<span class=\"token operator\">:</span> <span class=\"token string\">'取消关注失败'</span>\n  <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span>\n  <span class=\"token comment\">// 创建微博失败</span>\n  createBlogFailInfo<span class=\"token operator\">:</span> <span class=\"token punctuation\">&#123;</span>\n    errno<span class=\"token operator\">:</span> <span class=\"token number\">11001</span><span class=\"token punctuation\">,</span>\n    message<span class=\"token operator\">:</span> <span class=\"token string\">'创建微博失败，请重试'</span>\n  <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span>\n  <span class=\"token comment\">// 删除微博失败</span>\n  deleteBlogFailInfo<span class=\"token operator\">:</span> <span class=\"token punctuation\">&#123;</span>\n    errno<span class=\"token operator\">:</span> <span class=\"token number\">11002</span><span class=\"token punctuation\">,</span>\n    message<span class=\"token operator\">:</span> <span class=\"token string\">'删除微博失败，请重试'</span>\n  <span class=\"token punctuation\">&#125;</span>\n<span class=\"token punctuation\">&#125;</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n</li>\n</ul>\n<h2 id=\"检查用户是否存在\"><a class=\"markdownIt-Anchor\" href=\"#检查用户是否存在\"></a> 检查用户是否存在</h2>\n<ol>\n<li>\n<p>API路由层</p>\n<pre class=\"line-numbers language-javascript\" data-language=\"javascript\"><code class=\"language-javascript\"><span class=\"token comment\">// 用户名是否存在</span>\nrouter<span class=\"token punctuation\">.</span><span class=\"token function\">post</span><span class=\"token punctuation\">(</span><span class=\"token string\">'/isExist'</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">async</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">ctx<span class=\"token punctuation\">,</span> next</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span>\n  <span class=\"token keyword\">const</span> <span class=\"token punctuation\">&#123;</span> userName <span class=\"token punctuation\">&#125;</span> <span class=\"token operator\">=</span> ctx<span class=\"token punctuation\">.</span>request<span class=\"token punctuation\">.</span>body\n  ctx<span class=\"token punctuation\">.</span>body <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> <span class=\"token function\">isExist</span><span class=\"token punctuation\">(</span>userName<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n</li>\n<li>\n<p><code>controller</code>层</p>\n<pre class=\"line-numbers language-javascript\" data-language=\"javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">const</span> <span class=\"token punctuation\">&#123;</span> getUserInfo<span class=\"token punctuation\">,</span> createUser <span class=\"token punctuation\">&#125;</span> <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'../services/user'</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">const</span> <span class=\"token punctuation\">&#123;</span> SuccessModel<span class=\"token punctuation\">,</span> ErrorModel <span class=\"token punctuation\">&#125;</span> <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'../model/ResModel'</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">const</span> <span class=\"token punctuation\">&#123;</span>\n  registerUserNameNotExistInfo<span class=\"token punctuation\">,</span>\n  registerUserNameExistInfo<span class=\"token punctuation\">,</span>\n  registerFailInfo\n<span class=\"token punctuation\">&#125;</span> <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'../model/ErrorInfo'</span><span class=\"token punctuation\">)</span>\n<span class=\"token comment\">/**\n * @author: 小康\n * @url: https://xiaokang.me\n * @param &#123;String&#125; userName 需要检查的用户名\n * @description: 检查用户名是否存在\n */</span>\n<span class=\"token keyword\">async</span> <span class=\"token keyword\">function</span> <span class=\"token function\">isExist</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">userName</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n    <span class=\"token keyword\">const</span> userInfo <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> <span class=\"token function\">getUserInfo</span><span class=\"token punctuation\">(</span>userName<span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>userInfo<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n        <span class=\"token comment\">// 已经存在</span>\n        <span class=\"token keyword\">return</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">SuccessModel</span><span class=\"token punctuation\">(</span>userInfo<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">&#123;</span>\n        <span class=\"token comment\">// 不存在</span>\n        <span class=\"token keyword\">return</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">ErrorModel</span><span class=\"token punctuation\">(</span>registerUserNameNotExistInfo<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">&#125;</span>\n<span class=\"token punctuation\">&#125;</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n</li>\n<li>\n<p><code>servers</code>层</p>\n<pre class=\"line-numbers language-javascript\" data-language=\"javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">const</span> <span class=\"token punctuation\">&#123;</span> User <span class=\"token punctuation\">&#125;</span> <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'../db/model/index'</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">const</span> <span class=\"token punctuation\">&#123;</span> formatUser <span class=\"token punctuation\">&#125;</span> <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'./_format'</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token comment\">/**\n * @author: 小康\n * @url: https://xiaokang.me\n * @param &#123;*&#125; userName 用户名\n * @param &#123;*&#125; password 密码\n * @description: 获取用户的信息\n */</span>\n<span class=\"token keyword\">async</span> <span class=\"token keyword\">function</span> <span class=\"token function\">getUserInfo</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">userName<span class=\"token punctuation\">,</span> password</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n    <span class=\"token keyword\">const</span> whereOpt <span class=\"token operator\">=</span> <span class=\"token punctuation\">&#123;</span>\n        userName\n    <span class=\"token punctuation\">&#125;</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>password<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n        Object<span class=\"token punctuation\">.</span><span class=\"token function\">assign</span><span class=\"token punctuation\">(</span>whereOpt<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">&#123;</span> password <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">&#125;</span>\n    <span class=\"token comment\">// 查询</span>\n    <span class=\"token keyword\">const</span> result <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> User<span class=\"token punctuation\">.</span><span class=\"token function\">findOne</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">&#123;</span>\n        <span class=\"token comment\">// 查询的列</span>\n        attributes<span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token string\">'id'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'userName'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'nickName'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'picture'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'city'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n        <span class=\"token comment\">// 查询条件</span>\n        where<span class=\"token operator\">:</span> whereOpt\n    <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>result <span class=\"token operator\">==</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n        <span class=\"token comment\">// 未找到</span>\n        <span class=\"token keyword\">return</span> result\n    <span class=\"token punctuation\">&#125;</span>\n    <span class=\"token comment\">// 格式化</span>\n    <span class=\"token keyword\">const</span> formatRes <span class=\"token operator\">=</span> <span class=\"token function\">formatUser</span><span class=\"token punctuation\">(</span>result<span class=\"token punctuation\">.</span>dataValues<span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">return</span> formatRes\n<span class=\"token punctuation\">&#125;</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n<p><code>formatUser</code>方法</p>\n<pre class=\"line-numbers language-javascript\" data-language=\"javascript\"><code class=\"language-javascript\"><span class=\"token comment\">/**\n * 格式化头像\n * @author 小康\n * @date 2020-12-17\n * @param &#123;Object&#125; obj 用户对象\n * @returns &#123;Object&#125; 处理后的结果\n */</span>\n<span class=\"token keyword\">function</span> <span class=\"token function\">_formatUserPicture</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">obj</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>obj<span class=\"token punctuation\">.</span>picture <span class=\"token operator\">==</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n        obj<span class=\"token punctuation\">.</span>picture <span class=\"token operator\">=</span> <span class=\"token constant\">DEFAULT_PICTURE</span>\n    <span class=\"token punctuation\">&#125;</span>\n    <span class=\"token keyword\">return</span> obj\n<span class=\"token punctuation\">&#125;</span>\n\n<span class=\"token comment\">/**\n * 格式化用户\n * @author 小康\n * @date 2020-12-17\n * @param &#123;Array|Object&#125; list 用户列表或单个用户对象\n * @returns &#123;any&#125;\n */</span>\n<span class=\"token keyword\">function</span> <span class=\"token function\">formatUser</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">list</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>list <span class=\"token operator\">==</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n        <span class=\"token keyword\">return</span> list\n    <span class=\"token punctuation\">&#125;</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>list <span class=\"token keyword\">instanceof</span> <span class=\"token class-name\">Array</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n        <span class=\"token comment\">// 数组 用户列表</span>\n        <span class=\"token keyword\">return</span> list<span class=\"token punctuation\">.</span><span class=\"token function\">map</span><span class=\"token punctuation\">(</span>_formatUserPicture<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">&#125;</span>\n    <span class=\"token comment\">// 单个对象</span>\n    <span class=\"token keyword\">let</span> result <span class=\"token operator\">=</span> list\n    result <span class=\"token operator\">=</span> <span class=\"token function\">_formatUserPicture</span><span class=\"token punctuation\">(</span>result<span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">return</span> result\n<span class=\"token punctuation\">&#125;</span>\n<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n</li>\n</ol>\n<h2 id=\"用户注册\"><a class=\"markdownIt-Anchor\" href=\"#用户注册\"></a> 用户注册</h2>\n<p>具体逻辑与检查用户是否存在相似。</p>\n<h2 id=\"密码加密\"><a class=\"markdownIt-Anchor\" href=\"#密码加密\"></a> 密码加密</h2>\n<p>密码加密只需要在存储数据时对数据进行加密处理即可。</p>\n<p><code>user</code>的<code>controller</code>层</p>\n<pre class=\"line-numbers language-javascript\" data-language=\"javascript\"><code class=\"language-javascript\"><span class=\"token comment\">// ...</span>\n<span class=\"token comment\">// 注册功能</span>\n<span class=\"token keyword\">try</span> <span class=\"token punctuation\">&#123;</span>\n    <span class=\"token function\">createUser</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">&#123;</span>\n        userName<span class=\"token punctuation\">,</span>\n        password<span class=\"token operator\">:</span> <span class=\"token function\">doCrypto</span><span class=\"token punctuation\">(</span>password<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n        gender\n    <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">return</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">SuccessModel</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span>e<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n    console<span class=\"token punctuation\">.</span><span class=\"token function\">error</span><span class=\"token punctuation\">(</span>e<span class=\"token punctuation\">.</span>message<span class=\"token punctuation\">,</span> e<span class=\"token punctuation\">.</span>stack<span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">return</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">ErrorModel</span><span class=\"token punctuation\">(</span>registerFailInfo<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">&#125;</span>\n<span class=\"token comment\">// ...</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n<p><code>doCrypto</code>函数</p>\n<pre class=\"line-numbers language-javascript\" data-language=\"javascript\"><code class=\"language-javascript\"><span class=\"token comment\">/**\n * @description: 加密方法\n * @author: 小康\n * @url: https://xiaokang.me\n * @Date: 2020-12-17 15:43:56\n * @LastEditTime: 2020-12-17 15:43:56\n * @LastEditors: 小康\n */</span>\n\n<span class=\"token keyword\">const</span> crypto <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'crypto'</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">const</span> <span class=\"token punctuation\">&#123;</span> <span class=\"token constant\">CRYPTO_SECRET_KEY</span> <span class=\"token punctuation\">&#125;</span> <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'../config/secretKeys'</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token comment\">/**\n * @author: 小康\n * @url: https://xiaokang.me\n * @param &#123;String&#125; content 要加密的明文\n * @description: MD5加密\n */</span>\n<span class=\"token keyword\">function</span> <span class=\"token function\">_md5</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">content</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n  <span class=\"token keyword\">const</span> md5 <span class=\"token operator\">=</span> crypto<span class=\"token punctuation\">.</span><span class=\"token function\">createHash</span><span class=\"token punctuation\">(</span><span class=\"token string\">'md5'</span><span class=\"token punctuation\">)</span>\n  <span class=\"token keyword\">return</span> md5<span class=\"token punctuation\">.</span><span class=\"token function\">update</span><span class=\"token punctuation\">(</span>content<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">digest</span><span class=\"token punctuation\">(</span><span class=\"token string\">'hex'</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">&#125;</span>\n\n<span class=\"token comment\">/**\n * @author: 小康\n * @url: https://xiaokang.me\n * @param &#123;*&#125; content 明文\n * @description: 加密方法\n */</span>\n<span class=\"token keyword\">function</span> <span class=\"token function\">doCrypto</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">content</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n  <span class=\"token keyword\">const</span> str <span class=\"token operator\">=</span> <span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">password=</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">$&#123;</span>content<span class=\"token interpolation-punctuation punctuation\">&#125;</span></span><span class=\"token string\">&amp;key=</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">$&#123;</span><span class=\"token constant\">CRYPTO_SECRET_KEY</span><span class=\"token interpolation-punctuation punctuation\">&#125;</span></span><span class=\"token template-punctuation string\">`</span></span>\n  <span class=\"token keyword\">return</span> <span class=\"token function\">_md5</span><span class=\"token punctuation\">(</span>str<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">&#125;</span>\n\nmodule<span class=\"token punctuation\">.</span>exports <span class=\"token operator\">=</span> <span class=\"token punctuation\">&#123;</span>\n  doCrypto\n<span class=\"token punctuation\">&#125;</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n<h2 id=\"用户信息格式验证\"><a class=\"markdownIt-Anchor\" href=\"#用户信息格式验证\"></a> 用户信息格式验证</h2>\n<p>在注册逻辑执行前加入中间件函数。</p>\n<pre class=\"line-numbers language-javascript\" data-language=\"javascript\"><code class=\"language-javascript\"><span class=\"token comment\">// 注册路由</span>\nrouter<span class=\"token punctuation\">.</span><span class=\"token function\">post</span><span class=\"token punctuation\">(</span><span class=\"token string\">'/register'</span><span class=\"token punctuation\">,</span> <span class=\"token function\">genValidator</span><span class=\"token punctuation\">(</span>userValidate<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">async</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">ctx<span class=\"token punctuation\">,</span> next</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span>\n  <span class=\"token keyword\">const</span> <span class=\"token punctuation\">&#123;</span> userName<span class=\"token punctuation\">,</span> password<span class=\"token punctuation\">,</span> gender <span class=\"token punctuation\">&#125;</span> <span class=\"token operator\">=</span> ctx<span class=\"token punctuation\">.</span>request<span class=\"token punctuation\">.</span>body\n  ctx<span class=\"token punctuation\">.</span>body <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> <span class=\"token function\">register</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">&#123;</span> userName<span class=\"token punctuation\">,</span> password<span class=\"token punctuation\">,</span> gender <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n<ul>\n<li>\n<p><code>genValidator</code>用于生成中间件函数</p>\n<pre class=\"line-numbers language-javascript\" data-language=\"javascript\"><code class=\"language-javascript\"><span class=\"token comment\">/**\n * @description: json schema验证中间件\n * @author: 小康\n * @url: https://xiaokang.me\n * @Date: 2020-12-17 16:34:54\n * @LastEditTime: 2020-12-17 16:34:54\n * @LastEditors: 小康\n */</span>\n\n<span class=\"token keyword\">const</span> <span class=\"token punctuation\">&#123;</span> jsonSchemaFileInfo <span class=\"token punctuation\">&#125;</span> <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'../model/ErrorInfo'</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">const</span> <span class=\"token punctuation\">&#123;</span> ErrorModel <span class=\"token punctuation\">&#125;</span> <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'../model/ResModel'</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token comment\">/**\n * @author: 小康\n * @url: https://xiaokang.me\n * @param &#123;function&#125; validateFn 验证函数\n * @description: 生成json schema 验证中间件\n */</span>\n<span class=\"token keyword\">function</span> <span class=\"token function\">genValidator</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">validateFn</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n  <span class=\"token keyword\">async</span> <span class=\"token keyword\">function</span> <span class=\"token function\">validator</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">ctx<span class=\"token punctuation\">,</span> next</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n    <span class=\"token keyword\">const</span> data <span class=\"token operator\">=</span> ctx<span class=\"token punctuation\">.</span>request<span class=\"token punctuation\">.</span>body\n    <span class=\"token keyword\">const</span> error <span class=\"token operator\">=</span> <span class=\"token function\">validateFn</span><span class=\"token punctuation\">(</span>data<span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>error<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n      <span class=\"token comment\">// 验证失败</span>\n      <span class=\"token keyword\">return</span> <span class=\"token punctuation\">(</span>ctx<span class=\"token punctuation\">.</span>body <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">ErrorModel</span><span class=\"token punctuation\">(</span>jsonSchemaFileInfo<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">&#125;</span>\n    <span class=\"token comment\">// 验证成功</span>\n    <span class=\"token keyword\">await</span> <span class=\"token function\">next</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">&#125;</span>\n  <span class=\"token keyword\">return</span> validator\n<span class=\"token punctuation\">&#125;</span>\n\nmodule<span class=\"token punctuation\">.</span>exports <span class=\"token operator\">=</span> <span class=\"token punctuation\">&#123;</span> genValidator <span class=\"token punctuation\">&#125;</span>\n<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n<p>传入验证函数</p>\n</li>\n<li>\n<p><code>userValidate</code>验证函数</p>\n<pre class=\"line-numbers language-javascript\" data-language=\"javascript\"><code class=\"language-javascript\"><span class=\"token comment\">/**\n * @description: user 数据格式校验\n * @author: 小康\n * @url: https://xiaokang.me\n * @Date: 2020-12-17 16:17:42\n * @LastEditTime: 2020-12-17 16:17:43\n * @LastEditors: 小康\n */</span>\n<span class=\"token keyword\">const</span> validate <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'./_validate'</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token comment\">// 校验规则</span>\n<span class=\"token keyword\">const</span> <span class=\"token constant\">SCHEMA</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">&#123;</span>\n  type<span class=\"token operator\">:</span> <span class=\"token string\">'object'</span><span class=\"token punctuation\">,</span>\n  properties<span class=\"token operator\">:</span> <span class=\"token punctuation\">&#123;</span>\n    userName<span class=\"token operator\">:</span> <span class=\"token punctuation\">&#123;</span>\n      type<span class=\"token operator\">:</span> <span class=\"token string\">'string'</span><span class=\"token punctuation\">,</span>\n      pattern<span class=\"token operator\">:</span> <span class=\"token string\">'^[a-zA-Z][a-zA-Z0-9_]+$'</span><span class=\"token punctuation\">,</span> <span class=\"token comment\">// 字母开头，字母数字下划线</span>\n      maxLength<span class=\"token operator\">:</span> <span class=\"token number\">255</span><span class=\"token punctuation\">,</span>\n      minLength<span class=\"token operator\">:</span> <span class=\"token number\">2</span>\n    <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span>\n    password<span class=\"token operator\">:</span> <span class=\"token punctuation\">&#123;</span>\n      type<span class=\"token operator\">:</span> <span class=\"token string\">'string'</span><span class=\"token punctuation\">,</span>\n      maxLength<span class=\"token operator\">:</span> <span class=\"token number\">255</span><span class=\"token punctuation\">,</span>\n      minLength<span class=\"token operator\">:</span> <span class=\"token number\">3</span>\n    <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span>\n    newPassword<span class=\"token operator\">:</span> <span class=\"token punctuation\">&#123;</span>\n      type<span class=\"token operator\">:</span> <span class=\"token string\">'string'</span><span class=\"token punctuation\">,</span>\n      maxLength<span class=\"token operator\">:</span> <span class=\"token number\">255</span><span class=\"token punctuation\">,</span>\n      minLength<span class=\"token operator\">:</span> <span class=\"token number\">3</span>\n    <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span>\n    nickName<span class=\"token operator\">:</span> <span class=\"token punctuation\">&#123;</span>\n      type<span class=\"token operator\">:</span> <span class=\"token string\">'string'</span><span class=\"token punctuation\">,</span>\n      maxLength<span class=\"token operator\">:</span> <span class=\"token number\">255</span>\n    <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span>\n    picture<span class=\"token operator\">:</span> <span class=\"token punctuation\">&#123;</span>\n      type<span class=\"token operator\">:</span> <span class=\"token string\">'string'</span><span class=\"token punctuation\">,</span>\n      maxLength<span class=\"token operator\">:</span> <span class=\"token number\">255</span>\n    <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span>\n    city<span class=\"token operator\">:</span> <span class=\"token punctuation\">&#123;</span>\n      type<span class=\"token operator\">:</span> <span class=\"token string\">'string'</span><span class=\"token punctuation\">,</span>\n      maxLength<span class=\"token operator\">:</span> <span class=\"token number\">255</span><span class=\"token punctuation\">,</span>\n      minLength<span class=\"token operator\">:</span> <span class=\"token number\">2</span>\n    <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span>\n    gender<span class=\"token operator\">:</span> <span class=\"token punctuation\">&#123;</span>\n      type<span class=\"token operator\">:</span> <span class=\"token string\">'number'</span><span class=\"token punctuation\">,</span>\n      minimum<span class=\"token operator\">:</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span>\n      maximum<span class=\"token operator\">:</span> <span class=\"token number\">3</span>\n    <span class=\"token punctuation\">&#125;</span>\n  <span class=\"token punctuation\">&#125;</span>\n<span class=\"token punctuation\">&#125;</span>\n\n<span class=\"token comment\">/**\n * 校验用户数据格式\n * @param &#123;Object&#125; data 用户数据\n */</span>\n<span class=\"token keyword\">function</span> <span class=\"token function\">userValidate</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">data <span class=\"token operator\">=</span> <span class=\"token punctuation\">&#123;</span><span class=\"token punctuation\">&#125;</span></span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n  <span class=\"token keyword\">return</span> <span class=\"token function\">validate</span><span class=\"token punctuation\">(</span><span class=\"token constant\">SCHEMA</span><span class=\"token punctuation\">,</span> data<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">&#125;</span>\n\nmodule<span class=\"token punctuation\">.</span>exports <span class=\"token operator\">=</span> userValidate<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n</li>\n</ul>\n<h2 id=\"登录验证中间件\"><a class=\"markdownIt-Anchor\" href=\"#登录验证中间件\"></a> 登录验证中间件</h2>\n<pre class=\"line-numbers language-javascript\" data-language=\"javascript\"><code class=\"language-javascript\"><span class=\"token comment\">/**\n * @description: user 的控制器\n * @author: 小康\n * @url: https://xiaokang.me\n * @Date: 2020-12-17 14:19:03\n * @LastEditTime: 2020-12-17 14:19:05\n * @LastEditors: 小康\n */</span>\n\n<span class=\"token keyword\">const</span> <span class=\"token punctuation\">&#123;</span> getUserInfo<span class=\"token punctuation\">,</span> createUser <span class=\"token punctuation\">&#125;</span> <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'../services/user'</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">const</span> <span class=\"token punctuation\">&#123;</span> SuccessModel<span class=\"token punctuation\">,</span> ErrorModel <span class=\"token punctuation\">&#125;</span> <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'../model/ResModel'</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">const</span> <span class=\"token punctuation\">&#123;</span>\n    registerUserNameNotExistInfo<span class=\"token punctuation\">,</span>\n    registerUserNameExistInfo<span class=\"token punctuation\">,</span>\n    registerFailInfo<span class=\"token punctuation\">,</span>\n    loginFailInfo\n<span class=\"token punctuation\">&#125;</span> <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'../model/ErrorInfo'</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">const</span> <span class=\"token punctuation\">&#123;</span> doCrypto <span class=\"token punctuation\">&#125;</span> <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'../utils/cryp'</span><span class=\"token punctuation\">)</span>\n<span class=\"token comment\">/**\n * @author: 小康\n * @url: https://xiaokang.me\n * @param &#123;String&#125; userName 需要检查的用户名\n * @description: 检查用户名是否存在\n */</span>\n<span class=\"token keyword\">async</span> <span class=\"token keyword\">function</span> <span class=\"token function\">isExist</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">userName</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n    <span class=\"token keyword\">const</span> userInfo <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> <span class=\"token function\">getUserInfo</span><span class=\"token punctuation\">(</span>userName<span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>userInfo<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n        <span class=\"token comment\">// 已经存在</span>\n        <span class=\"token keyword\">return</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">SuccessModel</span><span class=\"token punctuation\">(</span>userInfo<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">&#123;</span>\n        <span class=\"token comment\">// 不存在</span>\n        <span class=\"token keyword\">return</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">ErrorModel</span><span class=\"token punctuation\">(</span>registerUserNameNotExistInfo<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">&#125;</span>\n<span class=\"token punctuation\">&#125;</span>\n\n<span class=\"token comment\">/**\n * @author: 小康\n * @url: https://xiaokang.me\n * @param &#123;String&#125; userName 用户名\n * @param &#123;String&#125; password 密码\n * @param &#123;Number&#125; gender 性别 1是男 2是女 3是保密\n * @description: 注册功能\n */</span>\n<span class=\"token keyword\">async</span> <span class=\"token keyword\">function</span> <span class=\"token function\">register</span><span class=\"token punctuation\">(</span><span class=\"token parameter\"><span class=\"token punctuation\">&#123;</span> userName<span class=\"token punctuation\">,</span> password<span class=\"token punctuation\">,</span> gender <span class=\"token punctuation\">&#125;</span></span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n    <span class=\"token keyword\">const</span> userInfo <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> <span class=\"token function\">getUserInfo</span><span class=\"token punctuation\">(</span>userName<span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>userInfo<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n        <span class=\"token comment\">// 用户名已存在</span>\n        <span class=\"token keyword\">return</span> <span class=\"token function\">ErrorModel</span><span class=\"token punctuation\">(</span>registerUserNameExistInfo<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">&#125;</span>\n    <span class=\"token comment\">// 注册功能</span>\n    <span class=\"token keyword\">try</span> <span class=\"token punctuation\">&#123;</span>\n        <span class=\"token function\">createUser</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">&#123;</span>\n            userName<span class=\"token punctuation\">,</span>\n            password<span class=\"token operator\">:</span> <span class=\"token function\">doCrypto</span><span class=\"token punctuation\">(</span>password<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n            gender\n        <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">return</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">SuccessModel</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span>e<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n        console<span class=\"token punctuation\">.</span><span class=\"token function\">error</span><span class=\"token punctuation\">(</span>e<span class=\"token punctuation\">.</span>message<span class=\"token punctuation\">,</span> e<span class=\"token punctuation\">.</span>stack<span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">return</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">ErrorModel</span><span class=\"token punctuation\">(</span>registerFailInfo<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">&#125;</span>\n<span class=\"token punctuation\">&#125;</span>\n\n<span class=\"token comment\">/**\n * @author: 小康\n * @url: https://xiaokang.me\n * @param &#123;*&#125; ctx koa2 ctx\n * @param &#123;*&#125; userName 用户名\n * @param &#123;*&#125; password 密码\n * @description: 登录\n */</span>\n<span class=\"token keyword\">async</span> <span class=\"token keyword\">function</span> <span class=\"token function\">login</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">ctx<span class=\"token punctuation\">,</span> userName<span class=\"token punctuation\">,</span> password</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n    <span class=\"token comment\">// 登录成功之后，将用户信息放到session中</span>\n    <span class=\"token keyword\">const</span> userInfo <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> <span class=\"token function\">getUserInfo</span><span class=\"token punctuation\">(</span>userName<span class=\"token punctuation\">,</span> <span class=\"token function\">doCrypto</span><span class=\"token punctuation\">(</span>password<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>userInfo<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n        <span class=\"token keyword\">return</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">ErrorModel</span><span class=\"token punctuation\">(</span>loginFailInfo<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">&#125;</span>\n    <span class=\"token comment\">// 登录成功</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>ctx<span class=\"token punctuation\">.</span>session<span class=\"token punctuation\">.</span>userInfo <span class=\"token operator\">==</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n        ctx<span class=\"token punctuation\">.</span>session<span class=\"token punctuation\">.</span>userInfo <span class=\"token operator\">=</span> userInfo\n    <span class=\"token punctuation\">&#125;</span>\n    <span class=\"token keyword\">return</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">SuccessModel</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">&#125;</span>\nmodule<span class=\"token punctuation\">.</span>exports <span class=\"token operator\">=</span> <span class=\"token punctuation\">&#123;</span>\n    isExist<span class=\"token punctuation\">,</span>\n    register<span class=\"token punctuation\">,</span>\n    login\n<span class=\"token punctuation\">&#125;</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n<h2 id=\"单元测试\"><a class=\"markdownIt-Anchor\" href=\"#单元测试\"></a> 单元测试</h2>\n<h3 id=\"数据模型\"><a class=\"markdownIt-Anchor\" href=\"#数据模型\"></a> 数据模型</h3>\n<p><code>model.test.js</code></p>\n<pre class=\"line-numbers language-javascript\" data-language=\"javascript\"><code class=\"language-javascript\"><span class=\"token comment\">/**\n * @description: user model test\n * @author: 小康\n * @url: https://xiaokang.me\n * @Date: 2020-12-17 19:41:28\n * @LastEditTime: 2020-12-17 19:41:28\n * @LastEditors: 小康\n */</span>\n\n<span class=\"token keyword\">const</span> <span class=\"token punctuation\">&#123;</span> User <span class=\"token punctuation\">&#125;</span> <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'../../src/db/model/index'</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token function\">test</span><span class=\"token punctuation\">(</span><span class=\"token string\">'User 模型的各个属性，符合预期'</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span>\n  <span class=\"token comment\">// 构建一个内存的User实例，但不会提交数据库</span>\n  <span class=\"token keyword\">const</span> user <span class=\"token operator\">=</span> User<span class=\"token punctuation\">.</span><span class=\"token function\">build</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">&#123;</span>\n    userName<span class=\"token operator\">:</span> <span class=\"token string\">'zhangsan'</span><span class=\"token punctuation\">,</span>\n    password<span class=\"token operator\">:</span> <span class=\"token string\">'p1234'</span><span class=\"token punctuation\">,</span>\n    nickName<span class=\"token operator\">:</span> <span class=\"token string\">'张三'</span><span class=\"token punctuation\">,</span>\n    <span class=\"token comment\">// gender: 1,</span>\n    picture<span class=\"token operator\">:</span> <span class=\"token string\">'/xxx.png'</span><span class=\"token punctuation\">,</span>\n    city<span class=\"token operator\">:</span> <span class=\"token string\">'北京'</span>\n  <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span>\n  <span class=\"token comment\">// 验证各个属性</span>\n  <span class=\"token function\">expect</span><span class=\"token punctuation\">(</span>user<span class=\"token punctuation\">.</span>userName<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">toBe</span><span class=\"token punctuation\">(</span><span class=\"token string\">'zhangsan'</span><span class=\"token punctuation\">)</span>\n  <span class=\"token function\">expect</span><span class=\"token punctuation\">(</span>user<span class=\"token punctuation\">.</span>password<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">toBe</span><span class=\"token punctuation\">(</span><span class=\"token string\">'p1234'</span><span class=\"token punctuation\">)</span>\n  <span class=\"token function\">expect</span><span class=\"token punctuation\">(</span>user<span class=\"token punctuation\">.</span>nickName<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">toBe</span><span class=\"token punctuation\">(</span><span class=\"token string\">'张三'</span><span class=\"token punctuation\">)</span>\n  <span class=\"token function\">expect</span><span class=\"token punctuation\">(</span>user<span class=\"token punctuation\">.</span>gender<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">toBe</span><span class=\"token punctuation\">(</span><span class=\"token number\">3</span><span class=\"token punctuation\">)</span>\n  <span class=\"token function\">expect</span><span class=\"token punctuation\">(</span>user<span class=\"token punctuation\">.</span>picture<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">toBe</span><span class=\"token punctuation\">(</span><span class=\"token string\">'/xxx.png'</span><span class=\"token punctuation\">)</span>\n  <span class=\"token function\">expect</span><span class=\"token punctuation\">(</span>user<span class=\"token punctuation\">.</span>city<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">toBe</span><span class=\"token punctuation\">(</span><span class=\"token string\">'北京'</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n<h3 id=\"登录相关测试\"><a class=\"markdownIt-Anchor\" href=\"#登录相关测试\"></a> 登录相关测试</h3>\n<pre class=\"line-numbers language-javascript\" data-language=\"javascript\"><code class=\"language-javascript\"><span class=\"token comment\">/**\n * @description: user api test\n * @author: 小康\n * @url: https://xiaokang.me\n * @Date: 2020-12-17 19:59:34\n * @LastEditTime: 2020-12-17 19:59:34\n * @LastEditors: 小康\n */</span>\n\n<span class=\"token keyword\">const</span> server <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'../server'</span><span class=\"token punctuation\">)</span>\n<span class=\"token comment\">// 用户信息</span>\n<span class=\"token keyword\">const</span> userName <span class=\"token operator\">=</span> <span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">u_</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">$&#123;</span>Date<span class=\"token punctuation\">.</span><span class=\"token function\">now</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token interpolation-punctuation punctuation\">&#125;</span></span><span class=\"token template-punctuation string\">`</span></span>\n<span class=\"token keyword\">const</span> password <span class=\"token operator\">=</span> <span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">p_</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">$&#123;</span>Date<span class=\"token punctuation\">.</span><span class=\"token function\">now</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token interpolation-punctuation punctuation\">&#125;</span></span><span class=\"token template-punctuation string\">`</span></span>\n<span class=\"token keyword\">const</span> testUser <span class=\"token operator\">=</span> <span class=\"token punctuation\">&#123;</span>\n  userName<span class=\"token punctuation\">,</span>\n  password<span class=\"token punctuation\">,</span>\n  nickName<span class=\"token operator\">:</span> userName<span class=\"token punctuation\">,</span>\n  gender<span class=\"token operator\">:</span> <span class=\"token number\">1</span>\n<span class=\"token punctuation\">&#125;</span>\n\n<span class=\"token comment\">// 存储 cookie</span>\n<span class=\"token keyword\">let</span> <span class=\"token constant\">COOKIE</span> <span class=\"token operator\">=</span> <span class=\"token string\">''</span>\n\n<span class=\"token comment\">// 注册</span>\n<span class=\"token function\">test</span><span class=\"token punctuation\">(</span><span class=\"token string\">'注册一个用户，应该成功'</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">async</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span>\n  <span class=\"token keyword\">const</span> res <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> server<span class=\"token punctuation\">.</span><span class=\"token function\">post</span><span class=\"token punctuation\">(</span><span class=\"token string\">'/api/user/register'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">send</span><span class=\"token punctuation\">(</span>testUser<span class=\"token punctuation\">)</span>\n  <span class=\"token function\">expect</span><span class=\"token punctuation\">(</span>res<span class=\"token punctuation\">.</span>body<span class=\"token punctuation\">.</span>errno<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">toBe</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token comment\">// 重复注册</span>\n<span class=\"token function\">test</span><span class=\"token punctuation\">(</span><span class=\"token string\">'重复注册用户，应该失败'</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">async</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span>\n  <span class=\"token keyword\">const</span> res <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> server<span class=\"token punctuation\">.</span><span class=\"token function\">post</span><span class=\"token punctuation\">(</span><span class=\"token string\">'/api/user/register'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">send</span><span class=\"token punctuation\">(</span>testUser<span class=\"token punctuation\">)</span>\n  <span class=\"token function\">expect</span><span class=\"token punctuation\">(</span>res<span class=\"token punctuation\">.</span>body<span class=\"token punctuation\">.</span>errno<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>not<span class=\"token punctuation\">.</span><span class=\"token function\">toBe</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token comment\">// 查询用户是否存在</span>\n<span class=\"token function\">test</span><span class=\"token punctuation\">(</span><span class=\"token string\">'查询注册的用户名，应该存在'</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">async</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span>\n  <span class=\"token keyword\">const</span> res <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> server<span class=\"token punctuation\">.</span><span class=\"token function\">post</span><span class=\"token punctuation\">(</span><span class=\"token string\">'/api/user/isExist'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">send</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">&#123;</span> userName <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span>\n  <span class=\"token function\">expect</span><span class=\"token punctuation\">(</span>res<span class=\"token punctuation\">.</span>body<span class=\"token punctuation\">.</span>errno<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">toBe</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token comment\">// json schema 检测</span>\n<span class=\"token function\">test</span><span class=\"token punctuation\">(</span><span class=\"token string\">'json schema 检测，非法的格式，注册应该失败'</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">async</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span>\n  <span class=\"token keyword\">const</span> res <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> server<span class=\"token punctuation\">.</span><span class=\"token function\">post</span><span class=\"token punctuation\">(</span><span class=\"token string\">'/api/user/register'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">send</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">&#123;</span>\n    userName<span class=\"token operator\">:</span> <span class=\"token string\">'123'</span><span class=\"token punctuation\">,</span> <span class=\"token comment\">// 用户名不是字母（或下划线）开头</span>\n    password<span class=\"token operator\">:</span> <span class=\"token string\">'a'</span><span class=\"token punctuation\">,</span> <span class=\"token comment\">// 最小长度不是 3</span>\n    <span class=\"token comment\">// nickName: ''</span>\n    gender<span class=\"token operator\">:</span> <span class=\"token string\">'mail'</span> <span class=\"token comment\">// 不是数字</span>\n  <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span>\n  <span class=\"token function\">expect</span><span class=\"token punctuation\">(</span>res<span class=\"token punctuation\">.</span>body<span class=\"token punctuation\">.</span>errno<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>not<span class=\"token punctuation\">.</span><span class=\"token function\">toBe</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token comment\">// 登录</span>\n<span class=\"token function\">test</span><span class=\"token punctuation\">(</span><span class=\"token string\">'登录，应该成功'</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">async</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span>\n  <span class=\"token keyword\">const</span> res <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> server<span class=\"token punctuation\">.</span><span class=\"token function\">post</span><span class=\"token punctuation\">(</span><span class=\"token string\">'/api/user/login'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">send</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">&#123;</span>\n    userName<span class=\"token punctuation\">,</span>\n    password\n  <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span>\n  <span class=\"token function\">expect</span><span class=\"token punctuation\">(</span>res<span class=\"token punctuation\">.</span>body<span class=\"token punctuation\">.</span>errno<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">toBe</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span>\n\n  <span class=\"token comment\">// 获取 cookie</span>\n  <span class=\"token constant\">COOKIE</span> <span class=\"token operator\">=</span> res<span class=\"token punctuation\">.</span>headers<span class=\"token punctuation\">[</span><span class=\"token string\">'set-cookie'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span><span class=\"token function\">join</span><span class=\"token punctuation\">(</span><span class=\"token string\">';'</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token comment\">// 删除</span>\n<span class=\"token function\">test</span><span class=\"token punctuation\">(</span><span class=\"token string\">'删除用户，应该成功'</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">async</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span>\n  <span class=\"token keyword\">const</span> res <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> server<span class=\"token punctuation\">.</span><span class=\"token function\">post</span><span class=\"token punctuation\">(</span><span class=\"token string\">'/api/user/delete'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">set</span><span class=\"token punctuation\">(</span><span class=\"token string\">'cookie'</span><span class=\"token punctuation\">,</span> <span class=\"token constant\">COOKIE</span><span class=\"token punctuation\">)</span>\n  <span class=\"token function\">expect</span><span class=\"token punctuation\">(</span>res<span class=\"token punctuation\">.</span>body<span class=\"token punctuation\">.</span>errno<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">toBe</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token comment\">// 再次查询用户，应该不存在</span>\n<span class=\"token function\">test</span><span class=\"token punctuation\">(</span><span class=\"token string\">'删除之后，再次查询注册的用户名，应该不存在'</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">async</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span>\n  <span class=\"token keyword\">const</span> res <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> server<span class=\"token punctuation\">.</span><span class=\"token function\">post</span><span class=\"token punctuation\">(</span><span class=\"token string\">'/api/user/isExist'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">send</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">&#123;</span> userName <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span>\n  <span class=\"token function\">expect</span><span class=\"token punctuation\">(</span>res<span class=\"token punctuation\">.</span>body<span class=\"token punctuation\">.</span>errno<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>not<span class=\"token punctuation\">.</span><span class=\"token function\">toBe</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n","more":"<p>代码仓库：<a href=\"https://github.com/changeclass/koa2-weibo\">https://github.com/changeclass/koa2-weibo</a></p>\n<h2 id=\"数据同步\"><a class=\"markdownIt-Anchor\" href=\"#数据同步\"></a> 数据同步</h2>\n<p>user表数据模型</p>\n<pre class=\"line-numbers language-javascript\" data-language=\"javascript\"><code class=\"language-javascript\"><span class=\"token comment\">/**\n * @description 用户数据模型\n * @author 小康\n */</span>\n\n<span class=\"token keyword\">const</span> seq <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'../seq'</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">const</span> <span class=\"token punctuation\">&#123;</span> <span class=\"token constant\">STRING</span><span class=\"token punctuation\">,</span> <span class=\"token constant\">DECIMAL</span> <span class=\"token punctuation\">&#125;</span> <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'../type'</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">const</span> User <span class=\"token operator\">=</span> seq<span class=\"token punctuation\">.</span><span class=\"token function\">define</span><span class=\"token punctuation\">(</span><span class=\"token string\">'user'</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">&#123;</span>\n    userName<span class=\"token operator\">:</span> <span class=\"token punctuation\">&#123;</span>\n        type<span class=\"token operator\">:</span> <span class=\"token constant\">STRING</span><span class=\"token punctuation\">,</span>\n        allowNull<span class=\"token operator\">:</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">,</span>\n        unique<span class=\"token operator\">:</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">,</span>\n        comment<span class=\"token operator\">:</span> <span class=\"token string\">'唯一'</span>\n    <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span>\n    password<span class=\"token operator\">:</span> <span class=\"token punctuation\">&#123;</span>\n        type<span class=\"token operator\">:</span> <span class=\"token constant\">STRING</span><span class=\"token punctuation\">,</span>\n        allowNull<span class=\"token operator\">:</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">,</span>\n        comment<span class=\"token operator\">:</span> <span class=\"token string\">'密码'</span>\n    <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span>\n    nickName<span class=\"token operator\">:</span> <span class=\"token punctuation\">&#123;</span>\n        type<span class=\"token operator\">:</span> <span class=\"token constant\">STRING</span><span class=\"token punctuation\">,</span>\n        allowNull<span class=\"token operator\">:</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">,</span>\n        comment<span class=\"token operator\">:</span> <span class=\"token string\">'昵称'</span>\n    <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span>\n    gender<span class=\"token operator\">:</span> <span class=\"token punctuation\">&#123;</span>\n        type<span class=\"token operator\">:</span> <span class=\"token constant\">DECIMAL</span><span class=\"token punctuation\">,</span>\n        allowNull<span class=\"token operator\">:</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">,</span>\n        defaultValue<span class=\"token operator\">:</span> <span class=\"token number\">3</span><span class=\"token punctuation\">,</span>\n        comment<span class=\"token operator\">:</span> <span class=\"token string\">'性别 (1男性2女性3保密)'</span>\n    <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span>\n    picture<span class=\"token operator\">:</span> <span class=\"token punctuation\">&#123;</span>\n        type<span class=\"token operator\">:</span> <span class=\"token constant\">STRING</span><span class=\"token punctuation\">,</span>\n        comment<span class=\"token operator\">:</span> <span class=\"token string\">'图片地址'</span>\n    <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span>\n    city<span class=\"token operator\">:</span> <span class=\"token punctuation\">&#123;</span>\n        type<span class=\"token operator\">:</span> <span class=\"token constant\">STRING</span><span class=\"token punctuation\">,</span>\n        comment<span class=\"token operator\">:</span> <span class=\"token string\">'城市'</span>\n    <span class=\"token punctuation\">&#125;</span>\n<span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span>\nmodule<span class=\"token punctuation\">.</span>exports <span class=\"token operator\">=</span> User\n<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n<h2 id=\"分层\"><a class=\"markdownIt-Anchor\" href=\"#分层\"></a> 分层</h2>\n<p><img src=\"https://rmt.ladydaily.com/fetch/tzk/storage/20201217142759.png?w=1280&amp;fmt=jpg\" alt=\"image-20201217142759378\" /></p>\n<h2 id=\"业务分层\"><a class=\"markdownIt-Anchor\" href=\"#业务分层\"></a> 业务分层</h2>\n<pre class=\"line-numbers language-src\" data-language=\"src\"><code class=\"language-src\">src                        \n├─ cache                   \n│  └─ _redis.js            \n├─ config                  \n│  ├─ constant.js  常量        \n│  └─ db.js 数据库配置               \n├─ controller 控制器             \n│  └─ user.js 用户控制器            \n├─ db  数据库                    \n│  ├─ model  数据库模型              \n│  │  ├─ index.js          \n│  │  └─ User.js           \n│  ├─ seq.js  数据库链接              \n│  ├─ sync.js 数据库同步             \n│  └─ type.js 数据类型             \n├─ model    业务模型               \n│  ├─ ErrorInfo.js  错误信息       \n│  └─ ResModel.js   规范返回格式       \n├─ public                  \n│  ├─ css                  \n│  │  ├─ jquery.atwho.css  \n│  │  ├─ list.css          \n│  │  ├─ main.css          \n│  │  └─ right.css         \n│  ├─ images               \n│  ├─ javascripts          \n│  │  ├─ jquery.atwho.js   \n│  │  ├─ jquery.caret.js   \n│  │  ├─ my-ajax.js        \n│  │  └─ query-object.js   \n│  └─ stylesheets          \n│     └─ style.css         \n├─ routes 路由                 \n│  ├─ api  API路由                \n│  │  └─ user.js          \n│  ├─ view 视图路由               \n│  │  ├─ error.js          \n│  │  └─ users.js          \n│  └─ index.js             \n├─ services  数据库服务层              \n│  ├─ user.js              \n│  └─ _format.js           \n├─ utils 工具库                  \n│  └─ env.js               \n├─ views 视图层                  \n│  ├─ layout               \n│  │  ├─ footer.ejs        \n│  │  └─ header.ejs        \n│  ├─ widgets              \n│  │  ├─ blog-list.ejs     \n│  │  ├─ fans.ejs          \n│  │  ├─ followers.ejs     \n│  │  ├─ input.ejs         \n│  │  ├─ load-more.ejs     \n│  │  └─ user-info.ejs     \n│  ├─ 404.ejs              \n│  ├─ atMe.ejs             \n│  ├─ error.ejs            \n│  ├─ index.ejs            \n│  ├─ login.ejs            \n│  ├─ profile.ejs          \n│  ├─ register.ejs         \n│  ├─ setting.ejs          \n│  └─ square.ejs           \n└─ app.js 入口文件                 <span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n<p>将各个功能模块进行分层可以是代码逻辑更加清晰。定义业务模型层，例如错误信息（统一返回格式）。定义<code>server</code>层用于与数据库进行交互。</p>\n<ul>\n<li>\n<p>业务模型层（统一返回格式）</p>\n<pre class=\"line-numbers language-javascript\" data-language=\"javascript\"><code class=\"language-javascript\"><span class=\"token comment\">/**\n * @description: res的数据模型\n * @author: 小康\n * @url: https://xiaokang.me\n * @Date: 2020-12-17 14:44:52\n * @LastEditTime: 2020-12-17 14:44:52\n * @LastEditors: 小康\n */</span>\n\n<span class=\"token comment\">/**\n * @author: 小康\n * @url: https://xiaokang.me\n * @description: 基础模块\n */</span>\n<span class=\"token keyword\">class</span> <span class=\"token class-name\">BaseModel</span> <span class=\"token punctuation\">&#123;</span>\n  <span class=\"token function\">constructor</span><span class=\"token punctuation\">(</span><span class=\"token parameter\"><span class=\"token punctuation\">&#123;</span> errno<span class=\"token punctuation\">,</span> data<span class=\"token punctuation\">,</span> message <span class=\"token punctuation\">&#125;</span></span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>errno <span class=\"token operator\">=</span> errno\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>data<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n      <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>data <span class=\"token operator\">=</span> data\n    <span class=\"token punctuation\">&#125;</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>message<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n      <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>message <span class=\"token operator\">=</span> message\n    <span class=\"token punctuation\">&#125;</span>\n  <span class=\"token punctuation\">&#125;</span>\n<span class=\"token punctuation\">&#125;</span>\n\n<span class=\"token comment\">/**\n * @author: 小康\n * @url: https://xiaokang.me\n * @description: 成功的模型\n */</span>\n<span class=\"token keyword\">class</span> <span class=\"token class-name\">SuccessModel</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">BaseModel</span> <span class=\"token punctuation\">&#123;</span>\n  <span class=\"token function\">constructor</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">data <span class=\"token operator\">=</span> <span class=\"token punctuation\">&#123;</span><span class=\"token punctuation\">&#125;</span></span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n    <span class=\"token keyword\">super</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">&#123;</span>\n      errno<span class=\"token operator\">:</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span>\n      data\n    <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">&#125;</span>\n<span class=\"token punctuation\">&#125;</span>\n\n<span class=\"token comment\">/**\n * @author: 小康\n * @url: https://xiaokang.me\n * @description: 失败的模型\n */</span>\n<span class=\"token keyword\">class</span> <span class=\"token class-name\">ErrorModel</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">BaseModel</span> <span class=\"token punctuation\">&#123;</span>\n  <span class=\"token function\">constructor</span><span class=\"token punctuation\">(</span><span class=\"token parameter\"><span class=\"token punctuation\">&#123;</span> errno<span class=\"token punctuation\">,</span> message <span class=\"token punctuation\">&#125;</span></span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n    <span class=\"token keyword\">super</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">&#123;</span>\n      errno<span class=\"token punctuation\">,</span>\n      message\n    <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">&#125;</span>\n<span class=\"token punctuation\">&#125;</span>\n\nmodule<span class=\"token punctuation\">.</span>exports <span class=\"token operator\">=</span> <span class=\"token punctuation\">&#123;</span>\n  SuccessModel<span class=\"token punctuation\">,</span>\n  ErrorModel\n<span class=\"token punctuation\">&#125;</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n</li>\n<li>\n<p>业务模型层（失败信息集合）</p>\n<pre class=\"line-numbers language-javascript\" data-language=\"javascript\"><code class=\"language-javascript\"><span class=\"token comment\">/**\n * @description: 失败信息集合\n * @author: 小康\n * @url: https://xiaokang.me\n * @Date: 2020-12-17 14:54:07\n * @LastEditTime: 2020-12-17 14:54:08\n * @LastEditors: 小康\n */</span>\n\nmodule<span class=\"token punctuation\">.</span>exports <span class=\"token operator\">=</span> <span class=\"token punctuation\">&#123;</span>\n  <span class=\"token comment\">// 用户名已存在</span>\n  registerUserNameExistInfo<span class=\"token operator\">:</span> <span class=\"token punctuation\">&#123;</span>\n    errno<span class=\"token operator\">:</span> <span class=\"token number\">10001</span><span class=\"token punctuation\">,</span>\n    message<span class=\"token operator\">:</span> <span class=\"token string\">'用户名已存在'</span>\n  <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span>\n  <span class=\"token comment\">// 注册失败</span>\n  registerFailInfo<span class=\"token operator\">:</span> <span class=\"token punctuation\">&#123;</span>\n    errno<span class=\"token operator\">:</span> <span class=\"token number\">10002</span><span class=\"token punctuation\">,</span>\n    message<span class=\"token operator\">:</span> <span class=\"token string\">'注册失败，请重试'</span>\n  <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span>\n  <span class=\"token comment\">// 用户名不存在</span>\n  registerUserNameNotExistInfo<span class=\"token operator\">:</span> <span class=\"token punctuation\">&#123;</span>\n    errno<span class=\"token operator\">:</span> <span class=\"token number\">10003</span><span class=\"token punctuation\">,</span>\n    message<span class=\"token operator\">:</span> <span class=\"token string\">'用户名未存在'</span>\n  <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span>\n  <span class=\"token comment\">// 登录失败</span>\n  loginFailInfo<span class=\"token operator\">:</span> <span class=\"token punctuation\">&#123;</span>\n    errno<span class=\"token operator\">:</span> <span class=\"token number\">10004</span><span class=\"token punctuation\">,</span>\n    message<span class=\"token operator\">:</span> <span class=\"token string\">'登录失败，用户名或密码错误'</span>\n  <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span>\n  <span class=\"token comment\">// 未登录</span>\n  loginCheckFailInfo<span class=\"token operator\">:</span> <span class=\"token punctuation\">&#123;</span>\n    errno<span class=\"token operator\">:</span> <span class=\"token number\">10005</span><span class=\"token punctuation\">,</span>\n    message<span class=\"token operator\">:</span> <span class=\"token string\">'您尚未登录'</span>\n  <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span>\n  <span class=\"token comment\">// 修改密码失败</span>\n  changePasswordFailInfo<span class=\"token operator\">:</span> <span class=\"token punctuation\">&#123;</span>\n    errno<span class=\"token operator\">:</span> <span class=\"token number\">10006</span><span class=\"token punctuation\">,</span>\n    message<span class=\"token operator\">:</span> <span class=\"token string\">'修改密码失败，请重试'</span>\n  <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span>\n  <span class=\"token comment\">// 上传文件过大</span>\n  uploadFileSizeFailInfo<span class=\"token operator\">:</span> <span class=\"token punctuation\">&#123;</span>\n    errno<span class=\"token operator\">:</span> <span class=\"token number\">10007</span><span class=\"token punctuation\">,</span>\n    message<span class=\"token operator\">:</span> <span class=\"token string\">'上传文件尺寸过大'</span>\n  <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span>\n  <span class=\"token comment\">// 修改基本信息失败</span>\n  changeInfoFailInfo<span class=\"token operator\">:</span> <span class=\"token punctuation\">&#123;</span>\n    errno<span class=\"token operator\">:</span> <span class=\"token number\">10008</span><span class=\"token punctuation\">,</span>\n    message<span class=\"token operator\">:</span> <span class=\"token string\">'修改基本信息失败'</span>\n  <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span>\n  <span class=\"token comment\">// json schema 校验失败</span>\n  jsonSchemaFileInfo<span class=\"token operator\">:</span> <span class=\"token punctuation\">&#123;</span>\n    errno<span class=\"token operator\">:</span> <span class=\"token number\">10009</span><span class=\"token punctuation\">,</span>\n    message<span class=\"token operator\">:</span> <span class=\"token string\">'数据格式校验错误'</span>\n  <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span>\n  <span class=\"token comment\">// 删除用户失败</span>\n  deleteUserFailInfo<span class=\"token operator\">:</span> <span class=\"token punctuation\">&#123;</span>\n    errno<span class=\"token operator\">:</span> <span class=\"token number\">10010</span><span class=\"token punctuation\">,</span>\n    message<span class=\"token operator\">:</span> <span class=\"token string\">'删除用户失败'</span>\n  <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span>\n  <span class=\"token comment\">// 添加关注失败</span>\n  addFollowerFailInfo<span class=\"token operator\">:</span> <span class=\"token punctuation\">&#123;</span>\n    errno<span class=\"token operator\">:</span> <span class=\"token number\">10011</span><span class=\"token punctuation\">,</span>\n    message<span class=\"token operator\">:</span> <span class=\"token string\">'添加关注失败'</span>\n  <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span>\n  <span class=\"token comment\">// 取消关注失败</span>\n  deleteFollowerFailInfo<span class=\"token operator\">:</span> <span class=\"token punctuation\">&#123;</span>\n    errno<span class=\"token operator\">:</span> <span class=\"token number\">10012</span><span class=\"token punctuation\">,</span>\n    message<span class=\"token operator\">:</span> <span class=\"token string\">'取消关注失败'</span>\n  <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span>\n  <span class=\"token comment\">// 创建微博失败</span>\n  createBlogFailInfo<span class=\"token operator\">:</span> <span class=\"token punctuation\">&#123;</span>\n    errno<span class=\"token operator\">:</span> <span class=\"token number\">11001</span><span class=\"token punctuation\">,</span>\n    message<span class=\"token operator\">:</span> <span class=\"token string\">'创建微博失败，请重试'</span>\n  <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span>\n  <span class=\"token comment\">// 删除微博失败</span>\n  deleteBlogFailInfo<span class=\"token operator\">:</span> <span class=\"token punctuation\">&#123;</span>\n    errno<span class=\"token operator\">:</span> <span class=\"token number\">11002</span><span class=\"token punctuation\">,</span>\n    message<span class=\"token operator\">:</span> <span class=\"token string\">'删除微博失败，请重试'</span>\n  <span class=\"token punctuation\">&#125;</span>\n<span class=\"token punctuation\">&#125;</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n</li>\n</ul>\n<h2 id=\"检查用户是否存在\"><a class=\"markdownIt-Anchor\" href=\"#检查用户是否存在\"></a> 检查用户是否存在</h2>\n<ol>\n<li>\n<p>API路由层</p>\n<pre class=\"line-numbers language-javascript\" data-language=\"javascript\"><code class=\"language-javascript\"><span class=\"token comment\">// 用户名是否存在</span>\nrouter<span class=\"token punctuation\">.</span><span class=\"token function\">post</span><span class=\"token punctuation\">(</span><span class=\"token string\">'/isExist'</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">async</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">ctx<span class=\"token punctuation\">,</span> next</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span>\n  <span class=\"token keyword\">const</span> <span class=\"token punctuation\">&#123;</span> userName <span class=\"token punctuation\">&#125;</span> <span class=\"token operator\">=</span> ctx<span class=\"token punctuation\">.</span>request<span class=\"token punctuation\">.</span>body\n  ctx<span class=\"token punctuation\">.</span>body <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> <span class=\"token function\">isExist</span><span class=\"token punctuation\">(</span>userName<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n</li>\n<li>\n<p><code>controller</code>层</p>\n<pre class=\"line-numbers language-javascript\" data-language=\"javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">const</span> <span class=\"token punctuation\">&#123;</span> getUserInfo<span class=\"token punctuation\">,</span> createUser <span class=\"token punctuation\">&#125;</span> <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'../services/user'</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">const</span> <span class=\"token punctuation\">&#123;</span> SuccessModel<span class=\"token punctuation\">,</span> ErrorModel <span class=\"token punctuation\">&#125;</span> <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'../model/ResModel'</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">const</span> <span class=\"token punctuation\">&#123;</span>\n  registerUserNameNotExistInfo<span class=\"token punctuation\">,</span>\n  registerUserNameExistInfo<span class=\"token punctuation\">,</span>\n  registerFailInfo\n<span class=\"token punctuation\">&#125;</span> <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'../model/ErrorInfo'</span><span class=\"token punctuation\">)</span>\n<span class=\"token comment\">/**\n * @author: 小康\n * @url: https://xiaokang.me\n * @param &#123;String&#125; userName 需要检查的用户名\n * @description: 检查用户名是否存在\n */</span>\n<span class=\"token keyword\">async</span> <span class=\"token keyword\">function</span> <span class=\"token function\">isExist</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">userName</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n    <span class=\"token keyword\">const</span> userInfo <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> <span class=\"token function\">getUserInfo</span><span class=\"token punctuation\">(</span>userName<span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>userInfo<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n        <span class=\"token comment\">// 已经存在</span>\n        <span class=\"token keyword\">return</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">SuccessModel</span><span class=\"token punctuation\">(</span>userInfo<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">&#123;</span>\n        <span class=\"token comment\">// 不存在</span>\n        <span class=\"token keyword\">return</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">ErrorModel</span><span class=\"token punctuation\">(</span>registerUserNameNotExistInfo<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">&#125;</span>\n<span class=\"token punctuation\">&#125;</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n</li>\n<li>\n<p><code>servers</code>层</p>\n<pre class=\"line-numbers language-javascript\" data-language=\"javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">const</span> <span class=\"token punctuation\">&#123;</span> User <span class=\"token punctuation\">&#125;</span> <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'../db/model/index'</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">const</span> <span class=\"token punctuation\">&#123;</span> formatUser <span class=\"token punctuation\">&#125;</span> <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'./_format'</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token comment\">/**\n * @author: 小康\n * @url: https://xiaokang.me\n * @param &#123;*&#125; userName 用户名\n * @param &#123;*&#125; password 密码\n * @description: 获取用户的信息\n */</span>\n<span class=\"token keyword\">async</span> <span class=\"token keyword\">function</span> <span class=\"token function\">getUserInfo</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">userName<span class=\"token punctuation\">,</span> password</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n    <span class=\"token keyword\">const</span> whereOpt <span class=\"token operator\">=</span> <span class=\"token punctuation\">&#123;</span>\n        userName\n    <span class=\"token punctuation\">&#125;</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>password<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n        Object<span class=\"token punctuation\">.</span><span class=\"token function\">assign</span><span class=\"token punctuation\">(</span>whereOpt<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">&#123;</span> password <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">&#125;</span>\n    <span class=\"token comment\">// 查询</span>\n    <span class=\"token keyword\">const</span> result <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> User<span class=\"token punctuation\">.</span><span class=\"token function\">findOne</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">&#123;</span>\n        <span class=\"token comment\">// 查询的列</span>\n        attributes<span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token string\">'id'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'userName'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'nickName'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'picture'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'city'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n        <span class=\"token comment\">// 查询条件</span>\n        where<span class=\"token operator\">:</span> whereOpt\n    <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>result <span class=\"token operator\">==</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n        <span class=\"token comment\">// 未找到</span>\n        <span class=\"token keyword\">return</span> result\n    <span class=\"token punctuation\">&#125;</span>\n    <span class=\"token comment\">// 格式化</span>\n    <span class=\"token keyword\">const</span> formatRes <span class=\"token operator\">=</span> <span class=\"token function\">formatUser</span><span class=\"token punctuation\">(</span>result<span class=\"token punctuation\">.</span>dataValues<span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">return</span> formatRes\n<span class=\"token punctuation\">&#125;</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n<p><code>formatUser</code>方法</p>\n<pre class=\"line-numbers language-javascript\" data-language=\"javascript\"><code class=\"language-javascript\"><span class=\"token comment\">/**\n * 格式化头像\n * @author 小康\n * @date 2020-12-17\n * @param &#123;Object&#125; obj 用户对象\n * @returns &#123;Object&#125; 处理后的结果\n */</span>\n<span class=\"token keyword\">function</span> <span class=\"token function\">_formatUserPicture</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">obj</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>obj<span class=\"token punctuation\">.</span>picture <span class=\"token operator\">==</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n        obj<span class=\"token punctuation\">.</span>picture <span class=\"token operator\">=</span> <span class=\"token constant\">DEFAULT_PICTURE</span>\n    <span class=\"token punctuation\">&#125;</span>\n    <span class=\"token keyword\">return</span> obj\n<span class=\"token punctuation\">&#125;</span>\n\n<span class=\"token comment\">/**\n * 格式化用户\n * @author 小康\n * @date 2020-12-17\n * @param &#123;Array|Object&#125; list 用户列表或单个用户对象\n * @returns &#123;any&#125;\n */</span>\n<span class=\"token keyword\">function</span> <span class=\"token function\">formatUser</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">list</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>list <span class=\"token operator\">==</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n        <span class=\"token keyword\">return</span> list\n    <span class=\"token punctuation\">&#125;</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>list <span class=\"token keyword\">instanceof</span> <span class=\"token class-name\">Array</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n        <span class=\"token comment\">// 数组 用户列表</span>\n        <span class=\"token keyword\">return</span> list<span class=\"token punctuation\">.</span><span class=\"token function\">map</span><span class=\"token punctuation\">(</span>_formatUserPicture<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">&#125;</span>\n    <span class=\"token comment\">// 单个对象</span>\n    <span class=\"token keyword\">let</span> result <span class=\"token operator\">=</span> list\n    result <span class=\"token operator\">=</span> <span class=\"token function\">_formatUserPicture</span><span class=\"token punctuation\">(</span>result<span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">return</span> result\n<span class=\"token punctuation\">&#125;</span>\n<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n</li>\n</ol>\n<h2 id=\"用户注册\"><a class=\"markdownIt-Anchor\" href=\"#用户注册\"></a> 用户注册</h2>\n<p>具体逻辑与检查用户是否存在相似。</p>\n<h2 id=\"密码加密\"><a class=\"markdownIt-Anchor\" href=\"#密码加密\"></a> 密码加密</h2>\n<p>密码加密只需要在存储数据时对数据进行加密处理即可。</p>\n<p><code>user</code>的<code>controller</code>层</p>\n<pre class=\"line-numbers language-javascript\" data-language=\"javascript\"><code class=\"language-javascript\"><span class=\"token comment\">// ...</span>\n<span class=\"token comment\">// 注册功能</span>\n<span class=\"token keyword\">try</span> <span class=\"token punctuation\">&#123;</span>\n    <span class=\"token function\">createUser</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">&#123;</span>\n        userName<span class=\"token punctuation\">,</span>\n        password<span class=\"token operator\">:</span> <span class=\"token function\">doCrypto</span><span class=\"token punctuation\">(</span>password<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n        gender\n    <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">return</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">SuccessModel</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span>e<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n    console<span class=\"token punctuation\">.</span><span class=\"token function\">error</span><span class=\"token punctuation\">(</span>e<span class=\"token punctuation\">.</span>message<span class=\"token punctuation\">,</span> e<span class=\"token punctuation\">.</span>stack<span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">return</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">ErrorModel</span><span class=\"token punctuation\">(</span>registerFailInfo<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">&#125;</span>\n<span class=\"token comment\">// ...</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n<p><code>doCrypto</code>函数</p>\n<pre class=\"line-numbers language-javascript\" data-language=\"javascript\"><code class=\"language-javascript\"><span class=\"token comment\">/**\n * @description: 加密方法\n * @author: 小康\n * @url: https://xiaokang.me\n * @Date: 2020-12-17 15:43:56\n * @LastEditTime: 2020-12-17 15:43:56\n * @LastEditors: 小康\n */</span>\n\n<span class=\"token keyword\">const</span> crypto <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'crypto'</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">const</span> <span class=\"token punctuation\">&#123;</span> <span class=\"token constant\">CRYPTO_SECRET_KEY</span> <span class=\"token punctuation\">&#125;</span> <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'../config/secretKeys'</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token comment\">/**\n * @author: 小康\n * @url: https://xiaokang.me\n * @param &#123;String&#125; content 要加密的明文\n * @description: MD5加密\n */</span>\n<span class=\"token keyword\">function</span> <span class=\"token function\">_md5</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">content</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n  <span class=\"token keyword\">const</span> md5 <span class=\"token operator\">=</span> crypto<span class=\"token punctuation\">.</span><span class=\"token function\">createHash</span><span class=\"token punctuation\">(</span><span class=\"token string\">'md5'</span><span class=\"token punctuation\">)</span>\n  <span class=\"token keyword\">return</span> md5<span class=\"token punctuation\">.</span><span class=\"token function\">update</span><span class=\"token punctuation\">(</span>content<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">digest</span><span class=\"token punctuation\">(</span><span class=\"token string\">'hex'</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">&#125;</span>\n\n<span class=\"token comment\">/**\n * @author: 小康\n * @url: https://xiaokang.me\n * @param &#123;*&#125; content 明文\n * @description: 加密方法\n */</span>\n<span class=\"token keyword\">function</span> <span class=\"token function\">doCrypto</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">content</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n  <span class=\"token keyword\">const</span> str <span class=\"token operator\">=</span> <span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">password=</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">$&#123;</span>content<span class=\"token interpolation-punctuation punctuation\">&#125;</span></span><span class=\"token string\">&amp;key=</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">$&#123;</span><span class=\"token constant\">CRYPTO_SECRET_KEY</span><span class=\"token interpolation-punctuation punctuation\">&#125;</span></span><span class=\"token template-punctuation string\">`</span></span>\n  <span class=\"token keyword\">return</span> <span class=\"token function\">_md5</span><span class=\"token punctuation\">(</span>str<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">&#125;</span>\n\nmodule<span class=\"token punctuation\">.</span>exports <span class=\"token operator\">=</span> <span class=\"token punctuation\">&#123;</span>\n  doCrypto\n<span class=\"token punctuation\">&#125;</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n<h2 id=\"用户信息格式验证\"><a class=\"markdownIt-Anchor\" href=\"#用户信息格式验证\"></a> 用户信息格式验证</h2>\n<p>在注册逻辑执行前加入中间件函数。</p>\n<pre class=\"line-numbers language-javascript\" data-language=\"javascript\"><code class=\"language-javascript\"><span class=\"token comment\">// 注册路由</span>\nrouter<span class=\"token punctuation\">.</span><span class=\"token function\">post</span><span class=\"token punctuation\">(</span><span class=\"token string\">'/register'</span><span class=\"token punctuation\">,</span> <span class=\"token function\">genValidator</span><span class=\"token punctuation\">(</span>userValidate<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">async</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">ctx<span class=\"token punctuation\">,</span> next</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span>\n  <span class=\"token keyword\">const</span> <span class=\"token punctuation\">&#123;</span> userName<span class=\"token punctuation\">,</span> password<span class=\"token punctuation\">,</span> gender <span class=\"token punctuation\">&#125;</span> <span class=\"token operator\">=</span> ctx<span class=\"token punctuation\">.</span>request<span class=\"token punctuation\">.</span>body\n  ctx<span class=\"token punctuation\">.</span>body <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> <span class=\"token function\">register</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">&#123;</span> userName<span class=\"token punctuation\">,</span> password<span class=\"token punctuation\">,</span> gender <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n<ul>\n<li>\n<p><code>genValidator</code>用于生成中间件函数</p>\n<pre class=\"line-numbers language-javascript\" data-language=\"javascript\"><code class=\"language-javascript\"><span class=\"token comment\">/**\n * @description: json schema验证中间件\n * @author: 小康\n * @url: https://xiaokang.me\n * @Date: 2020-12-17 16:34:54\n * @LastEditTime: 2020-12-17 16:34:54\n * @LastEditors: 小康\n */</span>\n\n<span class=\"token keyword\">const</span> <span class=\"token punctuation\">&#123;</span> jsonSchemaFileInfo <span class=\"token punctuation\">&#125;</span> <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'../model/ErrorInfo'</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">const</span> <span class=\"token punctuation\">&#123;</span> ErrorModel <span class=\"token punctuation\">&#125;</span> <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'../model/ResModel'</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token comment\">/**\n * @author: 小康\n * @url: https://xiaokang.me\n * @param &#123;function&#125; validateFn 验证函数\n * @description: 生成json schema 验证中间件\n */</span>\n<span class=\"token keyword\">function</span> <span class=\"token function\">genValidator</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">validateFn</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n  <span class=\"token keyword\">async</span> <span class=\"token keyword\">function</span> <span class=\"token function\">validator</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">ctx<span class=\"token punctuation\">,</span> next</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n    <span class=\"token keyword\">const</span> data <span class=\"token operator\">=</span> ctx<span class=\"token punctuation\">.</span>request<span class=\"token punctuation\">.</span>body\n    <span class=\"token keyword\">const</span> error <span class=\"token operator\">=</span> <span class=\"token function\">validateFn</span><span class=\"token punctuation\">(</span>data<span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>error<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n      <span class=\"token comment\">// 验证失败</span>\n      <span class=\"token keyword\">return</span> <span class=\"token punctuation\">(</span>ctx<span class=\"token punctuation\">.</span>body <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">ErrorModel</span><span class=\"token punctuation\">(</span>jsonSchemaFileInfo<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">&#125;</span>\n    <span class=\"token comment\">// 验证成功</span>\n    <span class=\"token keyword\">await</span> <span class=\"token function\">next</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">&#125;</span>\n  <span class=\"token keyword\">return</span> validator\n<span class=\"token punctuation\">&#125;</span>\n\nmodule<span class=\"token punctuation\">.</span>exports <span class=\"token operator\">=</span> <span class=\"token punctuation\">&#123;</span> genValidator <span class=\"token punctuation\">&#125;</span>\n<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n<p>传入验证函数</p>\n</li>\n<li>\n<p><code>userValidate</code>验证函数</p>\n<pre class=\"line-numbers language-javascript\" data-language=\"javascript\"><code class=\"language-javascript\"><span class=\"token comment\">/**\n * @description: user 数据格式校验\n * @author: 小康\n * @url: https://xiaokang.me\n * @Date: 2020-12-17 16:17:42\n * @LastEditTime: 2020-12-17 16:17:43\n * @LastEditors: 小康\n */</span>\n<span class=\"token keyword\">const</span> validate <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'./_validate'</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token comment\">// 校验规则</span>\n<span class=\"token keyword\">const</span> <span class=\"token constant\">SCHEMA</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">&#123;</span>\n  type<span class=\"token operator\">:</span> <span class=\"token string\">'object'</span><span class=\"token punctuation\">,</span>\n  properties<span class=\"token operator\">:</span> <span class=\"token punctuation\">&#123;</span>\n    userName<span class=\"token operator\">:</span> <span class=\"token punctuation\">&#123;</span>\n      type<span class=\"token operator\">:</span> <span class=\"token string\">'string'</span><span class=\"token punctuation\">,</span>\n      pattern<span class=\"token operator\">:</span> <span class=\"token string\">'^[a-zA-Z][a-zA-Z0-9_]+$'</span><span class=\"token punctuation\">,</span> <span class=\"token comment\">// 字母开头，字母数字下划线</span>\n      maxLength<span class=\"token operator\">:</span> <span class=\"token number\">255</span><span class=\"token punctuation\">,</span>\n      minLength<span class=\"token operator\">:</span> <span class=\"token number\">2</span>\n    <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span>\n    password<span class=\"token operator\">:</span> <span class=\"token punctuation\">&#123;</span>\n      type<span class=\"token operator\">:</span> <span class=\"token string\">'string'</span><span class=\"token punctuation\">,</span>\n      maxLength<span class=\"token operator\">:</span> <span class=\"token number\">255</span><span class=\"token punctuation\">,</span>\n      minLength<span class=\"token operator\">:</span> <span class=\"token number\">3</span>\n    <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span>\n    newPassword<span class=\"token operator\">:</span> <span class=\"token punctuation\">&#123;</span>\n      type<span class=\"token operator\">:</span> <span class=\"token string\">'string'</span><span class=\"token punctuation\">,</span>\n      maxLength<span class=\"token operator\">:</span> <span class=\"token number\">255</span><span class=\"token punctuation\">,</span>\n      minLength<span class=\"token operator\">:</span> <span class=\"token number\">3</span>\n    <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span>\n    nickName<span class=\"token operator\">:</span> <span class=\"token punctuation\">&#123;</span>\n      type<span class=\"token operator\">:</span> <span class=\"token string\">'string'</span><span class=\"token punctuation\">,</span>\n      maxLength<span class=\"token operator\">:</span> <span class=\"token number\">255</span>\n    <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span>\n    picture<span class=\"token operator\">:</span> <span class=\"token punctuation\">&#123;</span>\n      type<span class=\"token operator\">:</span> <span class=\"token string\">'string'</span><span class=\"token punctuation\">,</span>\n      maxLength<span class=\"token operator\">:</span> <span class=\"token number\">255</span>\n    <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span>\n    city<span class=\"token operator\">:</span> <span class=\"token punctuation\">&#123;</span>\n      type<span class=\"token operator\">:</span> <span class=\"token string\">'string'</span><span class=\"token punctuation\">,</span>\n      maxLength<span class=\"token operator\">:</span> <span class=\"token number\">255</span><span class=\"token punctuation\">,</span>\n      minLength<span class=\"token operator\">:</span> <span class=\"token number\">2</span>\n    <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span>\n    gender<span class=\"token operator\">:</span> <span class=\"token punctuation\">&#123;</span>\n      type<span class=\"token operator\">:</span> <span class=\"token string\">'number'</span><span class=\"token punctuation\">,</span>\n      minimum<span class=\"token operator\">:</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span>\n      maximum<span class=\"token operator\">:</span> <span class=\"token number\">3</span>\n    <span class=\"token punctuation\">&#125;</span>\n  <span class=\"token punctuation\">&#125;</span>\n<span class=\"token punctuation\">&#125;</span>\n\n<span class=\"token comment\">/**\n * 校验用户数据格式\n * @param &#123;Object&#125; data 用户数据\n */</span>\n<span class=\"token keyword\">function</span> <span class=\"token function\">userValidate</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">data <span class=\"token operator\">=</span> <span class=\"token punctuation\">&#123;</span><span class=\"token punctuation\">&#125;</span></span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n  <span class=\"token keyword\">return</span> <span class=\"token function\">validate</span><span class=\"token punctuation\">(</span><span class=\"token constant\">SCHEMA</span><span class=\"token punctuation\">,</span> data<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">&#125;</span>\n\nmodule<span class=\"token punctuation\">.</span>exports <span class=\"token operator\">=</span> userValidate<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n</li>\n</ul>\n<h2 id=\"登录验证中间件\"><a class=\"markdownIt-Anchor\" href=\"#登录验证中间件\"></a> 登录验证中间件</h2>\n<pre class=\"line-numbers language-javascript\" data-language=\"javascript\"><code class=\"language-javascript\"><span class=\"token comment\">/**\n * @description: user 的控制器\n * @author: 小康\n * @url: https://xiaokang.me\n * @Date: 2020-12-17 14:19:03\n * @LastEditTime: 2020-12-17 14:19:05\n * @LastEditors: 小康\n */</span>\n\n<span class=\"token keyword\">const</span> <span class=\"token punctuation\">&#123;</span> getUserInfo<span class=\"token punctuation\">,</span> createUser <span class=\"token punctuation\">&#125;</span> <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'../services/user'</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">const</span> <span class=\"token punctuation\">&#123;</span> SuccessModel<span class=\"token punctuation\">,</span> ErrorModel <span class=\"token punctuation\">&#125;</span> <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'../model/ResModel'</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">const</span> <span class=\"token punctuation\">&#123;</span>\n    registerUserNameNotExistInfo<span class=\"token punctuation\">,</span>\n    registerUserNameExistInfo<span class=\"token punctuation\">,</span>\n    registerFailInfo<span class=\"token punctuation\">,</span>\n    loginFailInfo\n<span class=\"token punctuation\">&#125;</span> <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'../model/ErrorInfo'</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">const</span> <span class=\"token punctuation\">&#123;</span> doCrypto <span class=\"token punctuation\">&#125;</span> <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'../utils/cryp'</span><span class=\"token punctuation\">)</span>\n<span class=\"token comment\">/**\n * @author: 小康\n * @url: https://xiaokang.me\n * @param &#123;String&#125; userName 需要检查的用户名\n * @description: 检查用户名是否存在\n */</span>\n<span class=\"token keyword\">async</span> <span class=\"token keyword\">function</span> <span class=\"token function\">isExist</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">userName</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n    <span class=\"token keyword\">const</span> userInfo <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> <span class=\"token function\">getUserInfo</span><span class=\"token punctuation\">(</span>userName<span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>userInfo<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n        <span class=\"token comment\">// 已经存在</span>\n        <span class=\"token keyword\">return</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">SuccessModel</span><span class=\"token punctuation\">(</span>userInfo<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">&#123;</span>\n        <span class=\"token comment\">// 不存在</span>\n        <span class=\"token keyword\">return</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">ErrorModel</span><span class=\"token punctuation\">(</span>registerUserNameNotExistInfo<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">&#125;</span>\n<span class=\"token punctuation\">&#125;</span>\n\n<span class=\"token comment\">/**\n * @author: 小康\n * @url: https://xiaokang.me\n * @param &#123;String&#125; userName 用户名\n * @param &#123;String&#125; password 密码\n * @param &#123;Number&#125; gender 性别 1是男 2是女 3是保密\n * @description: 注册功能\n */</span>\n<span class=\"token keyword\">async</span> <span class=\"token keyword\">function</span> <span class=\"token function\">register</span><span class=\"token punctuation\">(</span><span class=\"token parameter\"><span class=\"token punctuation\">&#123;</span> userName<span class=\"token punctuation\">,</span> password<span class=\"token punctuation\">,</span> gender <span class=\"token punctuation\">&#125;</span></span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n    <span class=\"token keyword\">const</span> userInfo <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> <span class=\"token function\">getUserInfo</span><span class=\"token punctuation\">(</span>userName<span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>userInfo<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n        <span class=\"token comment\">// 用户名已存在</span>\n        <span class=\"token keyword\">return</span> <span class=\"token function\">ErrorModel</span><span class=\"token punctuation\">(</span>registerUserNameExistInfo<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">&#125;</span>\n    <span class=\"token comment\">// 注册功能</span>\n    <span class=\"token keyword\">try</span> <span class=\"token punctuation\">&#123;</span>\n        <span class=\"token function\">createUser</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">&#123;</span>\n            userName<span class=\"token punctuation\">,</span>\n            password<span class=\"token operator\">:</span> <span class=\"token function\">doCrypto</span><span class=\"token punctuation\">(</span>password<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n            gender\n        <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">return</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">SuccessModel</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span>e<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n        console<span class=\"token punctuation\">.</span><span class=\"token function\">error</span><span class=\"token punctuation\">(</span>e<span class=\"token punctuation\">.</span>message<span class=\"token punctuation\">,</span> e<span class=\"token punctuation\">.</span>stack<span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">return</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">ErrorModel</span><span class=\"token punctuation\">(</span>registerFailInfo<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">&#125;</span>\n<span class=\"token punctuation\">&#125;</span>\n\n<span class=\"token comment\">/**\n * @author: 小康\n * @url: https://xiaokang.me\n * @param &#123;*&#125; ctx koa2 ctx\n * @param &#123;*&#125; userName 用户名\n * @param &#123;*&#125; password 密码\n * @description: 登录\n */</span>\n<span class=\"token keyword\">async</span> <span class=\"token keyword\">function</span> <span class=\"token function\">login</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">ctx<span class=\"token punctuation\">,</span> userName<span class=\"token punctuation\">,</span> password</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n    <span class=\"token comment\">// 登录成功之后，将用户信息放到session中</span>\n    <span class=\"token keyword\">const</span> userInfo <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> <span class=\"token function\">getUserInfo</span><span class=\"token punctuation\">(</span>userName<span class=\"token punctuation\">,</span> <span class=\"token function\">doCrypto</span><span class=\"token punctuation\">(</span>password<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>userInfo<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n        <span class=\"token keyword\">return</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">ErrorModel</span><span class=\"token punctuation\">(</span>loginFailInfo<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">&#125;</span>\n    <span class=\"token comment\">// 登录成功</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>ctx<span class=\"token punctuation\">.</span>session<span class=\"token punctuation\">.</span>userInfo <span class=\"token operator\">==</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n        ctx<span class=\"token punctuation\">.</span>session<span class=\"token punctuation\">.</span>userInfo <span class=\"token operator\">=</span> userInfo\n    <span class=\"token punctuation\">&#125;</span>\n    <span class=\"token keyword\">return</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">SuccessModel</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">&#125;</span>\nmodule<span class=\"token punctuation\">.</span>exports <span class=\"token operator\">=</span> <span class=\"token punctuation\">&#123;</span>\n    isExist<span class=\"token punctuation\">,</span>\n    register<span class=\"token punctuation\">,</span>\n    login\n<span class=\"token punctuation\">&#125;</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n<h2 id=\"单元测试\"><a class=\"markdownIt-Anchor\" href=\"#单元测试\"></a> 单元测试</h2>\n<h3 id=\"数据模型\"><a class=\"markdownIt-Anchor\" href=\"#数据模型\"></a> 数据模型</h3>\n<p><code>model.test.js</code></p>\n<pre class=\"line-numbers language-javascript\" data-language=\"javascript\"><code class=\"language-javascript\"><span class=\"token comment\">/**\n * @description: user model test\n * @author: 小康\n * @url: https://xiaokang.me\n * @Date: 2020-12-17 19:41:28\n * @LastEditTime: 2020-12-17 19:41:28\n * @LastEditors: 小康\n */</span>\n\n<span class=\"token keyword\">const</span> <span class=\"token punctuation\">&#123;</span> User <span class=\"token punctuation\">&#125;</span> <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'../../src/db/model/index'</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token function\">test</span><span class=\"token punctuation\">(</span><span class=\"token string\">'User 模型的各个属性，符合预期'</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span>\n  <span class=\"token comment\">// 构建一个内存的User实例，但不会提交数据库</span>\n  <span class=\"token keyword\">const</span> user <span class=\"token operator\">=</span> User<span class=\"token punctuation\">.</span><span class=\"token function\">build</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">&#123;</span>\n    userName<span class=\"token operator\">:</span> <span class=\"token string\">'zhangsan'</span><span class=\"token punctuation\">,</span>\n    password<span class=\"token operator\">:</span> <span class=\"token string\">'p1234'</span><span class=\"token punctuation\">,</span>\n    nickName<span class=\"token operator\">:</span> <span class=\"token string\">'张三'</span><span class=\"token punctuation\">,</span>\n    <span class=\"token comment\">// gender: 1,</span>\n    picture<span class=\"token operator\">:</span> <span class=\"token string\">'/xxx.png'</span><span class=\"token punctuation\">,</span>\n    city<span class=\"token operator\">:</span> <span class=\"token string\">'北京'</span>\n  <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span>\n  <span class=\"token comment\">// 验证各个属性</span>\n  <span class=\"token function\">expect</span><span class=\"token punctuation\">(</span>user<span class=\"token punctuation\">.</span>userName<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">toBe</span><span class=\"token punctuation\">(</span><span class=\"token string\">'zhangsan'</span><span class=\"token punctuation\">)</span>\n  <span class=\"token function\">expect</span><span class=\"token punctuation\">(</span>user<span class=\"token punctuation\">.</span>password<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">toBe</span><span class=\"token punctuation\">(</span><span class=\"token string\">'p1234'</span><span class=\"token punctuation\">)</span>\n  <span class=\"token function\">expect</span><span class=\"token punctuation\">(</span>user<span class=\"token punctuation\">.</span>nickName<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">toBe</span><span class=\"token punctuation\">(</span><span class=\"token string\">'张三'</span><span class=\"token punctuation\">)</span>\n  <span class=\"token function\">expect</span><span class=\"token punctuation\">(</span>user<span class=\"token punctuation\">.</span>gender<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">toBe</span><span class=\"token punctuation\">(</span><span class=\"token number\">3</span><span class=\"token punctuation\">)</span>\n  <span class=\"token function\">expect</span><span class=\"token punctuation\">(</span>user<span class=\"token punctuation\">.</span>picture<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">toBe</span><span class=\"token punctuation\">(</span><span class=\"token string\">'/xxx.png'</span><span class=\"token punctuation\">)</span>\n  <span class=\"token function\">expect</span><span class=\"token punctuation\">(</span>user<span class=\"token punctuation\">.</span>city<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">toBe</span><span class=\"token punctuation\">(</span><span class=\"token string\">'北京'</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n<h3 id=\"登录相关测试\"><a class=\"markdownIt-Anchor\" href=\"#登录相关测试\"></a> 登录相关测试</h3>\n<pre class=\"line-numbers language-javascript\" data-language=\"javascript\"><code class=\"language-javascript\"><span class=\"token comment\">/**\n * @description: user api test\n * @author: 小康\n * @url: https://xiaokang.me\n * @Date: 2020-12-17 19:59:34\n * @LastEditTime: 2020-12-17 19:59:34\n * @LastEditors: 小康\n */</span>\n\n<span class=\"token keyword\">const</span> server <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'../server'</span><span class=\"token punctuation\">)</span>\n<span class=\"token comment\">// 用户信息</span>\n<span class=\"token keyword\">const</span> userName <span class=\"token operator\">=</span> <span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">u_</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">$&#123;</span>Date<span class=\"token punctuation\">.</span><span class=\"token function\">now</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token interpolation-punctuation punctuation\">&#125;</span></span><span class=\"token template-punctuation string\">`</span></span>\n<span class=\"token keyword\">const</span> password <span class=\"token operator\">=</span> <span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">p_</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">$&#123;</span>Date<span class=\"token punctuation\">.</span><span class=\"token function\">now</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token interpolation-punctuation punctuation\">&#125;</span></span><span class=\"token template-punctuation string\">`</span></span>\n<span class=\"token keyword\">const</span> testUser <span class=\"token operator\">=</span> <span class=\"token punctuation\">&#123;</span>\n  userName<span class=\"token punctuation\">,</span>\n  password<span class=\"token punctuation\">,</span>\n  nickName<span class=\"token operator\">:</span> userName<span class=\"token punctuation\">,</span>\n  gender<span class=\"token operator\">:</span> <span class=\"token number\">1</span>\n<span class=\"token punctuation\">&#125;</span>\n\n<span class=\"token comment\">// 存储 cookie</span>\n<span class=\"token keyword\">let</span> <span class=\"token constant\">COOKIE</span> <span class=\"token operator\">=</span> <span class=\"token string\">''</span>\n\n<span class=\"token comment\">// 注册</span>\n<span class=\"token function\">test</span><span class=\"token punctuation\">(</span><span class=\"token string\">'注册一个用户，应该成功'</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">async</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span>\n  <span class=\"token keyword\">const</span> res <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> server<span class=\"token punctuation\">.</span><span class=\"token function\">post</span><span class=\"token punctuation\">(</span><span class=\"token string\">'/api/user/register'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">send</span><span class=\"token punctuation\">(</span>testUser<span class=\"token punctuation\">)</span>\n  <span class=\"token function\">expect</span><span class=\"token punctuation\">(</span>res<span class=\"token punctuation\">.</span>body<span class=\"token punctuation\">.</span>errno<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">toBe</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token comment\">// 重复注册</span>\n<span class=\"token function\">test</span><span class=\"token punctuation\">(</span><span class=\"token string\">'重复注册用户，应该失败'</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">async</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span>\n  <span class=\"token keyword\">const</span> res <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> server<span class=\"token punctuation\">.</span><span class=\"token function\">post</span><span class=\"token punctuation\">(</span><span class=\"token string\">'/api/user/register'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">send</span><span class=\"token punctuation\">(</span>testUser<span class=\"token punctuation\">)</span>\n  <span class=\"token function\">expect</span><span class=\"token punctuation\">(</span>res<span class=\"token punctuation\">.</span>body<span class=\"token punctuation\">.</span>errno<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>not<span class=\"token punctuation\">.</span><span class=\"token function\">toBe</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token comment\">// 查询用户是否存在</span>\n<span class=\"token function\">test</span><span class=\"token punctuation\">(</span><span class=\"token string\">'查询注册的用户名，应该存在'</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">async</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span>\n  <span class=\"token keyword\">const</span> res <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> server<span class=\"token punctuation\">.</span><span class=\"token function\">post</span><span class=\"token punctuation\">(</span><span class=\"token string\">'/api/user/isExist'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">send</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">&#123;</span> userName <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span>\n  <span class=\"token function\">expect</span><span class=\"token punctuation\">(</span>res<span class=\"token punctuation\">.</span>body<span class=\"token punctuation\">.</span>errno<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">toBe</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token comment\">// json schema 检测</span>\n<span class=\"token function\">test</span><span class=\"token punctuation\">(</span><span class=\"token string\">'json schema 检测，非法的格式，注册应该失败'</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">async</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span>\n  <span class=\"token keyword\">const</span> res <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> server<span class=\"token punctuation\">.</span><span class=\"token function\">post</span><span class=\"token punctuation\">(</span><span class=\"token string\">'/api/user/register'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">send</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">&#123;</span>\n    userName<span class=\"token operator\">:</span> <span class=\"token string\">'123'</span><span class=\"token punctuation\">,</span> <span class=\"token comment\">// 用户名不是字母（或下划线）开头</span>\n    password<span class=\"token operator\">:</span> <span class=\"token string\">'a'</span><span class=\"token punctuation\">,</span> <span class=\"token comment\">// 最小长度不是 3</span>\n    <span class=\"token comment\">// nickName: ''</span>\n    gender<span class=\"token operator\">:</span> <span class=\"token string\">'mail'</span> <span class=\"token comment\">// 不是数字</span>\n  <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span>\n  <span class=\"token function\">expect</span><span class=\"token punctuation\">(</span>res<span class=\"token punctuation\">.</span>body<span class=\"token punctuation\">.</span>errno<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>not<span class=\"token punctuation\">.</span><span class=\"token function\">toBe</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token comment\">// 登录</span>\n<span class=\"token function\">test</span><span class=\"token punctuation\">(</span><span class=\"token string\">'登录，应该成功'</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">async</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span>\n  <span class=\"token keyword\">const</span> res <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> server<span class=\"token punctuation\">.</span><span class=\"token function\">post</span><span class=\"token punctuation\">(</span><span class=\"token string\">'/api/user/login'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">send</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">&#123;</span>\n    userName<span class=\"token punctuation\">,</span>\n    password\n  <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span>\n  <span class=\"token function\">expect</span><span class=\"token punctuation\">(</span>res<span class=\"token punctuation\">.</span>body<span class=\"token punctuation\">.</span>errno<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">toBe</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span>\n\n  <span class=\"token comment\">// 获取 cookie</span>\n  <span class=\"token constant\">COOKIE</span> <span class=\"token operator\">=</span> res<span class=\"token punctuation\">.</span>headers<span class=\"token punctuation\">[</span><span class=\"token string\">'set-cookie'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span><span class=\"token function\">join</span><span class=\"token punctuation\">(</span><span class=\"token string\">';'</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token comment\">// 删除</span>\n<span class=\"token function\">test</span><span class=\"token punctuation\">(</span><span class=\"token string\">'删除用户，应该成功'</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">async</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span>\n  <span class=\"token keyword\">const</span> res <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> server<span class=\"token punctuation\">.</span><span class=\"token function\">post</span><span class=\"token punctuation\">(</span><span class=\"token string\">'/api/user/delete'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">set</span><span class=\"token punctuation\">(</span><span class=\"token string\">'cookie'</span><span class=\"token punctuation\">,</span> <span class=\"token constant\">COOKIE</span><span class=\"token punctuation\">)</span>\n  <span class=\"token function\">expect</span><span class=\"token punctuation\">(</span>res<span class=\"token punctuation\">.</span>body<span class=\"token punctuation\">.</span>errno<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">toBe</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token comment\">// 再次查询用户，应该不存在</span>\n<span class=\"token function\">test</span><span class=\"token punctuation\">(</span><span class=\"token string\">'删除之后，再次查询注册的用户名，应该不存在'</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">async</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span>\n  <span class=\"token keyword\">const</span> res <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> server<span class=\"token punctuation\">.</span><span class=\"token function\">post</span><span class=\"token punctuation\">(</span><span class=\"token string\">'/api/user/isExist'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">send</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">&#123;</span> userName <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span>\n  <span class=\"token function\">expect</span><span class=\"token punctuation\">(</span>res<span class=\"token punctuation\">.</span>body<span class=\"token punctuation\">.</span>errno<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>not<span class=\"token punctuation\">.</span><span class=\"token function\">toBe</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n","categories":[{"name":"慕课网","path":"api/categories/慕课网.json"},{"name":"Koa2","path":"api/categories/Koa2.json"}],"tags":[{"name":"koa2","path":"api/tags/koa2.json"}]}