{"title":"十、从零模拟新浪微博-首页","slug":"日常学习/技术相关/Koa2/慕课网-微博/10. 从零模拟新浪微博-首页","date":"2020-12-20T00:11:00.000Z","updated":"2022-02-21T04:45:27.392Z","comments":true,"path":"api/articles/日常学习/技术相关/Koa2/慕课网-微博/10. 从零模拟新浪微博-首页.json","excerpt":null,"covers":null,"content":"<p>代码仓库：<a href=\"https://github.com/changeclass/koa2-weibo\">https://github.com/changeclass/koa2-weibo</a></p>\n<h2 id=\"数据关联\"><a class=\"markdownIt-Anchor\" href=\"#数据关联\"></a> 数据关联</h2>\n<pre class=\"line-numbers language-javascript\" data-language=\"javascript\"><code class=\"language-javascript\">Blog<span class=\"token punctuation\">.</span><span class=\"token function\">belongsTo</span><span class=\"token punctuation\">(</span>UserRelation<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">&#123;</span>\n  foreignKey<span class=\"token operator\">:</span> <span class=\"token string\">'userId'</span><span class=\"token punctuation\">,</span>\n  targetKey<span class=\"token operator\">:</span> <span class=\"token string\">'followerId'</span>\n<span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span></span></code></pre>\n<blockquote>\n<p>此关系不会建立成功，因为此关系在数据库中已经被使用了，但是作为<code>sequlize</code>是可以使用此关系的。</p>\n</blockquote>\n<h2 id=\"自己关注自己\"><a class=\"markdownIt-Anchor\" href=\"#自己关注自己\"></a> 自己关注自己</h2>\n<p>创建完用户就应该自己关注自己，为了方便获取数据。</p>\n<p>在创建用户时只需要调用<code>addFollow</code>函数即可。但是为了在首页不显示自己。还需要在获取关注/粉丝列表时进行限制</p>\n<pre class=\"line-numbers language-javascript\" data-language=\"javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">const</span> Sequelize <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'sequelize'</span><span class=\"token punctuation\">)</span>\n<span class=\"token comment\">/**\n * @author: 小康\n * @url: https://xiaokang.me\n * @param &#123;*&#125; userId\n * @description: 获取关注人列表\n */</span>\n<span class=\"token keyword\">async</span> <span class=\"token keyword\">function</span> <span class=\"token function\">getFollowerByUser</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">userId</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n  <span class=\"token keyword\">const</span> result <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> UserRelation<span class=\"token punctuation\">.</span><span class=\"token function\">findAndCountAll</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">&#123;</span>\n    order<span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">[</span><span class=\"token string\">'id'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'desc'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n    include<span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span>\n      <span class=\"token punctuation\">&#123;</span>\n        model<span class=\"token operator\">:</span> User<span class=\"token punctuation\">,</span>\n        attributes<span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token string\">'id'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'userName'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'nickName'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'picture'</span><span class=\"token punctuation\">]</span>\n      <span class=\"token punctuation\">&#125;</span>\n    <span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n    where<span class=\"token operator\">:</span> <span class=\"token punctuation\">&#123;</span>\n      userId<span class=\"token punctuation\">,</span>\n      userId<span class=\"token operator\">:</span> <span class=\"token punctuation\">&#123;</span>\n        <span class=\"token punctuation\">[</span>Sequelize<span class=\"token punctuation\">.</span>Op<span class=\"token punctuation\">.</span>ne<span class=\"token punctuation\">]</span><span class=\"token operator\">:</span> userId\n      <span class=\"token punctuation\">&#125;</span>\n    <span class=\"token punctuation\">&#125;</span>\n  <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span>\n  <span class=\"token keyword\">let</span> userList <span class=\"token operator\">=</span> result<span class=\"token punctuation\">.</span>rows<span class=\"token punctuation\">.</span><span class=\"token function\">map</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">row</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> row<span class=\"token punctuation\">.</span>dataValues<span class=\"token punctuation\">)</span>\n  userList <span class=\"token operator\">=</span> userList<span class=\"token punctuation\">.</span><span class=\"token function\">map</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">item</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span>\n    <span class=\"token keyword\">let</span> user <span class=\"token operator\">=</span> item<span class=\"token punctuation\">.</span>user\n    user <span class=\"token operator\">=</span> user<span class=\"token punctuation\">.</span>dataValues\n    user <span class=\"token operator\">=</span> <span class=\"token function\">formatUser</span><span class=\"token punctuation\">(</span>user<span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">return</span> user\n  <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span>\n\n  <span class=\"token keyword\">return</span> <span class=\"token punctuation\">&#123;</span>\n    count<span class=\"token operator\">:</span> result<span class=\"token punctuation\">.</span>count<span class=\"token punctuation\">,</span>\n    userList\n  <span class=\"token punctuation\">&#125;</span>\n<span class=\"token punctuation\">&#125;</span>\n\n<span class=\"token comment\">/**\n * @author: 小康\n * @url: https://xiaokang.me\n * @param &#123;number&#125; followerId 被关注人的ID\n * @description: 获取关注该用户的用户列表\n */</span>\n<span class=\"token keyword\">async</span> <span class=\"token keyword\">function</span> <span class=\"token function\">getUsersByFollower</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">followerId</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n  <span class=\"token keyword\">const</span> result <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> User<span class=\"token punctuation\">.</span><span class=\"token function\">findAndCountAll</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">&#123;</span>\n    attributes<span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token string\">'id'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'userName'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'nickName'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'picture'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n    order<span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">[</span><span class=\"token string\">'id'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'desc'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n    include<span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span>\n      <span class=\"token punctuation\">&#123;</span>\n        model<span class=\"token operator\">:</span> UserRelation<span class=\"token punctuation\">,</span>\n        where<span class=\"token operator\">:</span> <span class=\"token punctuation\">&#123;</span>\n          followerId<span class=\"token punctuation\">,</span>\n          userId<span class=\"token operator\">:</span> <span class=\"token punctuation\">&#123;</span>\n            <span class=\"token punctuation\">[</span>Sequelize<span class=\"token punctuation\">.</span>Op<span class=\"token punctuation\">.</span>ne<span class=\"token punctuation\">]</span><span class=\"token operator\">:</span> followerId\n          <span class=\"token punctuation\">&#125;</span>\n        <span class=\"token punctuation\">&#125;</span>\n      <span class=\"token punctuation\">&#125;</span>\n    <span class=\"token punctuation\">]</span>\n  <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span>\n  <span class=\"token comment\">// 格式化</span>\n  <span class=\"token keyword\">let</span> userList <span class=\"token operator\">=</span> result<span class=\"token punctuation\">.</span>rows<span class=\"token punctuation\">.</span><span class=\"token function\">map</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">row</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> row<span class=\"token punctuation\">.</span>dataValues<span class=\"token punctuation\">)</span>\n  userList <span class=\"token operator\">=</span> <span class=\"token function\">formatUser</span><span class=\"token punctuation\">(</span>userList<span class=\"token punctuation\">)</span>\n  <span class=\"token keyword\">return</span> <span class=\"token punctuation\">&#123;</span> count<span class=\"token operator\">:</span> result<span class=\"token punctuation\">.</span>count<span class=\"token punctuation\">,</span> userList <span class=\"token punctuation\">&#125;</span>\n<span class=\"token punctuation\">&#125;</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n","more":"<p>代码仓库：<a href=\"https://github.com/changeclass/koa2-weibo\">https://github.com/changeclass/koa2-weibo</a></p>\n<h2 id=\"数据关联\"><a class=\"markdownIt-Anchor\" href=\"#数据关联\"></a> 数据关联</h2>\n<pre class=\"line-numbers language-javascript\" data-language=\"javascript\"><code class=\"language-javascript\">Blog<span class=\"token punctuation\">.</span><span class=\"token function\">belongsTo</span><span class=\"token punctuation\">(</span>UserRelation<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">&#123;</span>\n  foreignKey<span class=\"token operator\">:</span> <span class=\"token string\">'userId'</span><span class=\"token punctuation\">,</span>\n  targetKey<span class=\"token operator\">:</span> <span class=\"token string\">'followerId'</span>\n<span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span></span></code></pre>\n<blockquote>\n<p>此关系不会建立成功，因为此关系在数据库中已经被使用了，但是作为<code>sequlize</code>是可以使用此关系的。</p>\n</blockquote>\n<h2 id=\"自己关注自己\"><a class=\"markdownIt-Anchor\" href=\"#自己关注自己\"></a> 自己关注自己</h2>\n<p>创建完用户就应该自己关注自己，为了方便获取数据。</p>\n<p>在创建用户时只需要调用<code>addFollow</code>函数即可。但是为了在首页不显示自己。还需要在获取关注/粉丝列表时进行限制</p>\n<pre class=\"line-numbers language-javascript\" data-language=\"javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">const</span> Sequelize <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'sequelize'</span><span class=\"token punctuation\">)</span>\n<span class=\"token comment\">/**\n * @author: 小康\n * @url: https://xiaokang.me\n * @param &#123;*&#125; userId\n * @description: 获取关注人列表\n */</span>\n<span class=\"token keyword\">async</span> <span class=\"token keyword\">function</span> <span class=\"token function\">getFollowerByUser</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">userId</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n  <span class=\"token keyword\">const</span> result <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> UserRelation<span class=\"token punctuation\">.</span><span class=\"token function\">findAndCountAll</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">&#123;</span>\n    order<span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">[</span><span class=\"token string\">'id'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'desc'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n    include<span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span>\n      <span class=\"token punctuation\">&#123;</span>\n        model<span class=\"token operator\">:</span> User<span class=\"token punctuation\">,</span>\n        attributes<span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token string\">'id'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'userName'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'nickName'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'picture'</span><span class=\"token punctuation\">]</span>\n      <span class=\"token punctuation\">&#125;</span>\n    <span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n    where<span class=\"token operator\">:</span> <span class=\"token punctuation\">&#123;</span>\n      userId<span class=\"token punctuation\">,</span>\n      userId<span class=\"token operator\">:</span> <span class=\"token punctuation\">&#123;</span>\n        <span class=\"token punctuation\">[</span>Sequelize<span class=\"token punctuation\">.</span>Op<span class=\"token punctuation\">.</span>ne<span class=\"token punctuation\">]</span><span class=\"token operator\">:</span> userId\n      <span class=\"token punctuation\">&#125;</span>\n    <span class=\"token punctuation\">&#125;</span>\n  <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span>\n  <span class=\"token keyword\">let</span> userList <span class=\"token operator\">=</span> result<span class=\"token punctuation\">.</span>rows<span class=\"token punctuation\">.</span><span class=\"token function\">map</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">row</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> row<span class=\"token punctuation\">.</span>dataValues<span class=\"token punctuation\">)</span>\n  userList <span class=\"token operator\">=</span> userList<span class=\"token punctuation\">.</span><span class=\"token function\">map</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">item</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span>\n    <span class=\"token keyword\">let</span> user <span class=\"token operator\">=</span> item<span class=\"token punctuation\">.</span>user\n    user <span class=\"token operator\">=</span> user<span class=\"token punctuation\">.</span>dataValues\n    user <span class=\"token operator\">=</span> <span class=\"token function\">formatUser</span><span class=\"token punctuation\">(</span>user<span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">return</span> user\n  <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span>\n\n  <span class=\"token keyword\">return</span> <span class=\"token punctuation\">&#123;</span>\n    count<span class=\"token operator\">:</span> result<span class=\"token punctuation\">.</span>count<span class=\"token punctuation\">,</span>\n    userList\n  <span class=\"token punctuation\">&#125;</span>\n<span class=\"token punctuation\">&#125;</span>\n\n<span class=\"token comment\">/**\n * @author: 小康\n * @url: https://xiaokang.me\n * @param &#123;number&#125; followerId 被关注人的ID\n * @description: 获取关注该用户的用户列表\n */</span>\n<span class=\"token keyword\">async</span> <span class=\"token keyword\">function</span> <span class=\"token function\">getUsersByFollower</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">followerId</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n  <span class=\"token keyword\">const</span> result <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> User<span class=\"token punctuation\">.</span><span class=\"token function\">findAndCountAll</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">&#123;</span>\n    attributes<span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token string\">'id'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'userName'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'nickName'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'picture'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n    order<span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">[</span><span class=\"token string\">'id'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'desc'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n    include<span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span>\n      <span class=\"token punctuation\">&#123;</span>\n        model<span class=\"token operator\">:</span> UserRelation<span class=\"token punctuation\">,</span>\n        where<span class=\"token operator\">:</span> <span class=\"token punctuation\">&#123;</span>\n          followerId<span class=\"token punctuation\">,</span>\n          userId<span class=\"token operator\">:</span> <span class=\"token punctuation\">&#123;</span>\n            <span class=\"token punctuation\">[</span>Sequelize<span class=\"token punctuation\">.</span>Op<span class=\"token punctuation\">.</span>ne<span class=\"token punctuation\">]</span><span class=\"token operator\">:</span> followerId\n          <span class=\"token punctuation\">&#125;</span>\n        <span class=\"token punctuation\">&#125;</span>\n      <span class=\"token punctuation\">&#125;</span>\n    <span class=\"token punctuation\">]</span>\n  <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span>\n  <span class=\"token comment\">// 格式化</span>\n  <span class=\"token keyword\">let</span> userList <span class=\"token operator\">=</span> result<span class=\"token punctuation\">.</span>rows<span class=\"token punctuation\">.</span><span class=\"token function\">map</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">row</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> row<span class=\"token punctuation\">.</span>dataValues<span class=\"token punctuation\">)</span>\n  userList <span class=\"token operator\">=</span> <span class=\"token function\">formatUser</span><span class=\"token punctuation\">(</span>userList<span class=\"token punctuation\">)</span>\n  <span class=\"token keyword\">return</span> <span class=\"token punctuation\">&#123;</span> count<span class=\"token operator\">:</span> result<span class=\"token punctuation\">.</span>count<span class=\"token punctuation\">,</span> userList <span class=\"token punctuation\">&#125;</span>\n<span class=\"token punctuation\">&#125;</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n","categories":[{"name":"慕课网","path":"api/categories/慕课网.json"},{"name":"Koa2","path":"api/categories/Koa2.json"}],"tags":[{"name":"koa2","path":"api/tags/koa2.json"}]}