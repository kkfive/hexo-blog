{"title":"Github之Actions自动发布npm包","slug":"日常学习/部署与构建/Actions/GithubActions自动发布npm包","date":"2021-01-12T00:04:00.000Z","updated":"2021-01-18T11:22:00.000Z","comments":true,"path":"api/articles/日常学习/部署与构建/Actions/GithubActions自动发布npm包.json","excerpt":null,"covers":["https://rmt.ladydaily.com/fetch/tzk/storage/20210112082211.png?w=1280&amp;fmt=jpg","https://rmt.ladydaily.com/fetch/tzk/storage/20210112082232.png?w=1280&amp;fmt=jpg","https://rmt.ladydaily.com/fetch/tzk/storage/20210112082621.png?w=1280&amp;fmt=jpg"],"content":"<h2 id=\"前言\"><a class=\"markdownIt-Anchor\" href=\"#前言\"></a> 前言</h2>\n<p>在将我们的源代码推送到GitHub时并希望他能自动构建并将包发布到npm。</p>\n<p>其实做法也简单，大致思路：获取仓库源代码-&gt;安装插件-&gt;构建-&gt;推送</p>\n<h2 id=\"一-生成token\"><a class=\"markdownIt-Anchor\" href=\"#一-生成token\"></a> 一、生成TOKEN</h2>\n<p>这一步很重要，在<a href=\"https://www.npmjs.com/\">npm</a>中生成自己的TOKEN。TOKEN类型<strong>一定要选择Automation</strong>，生成后将其保存，因为一会儿要在GitHub密钥中填写这个值。</p>\n<p><img src=\"https://rmt.ladydaily.com/fetch/tzk/storage/20210112082211.png?w=1280&amp;fmt=jpg\" alt=\"image-20210112082211684\" /></p>\n<p><img src=\"https://rmt.ladydaily.com/fetch/tzk/storage/20210112082232.png?w=1280&amp;fmt=jpg\" alt=\"image-20210112082232783\" /></p>\n<h2 id=\"二-配置仓库secrets\"><a class=\"markdownIt-Anchor\" href=\"#二-配置仓库secrets\"></a> 二、配置仓库secrets</h2>\n<ol>\n<li>\n<p>进入你的代码仓库，单击设置</p>\n</li>\n<li>\n<p>点击<code>Secrets</code>，并新建一个键为<code>NPM_TOKEN</code>，值为上一步生成的TOKEN的密钥</p>\n<p><img src=\"https://rmt.ladydaily.com/fetch/tzk/storage/20210112082621.png?w=1280&amp;fmt=jpg\" alt=\"image-20210112082622903\" /></p>\n</li>\n</ol>\n<h2 id=\"三-编写构建配置\"><a class=\"markdownIt-Anchor\" href=\"#三-编写构建配置\"></a> 三、编写构建配置</h2>\n<pre class=\"line-numbers language-yml\" data-language=\"yml\"><code class=\"language-yml\"><span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> Node.js Package\n\n<span class=\"token key atrule\">on</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">push</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">branches</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> master\n\n<span class=\"token key atrule\">jobs</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">publish-npm</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">runs-on</span><span class=\"token punctuation\">:</span> ubuntu<span class=\"token punctuation\">-</span>latest\n    <span class=\"token key atrule\">strategy</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">matrix</span><span class=\"token punctuation\">:</span>\n        <span class=\"token key atrule\">node-version</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span>12.x<span class=\"token punctuation\">]</span>\n    <span class=\"token key atrule\">steps</span><span class=\"token punctuation\">:</span>\n      <span class=\"token comment\"># from: https://github.com/actions/checkout</span>\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> 1. 检查master分支\n        <span class=\"token key atrule\">uses</span><span class=\"token punctuation\">:</span> actions/checkout@master\n\n      <span class=\"token comment\"># from: https://github.com/actions/setup-node</span>\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> 2. 设置Node.js\n        <span class=\"token key atrule\">uses</span><span class=\"token punctuation\">:</span> actions/setup<span class=\"token punctuation\">-</span>node@master\n        <span class=\"token key atrule\">with</span><span class=\"token punctuation\">:</span>\n          <span class=\"token key atrule\">node-version</span><span class=\"token punctuation\">:</span> $<span class=\"token punctuation\">&#123;</span><span class=\"token punctuation\">&#123;</span> matrix.node<span class=\"token punctuation\">-</span>version <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">&#125;</span>\n      <span class=\"token comment\"># from: https://github.com/actions/cache</span>\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> 3. 缓存\n        <span class=\"token key atrule\">uses</span><span class=\"token punctuation\">:</span> actions/cache@v2\n        <span class=\"token key atrule\">id</span><span class=\"token punctuation\">:</span> cache<span class=\"token punctuation\">-</span>dependencies\n        <span class=\"token key atrule\">with</span><span class=\"token punctuation\">:</span>\n          <span class=\"token key atrule\">path</span><span class=\"token punctuation\">:</span> node_modules\n          <span class=\"token key atrule\">key</span><span class=\"token punctuation\">:</span> $<span class=\"token punctuation\">&#123;</span><span class=\"token punctuation\">&#123;</span>runner.OS<span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">-</span>$<span class=\"token punctuation\">&#123;</span><span class=\"token punctuation\">&#123;</span>hashFiles('<span class=\"token important\">**/package-lock.json')</span><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">&#125;</span>\n\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> 4. 安装插件\n        <span class=\"token key atrule\">if</span><span class=\"token punctuation\">:</span> steps.cache<span class=\"token punctuation\">-</span>dependencies.outputs.cache<span class=\"token punctuation\">-</span>hit <span class=\"token tag\">!=</span> 'true'\n        <span class=\"token key atrule\">run</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">|</span><span class=\"token scalar string\">\n          export TZ='Asia/Shanghai'\n          npm install</span>\n      \n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> 5. 生成文件\n        <span class=\"token key atrule\">run</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">|</span><span class=\"token scalar string\">\n          export TZ='Asia/Shanghai'\n          npm run build</span>\n      \n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> 6. 发布包\n        <span class=\"token key atrule\">run</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">|</span><span class=\"token scalar string\">\n          npm config set //registry.npmjs.org/:_authToken=$NPM_TOKEN\n          npm publish</span>\n        <span class=\"token key atrule\">env</span><span class=\"token punctuation\">:</span>\n          <span class=\"token key atrule\">NPM_TOKEN</span><span class=\"token punctuation\">:</span> $<span class=\"token punctuation\">&#123;</span><span class=\"token punctuation\">&#123;</span>secrets.NPM_TOKEN<span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">&#125;</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n<h2 id=\"完成\"><a class=\"markdownIt-Anchor\" href=\"#完成\"></a> 完成</h2>\n<p>此时当向<code>master</code>分支提交代码时就会自动触发构建任务并发布到npm</p>\n","more":"<h2 id=\"前言\"><a class=\"markdownIt-Anchor\" href=\"#前言\"></a> 前言</h2>\n<p>在将我们的源代码推送到GitHub时并希望他能自动构建并将包发布到npm。</p>\n<p>其实做法也简单，大致思路：获取仓库源代码-&gt;安装插件-&gt;构建-&gt;推送</p>\n<h2 id=\"一-生成token\"><a class=\"markdownIt-Anchor\" href=\"#一-生成token\"></a> 一、生成TOKEN</h2>\n<p>这一步很重要，在<a href=\"https://www.npmjs.com/\">npm</a>中生成自己的TOKEN。TOKEN类型<strong>一定要选择Automation</strong>，生成后将其保存，因为一会儿要在GitHub密钥中填写这个值。</p>\n<p><img src=\"https://rmt.ladydaily.com/fetch/tzk/storage/20210112082211.png?w=1280&amp;fmt=jpg\" alt=\"image-20210112082211684\" /></p>\n<p><img src=\"https://rmt.ladydaily.com/fetch/tzk/storage/20210112082232.png?w=1280&amp;fmt=jpg\" alt=\"image-20210112082232783\" /></p>\n<h2 id=\"二-配置仓库secrets\"><a class=\"markdownIt-Anchor\" href=\"#二-配置仓库secrets\"></a> 二、配置仓库secrets</h2>\n<ol>\n<li>\n<p>进入你的代码仓库，单击设置</p>\n</li>\n<li>\n<p>点击<code>Secrets</code>，并新建一个键为<code>NPM_TOKEN</code>，值为上一步生成的TOKEN的密钥</p>\n<p><img src=\"https://rmt.ladydaily.com/fetch/tzk/storage/20210112082621.png?w=1280&amp;fmt=jpg\" alt=\"image-20210112082622903\" /></p>\n</li>\n</ol>\n<h2 id=\"三-编写构建配置\"><a class=\"markdownIt-Anchor\" href=\"#三-编写构建配置\"></a> 三、编写构建配置</h2>\n<pre class=\"line-numbers language-yml\" data-language=\"yml\"><code class=\"language-yml\"><span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> Node.js Package\n\n<span class=\"token key atrule\">on</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">push</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">branches</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> master\n\n<span class=\"token key atrule\">jobs</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">publish-npm</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">runs-on</span><span class=\"token punctuation\">:</span> ubuntu<span class=\"token punctuation\">-</span>latest\n    <span class=\"token key atrule\">strategy</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">matrix</span><span class=\"token punctuation\">:</span>\n        <span class=\"token key atrule\">node-version</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span>12.x<span class=\"token punctuation\">]</span>\n    <span class=\"token key atrule\">steps</span><span class=\"token punctuation\">:</span>\n      <span class=\"token comment\"># from: https://github.com/actions/checkout</span>\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> 1. 检查master分支\n        <span class=\"token key atrule\">uses</span><span class=\"token punctuation\">:</span> actions/checkout@master\n\n      <span class=\"token comment\"># from: https://github.com/actions/setup-node</span>\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> 2. 设置Node.js\n        <span class=\"token key atrule\">uses</span><span class=\"token punctuation\">:</span> actions/setup<span class=\"token punctuation\">-</span>node@master\n        <span class=\"token key atrule\">with</span><span class=\"token punctuation\">:</span>\n          <span class=\"token key atrule\">node-version</span><span class=\"token punctuation\">:</span> $<span class=\"token punctuation\">&#123;</span><span class=\"token punctuation\">&#123;</span> matrix.node<span class=\"token punctuation\">-</span>version <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">&#125;</span>\n      <span class=\"token comment\"># from: https://github.com/actions/cache</span>\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> 3. 缓存\n        <span class=\"token key atrule\">uses</span><span class=\"token punctuation\">:</span> actions/cache@v2\n        <span class=\"token key atrule\">id</span><span class=\"token punctuation\">:</span> cache<span class=\"token punctuation\">-</span>dependencies\n        <span class=\"token key atrule\">with</span><span class=\"token punctuation\">:</span>\n          <span class=\"token key atrule\">path</span><span class=\"token punctuation\">:</span> node_modules\n          <span class=\"token key atrule\">key</span><span class=\"token punctuation\">:</span> $<span class=\"token punctuation\">&#123;</span><span class=\"token punctuation\">&#123;</span>runner.OS<span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">-</span>$<span class=\"token punctuation\">&#123;</span><span class=\"token punctuation\">&#123;</span>hashFiles('<span class=\"token important\">**/package-lock.json')</span><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">&#125;</span>\n\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> 4. 安装插件\n        <span class=\"token key atrule\">if</span><span class=\"token punctuation\">:</span> steps.cache<span class=\"token punctuation\">-</span>dependencies.outputs.cache<span class=\"token punctuation\">-</span>hit <span class=\"token tag\">!=</span> 'true'\n        <span class=\"token key atrule\">run</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">|</span><span class=\"token scalar string\">\n          export TZ='Asia/Shanghai'\n          npm install</span>\n      \n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> 5. 生成文件\n        <span class=\"token key atrule\">run</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">|</span><span class=\"token scalar string\">\n          export TZ='Asia/Shanghai'\n          npm run build</span>\n      \n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> 6. 发布包\n        <span class=\"token key atrule\">run</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">|</span><span class=\"token scalar string\">\n          npm config set //registry.npmjs.org/:_authToken=$NPM_TOKEN\n          npm publish</span>\n        <span class=\"token key atrule\">env</span><span class=\"token punctuation\">:</span>\n          <span class=\"token key atrule\">NPM_TOKEN</span><span class=\"token punctuation\">:</span> $<span class=\"token punctuation\">&#123;</span><span class=\"token punctuation\">&#123;</span>secrets.NPM_TOKEN<span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">&#125;</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n<h2 id=\"完成\"><a class=\"markdownIt-Anchor\" href=\"#完成\"></a> 完成</h2>\n<p>此时当向<code>master</code>分支提交代码时就会自动触发构建任务并发布到npm</p>\n","categories":[{"name":"Github","path":"api/categories/Github.json"}],"tags":[{"name":"Actions","path":"api/tags/Actions.json"}]}