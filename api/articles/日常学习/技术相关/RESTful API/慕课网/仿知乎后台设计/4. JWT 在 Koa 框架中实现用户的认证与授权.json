{"title":"四、JWT在Koa框架中实现用户的认证与授权","slug":"日常学习/技术相关/RESTful API/慕课网/仿知乎后台设计/4. JWT 在 Koa 框架中实现用户的认证与授权","date":"2020-11-23T06:03:26.000Z","updated":"2022-02-21T06:22:27.468Z","comments":true,"path":"api/articles/日常学习/技术相关/RESTful API/慕课网/仿知乎后台设计/4. JWT 在 Koa 框架中实现用户的认证与授权.json","excerpt":null,"covers":null,"content":"<h2 id=\"jwt是什么\"><a class=\"markdownIt-Anchor\" href=\"#jwt是什么\"></a> JWT是什么</h2>\n<ul>\n<li>JSON Web Token是一个开放标准（RFC7519)</li>\n<li>定义了一种紧凑且独立的方式，可以将各方之间的信息作为json对象进行安全传输</li>\n<li>该信息可以验证和信任，因为是经过数字签名的。</li>\n</ul>\n<h2 id=\"jwt的构成\"><a class=\"markdownIt-Anchor\" href=\"#jwt的构成\"></a> JWT的构成</h2>\n<ul>\n<li>\n<p>Header</p>\n<ul>\n<li>\n<p>typ</p>\n<p>TOKEN的类型，固定为JWT</p>\n</li>\n<li>\n<p>alg</p>\n<p>使用hash算法</p>\n</li>\n</ul>\n</li>\n<li>\n<p>Payload</p>\n<ul>\n<li>\n<p>存储需要传递的信息，如用户ID、用户名等</p>\n</li>\n<li>\n<p>还包含元数据，如过期时间、发布人等</p>\n</li>\n<li>\n<p>与 Header不同， Payload可以加密</p>\n</li>\n</ul>\n</li>\n<li>\n<p>Signature</p>\n<ul>\n<li>\n<p>对 Header和 Payload部分进行签名</p>\n</li>\n<li>\n<p>保证 Token在传输的过程中没有被篡改或者损坏</p>\n</li>\n</ul>\n</li>\n</ul>\n<h2 id=\"nodejs中使用jwt\"><a class=\"markdownIt-Anchor\" href=\"#nodejs中使用jwt\"></a> NodeJs中使用JWT</h2>\n<ol>\n<li>\n<p>安装<code>jsonwebtoken</code></p>\n<pre class=\"line-numbers language-bash\" data-language=\"bash\"><code class=\"language-bash\"><span class=\"token function\">yarn</span> <span class=\"token function\">add</span> jsonwebtoken<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n</li>\n<li>\n<p>使用</p>\n<pre class=\"line-numbers language-javascript\" data-language=\"javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">const</span> jsonwebtoken <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'jsonwebtoken'</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">const</span> token <span class=\"token operator\">=</span> jsonwebtoken<span class=\"token punctuation\">.</span><span class=\"token function\">sign</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">&#123;</span> _id<span class=\"token punctuation\">,</span> name <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span> secret<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">&#123;</span> expiresIn<span class=\"token operator\">:</span> <span class=\"token string\">\"1d\"</span> <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span></span></code></pre>\n<ul>\n<li>\n<p>第一个参数</p>\n<p>需要存放的信息</p>\n</li>\n<li>\n<p>第二个参数</p>\n<p>加密的密钥</p>\n</li>\n<li>\n<p>第三个参数</p>\n<p>过期时间</p>\n</li>\n</ul>\n</li>\n</ol>\n<h2 id=\"用户认证与授权\"><a class=\"markdownIt-Anchor\" href=\"#用户认证与授权\"></a> 用户认证与授权</h2>\n<h3 id=\"用户认证\"><a class=\"markdownIt-Anchor\" href=\"#用户认证\"></a> 用户认证</h3>\n<pre class=\"line-numbers language-javascript\" data-language=\"javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">const</span> jsonwebtoken <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'jsonwebtoken'</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">const</span> <span class=\"token function-variable function\">auth</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">async</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">ctx<span class=\"token punctuation\">,</span> next</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span>\n  <span class=\"token keyword\">const</span> <span class=\"token punctuation\">&#123;</span> authorization <span class=\"token operator\">=</span> <span class=\"token string\">''</span> <span class=\"token punctuation\">&#125;</span> <span class=\"token operator\">=</span> ctx<span class=\"token punctuation\">.</span>request<span class=\"token punctuation\">.</span>header\n  <span class=\"token keyword\">const</span> token <span class=\"token operator\">=</span> authorization<span class=\"token punctuation\">.</span><span class=\"token function\">replace</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Bearer \"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">''</span><span class=\"token punctuation\">)</span>\n  <span class=\"token keyword\">try</span> <span class=\"token punctuation\">&#123;</span>\n    <span class=\"token keyword\">const</span> user <span class=\"token operator\">=</span> jsonwebtoken<span class=\"token punctuation\">.</span><span class=\"token function\">verify</span><span class=\"token punctuation\">(</span>token<span class=\"token punctuation\">,</span> secret<span class=\"token punctuation\">)</span>\n    ctx<span class=\"token punctuation\">.</span>state<span class=\"token punctuation\">.</span>user <span class=\"token operator\">=</span> user\n  <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span>err<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n    ctx<span class=\"token punctuation\">.</span><span class=\"token function\">throw</span><span class=\"token punctuation\">(</span><span class=\"token number\">401</span><span class=\"token punctuation\">,</span> err<span class=\"token punctuation\">.</span>message<span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">&#125;</span>\n  <span class=\"token keyword\">await</span> <span class=\"token function\">next</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">&#125;</span>\n<span class=\"token comment\">// 在需要认证的路由中使用中间件</span>\nrouter<span class=\"token punctuation\">.</span><span class=\"token function\">patch</span><span class=\"token punctuation\">(</span><span class=\"token string\">'/:id'</span><span class=\"token punctuation\">,</span> auth<span class=\"token punctuation\">,</span> update<span class=\"token punctuation\">)</span>\nrouter<span class=\"token punctuation\">.</span><span class=\"token function\">delete</span><span class=\"token punctuation\">(</span><span class=\"token string\">'/:id'</span><span class=\"token punctuation\">,</span> auth<span class=\"token punctuation\">,</span> del<span class=\"token punctuation\">)</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n<h3 id=\"授权\"><a class=\"markdownIt-Anchor\" href=\"#授权\"></a> 授权</h3>\n<p>授权建立在认证的基础上。因此授权我们再写一个中间件。</p>\n<pre class=\"line-numbers language-javascript\" data-language=\"javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">async</span> <span class=\"token function\">checkOwner</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">ctx<span class=\"token punctuation\">,</span> next</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>ctx<span class=\"token punctuation\">.</span>params<span class=\"token punctuation\">.</span>id <span class=\"token operator\">!==</span> ctx<span class=\"token punctuation\">.</span>state<span class=\"token punctuation\">.</span>user<span class=\"token punctuation\">.</span>_id<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n        ctx<span class=\"token punctuation\">.</span><span class=\"token function\">throw</span><span class=\"token punctuation\">(</span><span class=\"token number\">403</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'你没有权限'</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">&#125;</span>\n    <span class=\"token keyword\">await</span> <span class=\"token function\">next</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">&#125;</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n<p>在认证中间件后继续引用。</p>\n<pre class=\"line-numbers language-javascript\" data-language=\"javascript\"><code class=\"language-javascript\">router<span class=\"token punctuation\">.</span><span class=\"token function\">patch</span><span class=\"token punctuation\">(</span><span class=\"token string\">'/:id'</span><span class=\"token punctuation\">,</span> auth<span class=\"token punctuation\">,</span> checkOwner<span class=\"token punctuation\">,</span> update<span class=\"token punctuation\">)</span>\nrouter<span class=\"token punctuation\">.</span><span class=\"token function\">delete</span><span class=\"token punctuation\">(</span><span class=\"token string\">'/:id'</span><span class=\"token punctuation\">,</span> auth<span class=\"token punctuation\">,</span> checkOwner<span class=\"token punctuation\">,</span> del<span class=\"token punctuation\">)</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span></span></code></pre>\n<h2 id=\"使用koa-jwt中间件实现用户认证与授权\"><a class=\"markdownIt-Anchor\" href=\"#使用koa-jwt中间件实现用户认证与授权\"></a> 使用koa-jwt中间件实现用户认证与授权</h2>\n<ol>\n<li>\n<p>安装koa-jwt</p>\n<pre class=\"line-numbers language-bash\" data-language=\"bash\"><code class=\"language-bash\"><span class=\"token function\">yarn</span> <span class=\"token function\">add</span> koa-jwt<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n</li>\n<li>\n<p>使用</p>\n<pre class=\"line-numbers language-javascript\" data-language=\"javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">const</span> jwt <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'koa-jwt'</span><span class=\"token punctuation\">)</span>\n<span class=\"token comment\">// 加密密钥</span>\n<span class=\"token keyword\">const</span> auth <span class=\"token operator\">=</span> <span class=\"token function\">jwt</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">&#123;</span> secret <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span></span></code></pre>\n</li>\n</ol>\n","more":"<h2 id=\"jwt是什么\"><a class=\"markdownIt-Anchor\" href=\"#jwt是什么\"></a> JWT是什么</h2>\n<ul>\n<li>JSON Web Token是一个开放标准（RFC7519)</li>\n<li>定义了一种紧凑且独立的方式，可以将各方之间的信息作为json对象进行安全传输</li>\n<li>该信息可以验证和信任，因为是经过数字签名的。</li>\n</ul>\n<h2 id=\"jwt的构成\"><a class=\"markdownIt-Anchor\" href=\"#jwt的构成\"></a> JWT的构成</h2>\n<ul>\n<li>\n<p>Header</p>\n<ul>\n<li>\n<p>typ</p>\n<p>TOKEN的类型，固定为JWT</p>\n</li>\n<li>\n<p>alg</p>\n<p>使用hash算法</p>\n</li>\n</ul>\n</li>\n<li>\n<p>Payload</p>\n<ul>\n<li>\n<p>存储需要传递的信息，如用户ID、用户名等</p>\n</li>\n<li>\n<p>还包含元数据，如过期时间、发布人等</p>\n</li>\n<li>\n<p>与 Header不同， Payload可以加密</p>\n</li>\n</ul>\n</li>\n<li>\n<p>Signature</p>\n<ul>\n<li>\n<p>对 Header和 Payload部分进行签名</p>\n</li>\n<li>\n<p>保证 Token在传输的过程中没有被篡改或者损坏</p>\n</li>\n</ul>\n</li>\n</ul>\n<h2 id=\"nodejs中使用jwt\"><a class=\"markdownIt-Anchor\" href=\"#nodejs中使用jwt\"></a> NodeJs中使用JWT</h2>\n<ol>\n<li>\n<p>安装<code>jsonwebtoken</code></p>\n<pre class=\"line-numbers language-bash\" data-language=\"bash\"><code class=\"language-bash\"><span class=\"token function\">yarn</span> <span class=\"token function\">add</span> jsonwebtoken<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n</li>\n<li>\n<p>使用</p>\n<pre class=\"line-numbers language-javascript\" data-language=\"javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">const</span> jsonwebtoken <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'jsonwebtoken'</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">const</span> token <span class=\"token operator\">=</span> jsonwebtoken<span class=\"token punctuation\">.</span><span class=\"token function\">sign</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">&#123;</span> _id<span class=\"token punctuation\">,</span> name <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span> secret<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">&#123;</span> expiresIn<span class=\"token operator\">:</span> <span class=\"token string\">\"1d\"</span> <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span></span></code></pre>\n<ul>\n<li>\n<p>第一个参数</p>\n<p>需要存放的信息</p>\n</li>\n<li>\n<p>第二个参数</p>\n<p>加密的密钥</p>\n</li>\n<li>\n<p>第三个参数</p>\n<p>过期时间</p>\n</li>\n</ul>\n</li>\n</ol>\n<h2 id=\"用户认证与授权\"><a class=\"markdownIt-Anchor\" href=\"#用户认证与授权\"></a> 用户认证与授权</h2>\n<h3 id=\"用户认证\"><a class=\"markdownIt-Anchor\" href=\"#用户认证\"></a> 用户认证</h3>\n<pre class=\"line-numbers language-javascript\" data-language=\"javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">const</span> jsonwebtoken <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'jsonwebtoken'</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">const</span> <span class=\"token function-variable function\">auth</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">async</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">ctx<span class=\"token punctuation\">,</span> next</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span>\n  <span class=\"token keyword\">const</span> <span class=\"token punctuation\">&#123;</span> authorization <span class=\"token operator\">=</span> <span class=\"token string\">''</span> <span class=\"token punctuation\">&#125;</span> <span class=\"token operator\">=</span> ctx<span class=\"token punctuation\">.</span>request<span class=\"token punctuation\">.</span>header\n  <span class=\"token keyword\">const</span> token <span class=\"token operator\">=</span> authorization<span class=\"token punctuation\">.</span><span class=\"token function\">replace</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Bearer \"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">''</span><span class=\"token punctuation\">)</span>\n  <span class=\"token keyword\">try</span> <span class=\"token punctuation\">&#123;</span>\n    <span class=\"token keyword\">const</span> user <span class=\"token operator\">=</span> jsonwebtoken<span class=\"token punctuation\">.</span><span class=\"token function\">verify</span><span class=\"token punctuation\">(</span>token<span class=\"token punctuation\">,</span> secret<span class=\"token punctuation\">)</span>\n    ctx<span class=\"token punctuation\">.</span>state<span class=\"token punctuation\">.</span>user <span class=\"token operator\">=</span> user\n  <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span>err<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n    ctx<span class=\"token punctuation\">.</span><span class=\"token function\">throw</span><span class=\"token punctuation\">(</span><span class=\"token number\">401</span><span class=\"token punctuation\">,</span> err<span class=\"token punctuation\">.</span>message<span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">&#125;</span>\n  <span class=\"token keyword\">await</span> <span class=\"token function\">next</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">&#125;</span>\n<span class=\"token comment\">// 在需要认证的路由中使用中间件</span>\nrouter<span class=\"token punctuation\">.</span><span class=\"token function\">patch</span><span class=\"token punctuation\">(</span><span class=\"token string\">'/:id'</span><span class=\"token punctuation\">,</span> auth<span class=\"token punctuation\">,</span> update<span class=\"token punctuation\">)</span>\nrouter<span class=\"token punctuation\">.</span><span class=\"token function\">delete</span><span class=\"token punctuation\">(</span><span class=\"token string\">'/:id'</span><span class=\"token punctuation\">,</span> auth<span class=\"token punctuation\">,</span> del<span class=\"token punctuation\">)</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n<h3 id=\"授权\"><a class=\"markdownIt-Anchor\" href=\"#授权\"></a> 授权</h3>\n<p>授权建立在认证的基础上。因此授权我们再写一个中间件。</p>\n<pre class=\"line-numbers language-javascript\" data-language=\"javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">async</span> <span class=\"token function\">checkOwner</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">ctx<span class=\"token punctuation\">,</span> next</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>ctx<span class=\"token punctuation\">.</span>params<span class=\"token punctuation\">.</span>id <span class=\"token operator\">!==</span> ctx<span class=\"token punctuation\">.</span>state<span class=\"token punctuation\">.</span>user<span class=\"token punctuation\">.</span>_id<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n        ctx<span class=\"token punctuation\">.</span><span class=\"token function\">throw</span><span class=\"token punctuation\">(</span><span class=\"token number\">403</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'你没有权限'</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">&#125;</span>\n    <span class=\"token keyword\">await</span> <span class=\"token function\">next</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">&#125;</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n<p>在认证中间件后继续引用。</p>\n<pre class=\"line-numbers language-javascript\" data-language=\"javascript\"><code class=\"language-javascript\">router<span class=\"token punctuation\">.</span><span class=\"token function\">patch</span><span class=\"token punctuation\">(</span><span class=\"token string\">'/:id'</span><span class=\"token punctuation\">,</span> auth<span class=\"token punctuation\">,</span> checkOwner<span class=\"token punctuation\">,</span> update<span class=\"token punctuation\">)</span>\nrouter<span class=\"token punctuation\">.</span><span class=\"token function\">delete</span><span class=\"token punctuation\">(</span><span class=\"token string\">'/:id'</span><span class=\"token punctuation\">,</span> auth<span class=\"token punctuation\">,</span> checkOwner<span class=\"token punctuation\">,</span> del<span class=\"token punctuation\">)</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span></span></code></pre>\n<h2 id=\"使用koa-jwt中间件实现用户认证与授权\"><a class=\"markdownIt-Anchor\" href=\"#使用koa-jwt中间件实现用户认证与授权\"></a> 使用koa-jwt中间件实现用户认证与授权</h2>\n<ol>\n<li>\n<p>安装koa-jwt</p>\n<pre class=\"line-numbers language-bash\" data-language=\"bash\"><code class=\"language-bash\"><span class=\"token function\">yarn</span> <span class=\"token function\">add</span> koa-jwt<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n</li>\n<li>\n<p>使用</p>\n<pre class=\"line-numbers language-javascript\" data-language=\"javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">const</span> jwt <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'koa-jwt'</span><span class=\"token punctuation\">)</span>\n<span class=\"token comment\">// 加密密钥</span>\n<span class=\"token keyword\">const</span> auth <span class=\"token operator\">=</span> <span class=\"token function\">jwt</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">&#123;</span> secret <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span></span></code></pre>\n</li>\n</ol>\n","categories":[{"name":"慕课网","path":"api/categories/慕课网.json"},{"name":"RESTful api","path":"api/categories/RESTful api.json"}],"tags":[{"name":"RESTful api","path":"api/tags/RESTful api.json"}]}