{"title":"七、从零模拟新浪微博-个人主页","slug":"日常学习/技术相关/Koa2/慕课网-微博/7. 从零模拟新浪微博-个人主页","date":"2020-12-19T00:38:00.000Z","updated":"2022-02-21T13:24:30.864Z","comments":true,"path":"api/articles/日常学习/技术相关/Koa2/慕课网-微博/7. 从零模拟新浪微博-个人主页.json","excerpt":null,"covers":null,"content":"<p>代码仓库：<a href=\"https://github.com/changeclass/koa2-weibo\">https://github.com/changeclass/koa2-weibo</a></p>\n<h2 id=\"用户数据\"><a class=\"markdownIt-Anchor\" href=\"#用户数据\"></a> 用户数据</h2>\n<ol>\n<li>\n<p>视图路由层</p>\n<pre class=\"line-numbers language-javascript\" data-language=\"javascript\"><code class=\"language-javascript\">router<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token string\">'/profile'</span><span class=\"token punctuation\">,</span> loginRedirect<span class=\"token punctuation\">,</span> <span class=\"token keyword\">async</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">ctx<span class=\"token punctuation\">,</span> next</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span>\n  <span class=\"token keyword\">const</span> <span class=\"token punctuation\">&#123;</span> userName <span class=\"token punctuation\">&#125;</span> <span class=\"token operator\">=</span> ctx<span class=\"token punctuation\">.</span>session<span class=\"token punctuation\">.</span>userInfo\n  ctx<span class=\"token punctuation\">.</span><span class=\"token function\">redirect</span><span class=\"token punctuation\">(</span><span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">/profile/</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">$&#123;</span>userName<span class=\"token interpolation-punctuation punctuation\">&#125;</span></span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span></span></code></pre>\n<blockquote>\n<p>当访问路由没有用户名时，默认跳转到自己用户名下。</p>\n</blockquote>\n<pre class=\"line-numbers language-javascript\" data-language=\"javascript\"><code class=\"language-javascript\">router<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token string\">'/profile/:userName'</span><span class=\"token punctuation\">,</span> loginRedirect<span class=\"token punctuation\">,</span> <span class=\"token keyword\">async</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">ctx<span class=\"token punctuation\">,</span> next</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span>\n  <span class=\"token keyword\">const</span> <span class=\"token punctuation\">&#123;</span> userName<span class=\"token operator\">:</span> curUserName <span class=\"token punctuation\">&#125;</span> <span class=\"token operator\">=</span> ctx<span class=\"token punctuation\">.</span>params\n  <span class=\"token comment\">// 获取微博第一页数据</span>\n  <span class=\"token comment\">// controller</span>\n  <span class=\"token keyword\">const</span> result <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> <span class=\"token function\">getProfileBlogList</span><span class=\"token punctuation\">(</span>curUserName<span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span>\n  <span class=\"token keyword\">const</span> <span class=\"token punctuation\">&#123;</span> isEmpty<span class=\"token punctuation\">,</span> blogList<span class=\"token punctuation\">,</span> pageSize<span class=\"token punctuation\">,</span> pageIndex<span class=\"token punctuation\">,</span> count <span class=\"token punctuation\">&#125;</span> <span class=\"token operator\">=</span> result<span class=\"token punctuation\">.</span>data\n  <span class=\"token keyword\">await</span> ctx<span class=\"token punctuation\">.</span><span class=\"token function\">render</span><span class=\"token punctuation\">(</span><span class=\"token string\">'profile'</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">&#123;</span>\n    blogData<span class=\"token operator\">:</span> <span class=\"token punctuation\">&#123;</span>\n      isEmpty<span class=\"token punctuation\">,</span>\n      blogList<span class=\"token punctuation\">,</span>\n      pageSize<span class=\"token punctuation\">,</span>\n      pageIndex<span class=\"token punctuation\">,</span>\n      count\n    <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span>\n    userData<span class=\"token operator\">:</span> <span class=\"token punctuation\">&#123;</span>\n      userInfo<span class=\"token operator\">:</span> ctx<span class=\"token punctuation\">.</span>session<span class=\"token punctuation\">.</span>userInfo<span class=\"token punctuation\">,</span>\n      fansData<span class=\"token operator\">:</span> <span class=\"token punctuation\">&#123;</span>\n        count<span class=\"token operator\">:</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span>\n        list<span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span>\n      <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span>\n      followersData<span class=\"token operator\">:</span> <span class=\"token punctuation\">&#123;</span>\n        count<span class=\"token operator\">:</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span>\n        list<span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span>\n      <span class=\"token punctuation\">&#125;</span>\n    <span class=\"token punctuation\">&#125;</span>\n  <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n</li>\n<li>\n<p>控制器层</p>\n<pre class=\"line-numbers language-javascript\" data-language=\"javascript\"><code class=\"language-javascript\"><span class=\"token comment\">/**\n * @description: 个人主页\n * @author: 小康\n * @url: https://xiaokang.me\n * @Date: 2020-12-19 09:47:36\n * @LastEditTime: 2020-12-19 09:47:36\n * @LastEditors: 小康\n */</span>\n\n<span class=\"token keyword\">const</span> <span class=\"token punctuation\">&#123;</span> getBlogListByUser <span class=\"token punctuation\">&#125;</span> <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'../services/blog'</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">const</span> <span class=\"token punctuation\">&#123;</span> <span class=\"token constant\">PAGE_SIZE</span> <span class=\"token punctuation\">&#125;</span> <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'../config/constant'</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">const</span> <span class=\"token punctuation\">&#123;</span> SuccessModel <span class=\"token punctuation\">&#125;</span> <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'../model/ResModel'</span><span class=\"token punctuation\">)</span>\n<span class=\"token comment\">/**\n * @author: 小康\n * @url: https://xiaokang.me\n * @param &#123;string&#125; userName 用户名\n * @param &#123;number&#125; pageIndex 当前页面索引 默认0\n * @description: 创建微博\n */</span>\n<span class=\"token keyword\">async</span> <span class=\"token keyword\">function</span> <span class=\"token function\">getProfileBlogList</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">userName<span class=\"token punctuation\">,</span> pageIndex <span class=\"token operator\">=</span> <span class=\"token number\">0</span></span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n  <span class=\"token keyword\">const</span> result <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> <span class=\"token function\">getBlogListByUser</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">&#123;</span> userName<span class=\"token punctuation\">,</span> pageIndex<span class=\"token punctuation\">,</span> <span class=\"token constant\">PAGE_SIZE</span> <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span>\n  <span class=\"token keyword\">const</span> blogList <span class=\"token operator\">=</span> result<span class=\"token punctuation\">.</span>blogList\n  <span class=\"token keyword\">return</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">SuccessModel</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">&#123;</span>\n    isEmpty<span class=\"token operator\">:</span> blogList<span class=\"token punctuation\">.</span>length <span class=\"token operator\">===</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span>\n    blogList<span class=\"token punctuation\">,</span>\n    pageSize<span class=\"token operator\">:</span> <span class=\"token constant\">PAGE_SIZE</span><span class=\"token punctuation\">,</span>\n    pageIndex<span class=\"token punctuation\">,</span>\n    count<span class=\"token operator\">:</span> result<span class=\"token punctuation\">.</span>count\n  <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">&#125;</span>\n\nmodule<span class=\"token punctuation\">.</span>exports <span class=\"token operator\">=</span> <span class=\"token punctuation\">&#123;</span> getProfileBlogList <span class=\"token punctuation\">&#125;</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n</li>\n<li>\n<p>服务层</p>\n<pre class=\"line-numbers language-javascript\" data-language=\"javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">const</span> <span class=\"token punctuation\">&#123;</span> Blog<span class=\"token punctuation\">,</span> User <span class=\"token punctuation\">&#125;</span> <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'../db/model/index'</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">const</span> <span class=\"token punctuation\">&#123;</span> formatUser <span class=\"token punctuation\">&#125;</span> <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'./_format'</span><span class=\"token punctuation\">)</span>\n<span class=\"token comment\">/**\n * @author: 小康\n * @url: https://xiaokang.me\n * @param &#123;*&#125; userName 用户名\n * @param &#123;*&#125; pageIndex 页面索引\n * @param &#123;*&#125; pageSize 页面大小\n * @description: 根据用户名查询微博\n */</span>\n<span class=\"token keyword\">async</span> <span class=\"token keyword\">function</span> <span class=\"token function\">getBlogListByUser</span><span class=\"token punctuation\">(</span><span class=\"token parameter\"><span class=\"token punctuation\">&#123;</span> userName<span class=\"token punctuation\">,</span> pageIndex <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> pageSize <span class=\"token operator\">=</span> <span class=\"token number\">10</span> <span class=\"token punctuation\">&#125;</span></span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n  <span class=\"token comment\">// 拼接查询条件</span>\n  <span class=\"token keyword\">const</span> userWhereOpts <span class=\"token operator\">=</span> <span class=\"token punctuation\">&#123;</span><span class=\"token punctuation\">&#125;</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>userName<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n    userWhereOpts<span class=\"token punctuation\">.</span>userName <span class=\"token operator\">=</span> userName\n  <span class=\"token punctuation\">&#125;</span>\n  <span class=\"token comment\">// 执行查询</span>\n  <span class=\"token keyword\">const</span> result <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> Blog<span class=\"token punctuation\">.</span><span class=\"token function\">findAndCountAll</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">&#123;</span>\n    limit<span class=\"token operator\">:</span> pageSize<span class=\"token punctuation\">,</span> <span class=\"token comment\">// 每页多少条</span>\n    offset<span class=\"token operator\">:</span> pageSize <span class=\"token operator\">*</span> pageIndex<span class=\"token punctuation\">,</span> <span class=\"token comment\">// 跳过多少条</span>\n    order<span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">[</span><span class=\"token string\">'id'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'desc'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n    include<span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span>\n      <span class=\"token punctuation\">&#123;</span>\n        model<span class=\"token operator\">:</span> User<span class=\"token punctuation\">,</span>\n        attributes<span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token string\">'userName'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'nickName'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'picture'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n        where<span class=\"token operator\">:</span> userWhereOpts\n      <span class=\"token punctuation\">&#125;</span>\n    <span class=\"token punctuation\">]</span>\n  <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span>\n  <span class=\"token comment\">// 获取dataValues</span>\n  <span class=\"token keyword\">let</span> blogList <span class=\"token operator\">=</span> result<span class=\"token punctuation\">.</span>rows<span class=\"token punctuation\">.</span><span class=\"token function\">map</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">row</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> row<span class=\"token punctuation\">.</span>dataValues<span class=\"token punctuation\">)</span>\n  blogList <span class=\"token operator\">=</span> blogList<span class=\"token punctuation\">.</span><span class=\"token function\">map</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">blogItem</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span>\n    <span class=\"token keyword\">const</span> user <span class=\"token operator\">=</span> blogItem<span class=\"token punctuation\">.</span>user<span class=\"token punctuation\">.</span>dataValues\n    blogItem<span class=\"token punctuation\">.</span>user <span class=\"token operator\">=</span> <span class=\"token function\">formatUser</span><span class=\"token punctuation\">(</span>user<span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">return</span> blogItem\n  <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span>\n  <span class=\"token keyword\">return</span> <span class=\"token punctuation\">&#123;</span>\n    count<span class=\"token operator\">:</span> result<span class=\"token punctuation\">.</span>count<span class=\"token punctuation\">,</span>\n    blogList\n  <span class=\"token punctuation\">&#125;</span>\n<span class=\"token punctuation\">&#125;</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n</li>\n</ol>\n<h2 id=\"格式化时间-用户数据\"><a class=\"markdownIt-Anchor\" href=\"#格式化时间-用户数据\"></a> 格式化时间、用户数据</h2>\n<p>用户数据主页是判断访问的用户是否存在。</p>\n<pre class=\"line-numbers language-javascript\" data-language=\"javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">const</span> <span class=\"token punctuation\">&#123;</span> isExist <span class=\"token punctuation\">&#125;</span> <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'../../controller/user'</span><span class=\"token punctuation\">)</span>\n\nrouter<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token string\">'/profile/:userName'</span><span class=\"token punctuation\">,</span> loginRedirect<span class=\"token punctuation\">,</span> <span class=\"token keyword\">async</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">ctx<span class=\"token punctuation\">,</span> next</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span>\n  <span class=\"token comment\">// 已登录用户的信息</span>\n  <span class=\"token keyword\">const</span> myUserInfo <span class=\"token operator\">=</span> ctx<span class=\"token punctuation\">.</span>session<span class=\"token punctuation\">.</span>userInfo\n  <span class=\"token keyword\">const</span> myUserName <span class=\"token operator\">=</span> myUserInfo<span class=\"token punctuation\">.</span>userName\n\n  <span class=\"token keyword\">let</span> curUserInfo\n  <span class=\"token keyword\">const</span> <span class=\"token punctuation\">&#123;</span> userName<span class=\"token operator\">:</span> curUserName <span class=\"token punctuation\">&#125;</span> <span class=\"token operator\">=</span> ctx<span class=\"token punctuation\">.</span>params\n  <span class=\"token keyword\">const</span> isMe <span class=\"token operator\">=</span> myUserName <span class=\"token operator\">===</span> curUserName\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>isMe<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n    <span class=\"token comment\">// 是当前登录用户</span>\n    curUserInfo <span class=\"token operator\">=</span> myUserInfo\n  <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">&#123;</span>\n    <span class=\"token comment\">// 不是当前登录用户</span>\n    <span class=\"token keyword\">const</span> existResult <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> <span class=\"token function\">isExist</span><span class=\"token punctuation\">(</span>curUserName<span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>existResult<span class=\"token punctuation\">.</span>errno <span class=\"token operator\">!==</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n      <span class=\"token comment\">// 用户名不存在</span>\n      <span class=\"token keyword\">return</span>\n    <span class=\"token punctuation\">&#125;</span>\n    <span class=\"token comment\">// 用户名存在</span>\n    curUserInfo <span class=\"token operator\">=</span> existResult<span class=\"token punctuation\">.</span>data\n  <span class=\"token punctuation\">&#125;</span>\n  <span class=\"token comment\">// ....</span>\n<span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n<p>格式化时间主要是格式化微博内容，处理在服务层。</p>\n<ol>\n<li><code>blog.js</code></li>\n</ol>\n<pre class=\"line-numbers language-javascript\" data-language=\"javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">const</span> <span class=\"token punctuation\">&#123;</span> formatUser<span class=\"token punctuation\">,</span> formatBlog <span class=\"token punctuation\">&#125;</span> <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'./_format'</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token comment\">// 获取dataValues</span>\n<span class=\"token keyword\">let</span> blogList <span class=\"token operator\">=</span> result<span class=\"token punctuation\">.</span>rows<span class=\"token punctuation\">.</span><span class=\"token function\">map</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">row</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> row<span class=\"token punctuation\">.</span>dataValues<span class=\"token punctuation\">)</span>\n\n<span class=\"token comment\">// 格式化</span>\nblogList <span class=\"token operator\">=</span> <span class=\"token function\">formatBlog</span><span class=\"token punctuation\">(</span>blogList<span class=\"token punctuation\">)</span>\nblogList <span class=\"token operator\">=</span> blogList<span class=\"token punctuation\">.</span><span class=\"token function\">map</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">blogItem</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span>\n  <span class=\"token keyword\">const</span> user <span class=\"token operator\">=</span> blogItem<span class=\"token punctuation\">.</span>user<span class=\"token punctuation\">.</span>dataValues\n  blogItem<span class=\"token punctuation\">.</span>user <span class=\"token operator\">=</span> <span class=\"token function\">formatUser</span><span class=\"token punctuation\">(</span>user<span class=\"token punctuation\">)</span>\n  <span class=\"token keyword\">return</span> blogItem\n<span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n<ol start=\"2\">\n<li><code>_format</code></li>\n</ol>\n<pre class=\"line-numbers language-javascript\" data-language=\"javascript\"><code class=\"language-javascript\"><span class=\"token comment\">/**\n * @description: 数据格式化\n * @author: 小康\n * @url: https://xiaokang.me\n * @Date: 2020-12-17 14:32:10\n * @LastEditTime: 2020-12-17 14:32:10\n * @LastEditors: 小康\n */</span>\n<span class=\"token keyword\">const</span> <span class=\"token punctuation\">&#123;</span> <span class=\"token constant\">DEFAULT_PICTURE</span><span class=\"token punctuation\">,</span> <span class=\"token constant\">REG_FOR_AT_WHO</span> <span class=\"token punctuation\">&#125;</span> <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'../config/constant'</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">const</span> <span class=\"token punctuation\">&#123;</span> timeFormat <span class=\"token punctuation\">&#125;</span> <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'../utils/dt'</span><span class=\"token punctuation\">)</span>\n<span class=\"token comment\">/**\n * 格式化头像\n * @author 小康\n * @date 2020-12-17\n * @param &#123;Object&#125; obj 用户对象\n * @returns &#123;Object&#125; 处理后的结果\n */</span>\n<span class=\"token keyword\">function</span> <span class=\"token function\">_formatUserPicture</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">obj</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>obj<span class=\"token punctuation\">.</span>picture <span class=\"token operator\">==</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n    obj<span class=\"token punctuation\">.</span>picture <span class=\"token operator\">=</span> <span class=\"token constant\">DEFAULT_PICTURE</span>\n  <span class=\"token punctuation\">&#125;</span>\n  <span class=\"token keyword\">return</span> obj\n<span class=\"token punctuation\">&#125;</span>\n\n<span class=\"token comment\">/**\n * 格式化用户\n * @author 小康\n * @date 2020-12-17\n * @param &#123;Array|Object&#125; list 用户列表或单个用户对象\n * @returns &#123;any&#125;\n */</span>\n<span class=\"token keyword\">function</span> <span class=\"token function\">formatUser</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">list</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>list <span class=\"token operator\">==</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n    <span class=\"token keyword\">return</span> list\n  <span class=\"token punctuation\">&#125;</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>list <span class=\"token keyword\">instanceof</span> <span class=\"token class-name\">Array</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n    <span class=\"token comment\">// 数组 用户列表</span>\n    <span class=\"token keyword\">return</span> list<span class=\"token punctuation\">.</span><span class=\"token function\">map</span><span class=\"token punctuation\">(</span>_formatUserPicture<span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">&#125;</span>\n  <span class=\"token comment\">// 单个对象</span>\n  <span class=\"token keyword\">let</span> result <span class=\"token operator\">=</span> list\n  result <span class=\"token operator\">=</span> <span class=\"token function\">_formatUserPicture</span><span class=\"token punctuation\">(</span>result<span class=\"token punctuation\">)</span>\n  <span class=\"token keyword\">return</span> result\n<span class=\"token punctuation\">&#125;</span>\n\n<span class=\"token comment\">/**\n * 格式化数据的时间\n * @param &#123;Object&#125; obj 数据\n */</span>\n<span class=\"token keyword\">function</span> <span class=\"token function\">_formatDBTime</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">obj</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n  obj<span class=\"token punctuation\">.</span>createdAtFormat <span class=\"token operator\">=</span> <span class=\"token function\">timeFormat</span><span class=\"token punctuation\">(</span>obj<span class=\"token punctuation\">.</span>createdAt<span class=\"token punctuation\">)</span>\n  obj<span class=\"token punctuation\">.</span>updatedAtFormat <span class=\"token operator\">=</span> <span class=\"token function\">timeFormat</span><span class=\"token punctuation\">(</span>obj<span class=\"token punctuation\">.</span>updatedAt<span class=\"token punctuation\">)</span>\n  <span class=\"token keyword\">return</span> obj\n<span class=\"token punctuation\">&#125;</span>\n\n<span class=\"token comment\">/**\n * 格式化微博内容\n * @param &#123;Object&#125; obj 微博数据对象\n */</span>\n<span class=\"token keyword\">function</span> <span class=\"token function\">_formatContent</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">obj</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n  obj<span class=\"token punctuation\">.</span>contentFormat <span class=\"token operator\">=</span> obj<span class=\"token punctuation\">.</span>content\n\n  <span class=\"token comment\">// 格式化 @</span>\n  <span class=\"token comment\">// from '哈喽 @张三 - zhangsan 你好'</span>\n  <span class=\"token comment\">// to '哈喽 &lt;a href=\"/profile/zhangsan\">张三&lt;/a> 你好'</span>\n  obj<span class=\"token punctuation\">.</span>contentFormat <span class=\"token operator\">=</span> obj<span class=\"token punctuation\">.</span>contentFormat<span class=\"token punctuation\">.</span><span class=\"token function\">replace</span><span class=\"token punctuation\">(</span>\n    <span class=\"token constant\">REG_FOR_AT_WHO</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">(</span><span class=\"token parameter\">matchStr<span class=\"token punctuation\">,</span> nickName<span class=\"token punctuation\">,</span> userName</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span>\n      <span class=\"token keyword\">return</span> <span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">&lt;a href=\"/profile/</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">$&#123;</span>userName<span class=\"token interpolation-punctuation punctuation\">&#125;</span></span><span class=\"token string\">\">@</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">$&#123;</span>nickName<span class=\"token interpolation-punctuation punctuation\">&#125;</span></span><span class=\"token string\">&lt;/a></span><span class=\"token template-punctuation string\">`</span></span>\n    <span class=\"token punctuation\">&#125;</span>\n  <span class=\"token punctuation\">)</span>\n\n  <span class=\"token keyword\">return</span> obj\n<span class=\"token punctuation\">&#125;</span>\n\n<span class=\"token comment\">/**\n * 格式化微博信息\n * @param &#123;Array|Object&#125; list 微博列表或者单个微博对象\n */</span>\n<span class=\"token keyword\">function</span> <span class=\"token function\">formatBlog</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">list</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>list <span class=\"token operator\">==</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n    <span class=\"token keyword\">return</span> list\n  <span class=\"token punctuation\">&#125;</span>\n\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>list <span class=\"token keyword\">instanceof</span> <span class=\"token class-name\">Array</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n    <span class=\"token comment\">// 数组</span>\n    <span class=\"token keyword\">return</span> list<span class=\"token punctuation\">.</span><span class=\"token function\">map</span><span class=\"token punctuation\">(</span>_formatDBTime<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">map</span><span class=\"token punctuation\">(</span>_formatContent<span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">&#125;</span>\n  <span class=\"token comment\">// 对象</span>\n  <span class=\"token keyword\">let</span> result <span class=\"token operator\">=</span> list\n  result <span class=\"token operator\">=</span> <span class=\"token function\">_formatDBTime</span><span class=\"token punctuation\">(</span>result<span class=\"token punctuation\">)</span>\n  result <span class=\"token operator\">=</span> <span class=\"token function\">_formatContent</span><span class=\"token punctuation\">(</span>result<span class=\"token punctuation\">)</span>\n  <span class=\"token keyword\">return</span> result\n<span class=\"token punctuation\">&#125;</span>\n\nmodule<span class=\"token punctuation\">.</span>exports <span class=\"token operator\">=</span> <span class=\"token punctuation\">&#123;</span> formatUser<span class=\"token punctuation\">,</span> formatBlog <span class=\"token punctuation\">&#125;</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n<ol start=\"3\">\n<li><code>dt.js</code></li>\n</ol>\n<pre class=\"line-numbers language-javascript\" data-language=\"javascript\"><code class=\"language-javascript\"><span class=\"token comment\">/**\n * @description:\n * @author: 小康\n * @url: https://xiaokang.me\n * @Date: 2020-12-19 10:54:11\n * @LastEditTime: 2020-12-19 10:54:12\n * @LastEditors: 小康\n */</span>\n\n<span class=\"token keyword\">const</span> <span class=\"token punctuation\">&#123;</span> format <span class=\"token punctuation\">&#125;</span> <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'date-fns'</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token comment\">/**\n * 格式化时间，如 09.05 23:02\n * @param &#123;string&#125; str 时间字符串\n */</span>\n<span class=\"token keyword\">function</span> <span class=\"token function\">timeFormat</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">str</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n  <span class=\"token keyword\">return</span> <span class=\"token function\">format</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">Date</span><span class=\"token punctuation\">(</span>str<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'MM.dd HH:mm'</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">&#125;</span>\n\nmodule<span class=\"token punctuation\">.</span>exports <span class=\"token operator\">=</span> <span class=\"token punctuation\">&#123;</span>\n  timeFormat\n<span class=\"token punctuation\">&#125;</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n<h2 id=\"加载更多\"><a class=\"markdownIt-Anchor\" href=\"#加载更多\"></a> 加载更多</h2>\n<ol>\n<li>\n<p><code>api</code>路由层</p>\n<pre class=\"line-numbers language-javascript\" data-language=\"javascript\"><code class=\"language-javascript\"><span class=\"token comment\">/**\n * @description: 个人主页 API 路由\n * @author: 小康\n * @url: https://xiaokang.me\n * @Date: 2020-12-19 11:20:02\n * @LastEditTime: 2020-12-19 11:20:02\n * @LastEditors: 小康\n */</span>\n\n<span class=\"token keyword\">const</span> router <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'koa-router'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token keyword\">const</span> <span class=\"token punctuation\">&#123;</span> getProfileBlogList <span class=\"token punctuation\">&#125;</span> <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'../../controller/blog-profile'</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">const</span> <span class=\"token punctuation\">&#123;</span> loginCheck <span class=\"token punctuation\">&#125;</span> <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'../../middlewares/loginChecks'</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">const</span> <span class=\"token punctuation\">&#123;</span> getBlogListStr <span class=\"token punctuation\">&#125;</span> <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'../../utils/blog'</span><span class=\"token punctuation\">)</span>\n\nrouter<span class=\"token punctuation\">.</span><span class=\"token function\">prefix</span><span class=\"token punctuation\">(</span><span class=\"token string\">'/api/profile'</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token comment\">// 加载更多</span>\nrouter<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token string\">'/loadMore/:userName/:pageIndex'</span><span class=\"token punctuation\">,</span> loginCheck<span class=\"token punctuation\">,</span> <span class=\"token keyword\">async</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">ctx<span class=\"token punctuation\">,</span> next</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span>\n  <span class=\"token keyword\">let</span> <span class=\"token punctuation\">&#123;</span> userName<span class=\"token punctuation\">,</span> pageIndex <span class=\"token punctuation\">&#125;</span> <span class=\"token operator\">=</span> ctx<span class=\"token punctuation\">.</span>params\n  pageIndex <span class=\"token operator\">=</span> <span class=\"token function\">parseInt</span><span class=\"token punctuation\">(</span>pageIndex<span class=\"token punctuation\">)</span>\n  <span class=\"token keyword\">const</span> result <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> <span class=\"token function\">getProfileBlogList</span><span class=\"token punctuation\">(</span>userName<span class=\"token punctuation\">,</span> pageIndex<span class=\"token punctuation\">)</span>\n  result<span class=\"token punctuation\">.</span>data<span class=\"token punctuation\">.</span>blogListTpl <span class=\"token operator\">=</span> <span class=\"token function\">getBlogListStr</span><span class=\"token punctuation\">(</span>result<span class=\"token punctuation\">.</span>data<span class=\"token punctuation\">.</span>blogList<span class=\"token punctuation\">)</span>\n  ctx<span class=\"token punctuation\">.</span>body <span class=\"token operator\">=</span> result\n<span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span>\n\nmodule<span class=\"token punctuation\">.</span>exports <span class=\"token operator\">=</span> router\n<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n</li>\n<li>\n<p>工具方法</p>\n<pre class=\"line-numbers language-javascript\" data-language=\"javascript\"><code class=\"language-javascript\"><span class=\"token comment\">/**\n * @description: 微博数据相关的工具方法\n * @author: 小康\n * @url: https://xiaokang.me\n * @Date: 2020-12-19 11:30:22\n * @LastEditTime: 2020-12-19 11:30:22\n * @LastEditors: 小康\n */</span>\n\n<span class=\"token keyword\">const</span> fs <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'fs'</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">const</span> path <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'path'</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">const</span> ejs <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'ejs'</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token comment\">// 获取 blog-list.ejs 文件内容</span>\n<span class=\"token keyword\">const</span> <span class=\"token constant\">BLOG_LIST_TPL</span> <span class=\"token operator\">=</span> fs\n  <span class=\"token punctuation\">.</span><span class=\"token function\">readFileSync</span><span class=\"token punctuation\">(</span>path<span class=\"token punctuation\">.</span><span class=\"token function\">join</span><span class=\"token punctuation\">(</span>__dirname<span class=\"token punctuation\">,</span> <span class=\"token string\">'..'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'views'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'widgets'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'blog-list.ejs'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">.</span><span class=\"token function\">toString</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token comment\">/**\n * @author: 小康\n * @url: https://xiaokang.me\n * @param &#123;Array&#125; blogList 微博列表\n * @param &#123;Boolean&#125; canReply 是否可以回复\n * @description: 根据blogList渲染出HTML字符串\n */</span>\n<span class=\"token keyword\">function</span> <span class=\"token function\">getBlogListStr</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">blogList <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> canReply <span class=\"token operator\">=</span> <span class=\"token boolean\">false</span></span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n  <span class=\"token keyword\">return</span> ejs<span class=\"token punctuation\">.</span><span class=\"token function\">render</span><span class=\"token punctuation\">(</span><span class=\"token constant\">BLOG_LIST_TPL</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">&#123;</span>\n    blogList<span class=\"token punctuation\">,</span>\n    canReply\n  <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">&#125;</span>\n\nmodule<span class=\"token punctuation\">.</span>exports <span class=\"token operator\">=</span> <span class=\"token punctuation\">&#123;</span> getBlogListStr <span class=\"token punctuation\">&#125;</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n</li>\n</ol>\n","more":"<p>代码仓库：<a href=\"https://github.com/changeclass/koa2-weibo\">https://github.com/changeclass/koa2-weibo</a></p>\n<h2 id=\"用户数据\"><a class=\"markdownIt-Anchor\" href=\"#用户数据\"></a> 用户数据</h2>\n<ol>\n<li>\n<p>视图路由层</p>\n<pre class=\"line-numbers language-javascript\" data-language=\"javascript\"><code class=\"language-javascript\">router<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token string\">'/profile'</span><span class=\"token punctuation\">,</span> loginRedirect<span class=\"token punctuation\">,</span> <span class=\"token keyword\">async</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">ctx<span class=\"token punctuation\">,</span> next</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span>\n  <span class=\"token keyword\">const</span> <span class=\"token punctuation\">&#123;</span> userName <span class=\"token punctuation\">&#125;</span> <span class=\"token operator\">=</span> ctx<span class=\"token punctuation\">.</span>session<span class=\"token punctuation\">.</span>userInfo\n  ctx<span class=\"token punctuation\">.</span><span class=\"token function\">redirect</span><span class=\"token punctuation\">(</span><span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">/profile/</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">$&#123;</span>userName<span class=\"token interpolation-punctuation punctuation\">&#125;</span></span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span></span></code></pre>\n<blockquote>\n<p>当访问路由没有用户名时，默认跳转到自己用户名下。</p>\n</blockquote>\n<pre class=\"line-numbers language-javascript\" data-language=\"javascript\"><code class=\"language-javascript\">router<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token string\">'/profile/:userName'</span><span class=\"token punctuation\">,</span> loginRedirect<span class=\"token punctuation\">,</span> <span class=\"token keyword\">async</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">ctx<span class=\"token punctuation\">,</span> next</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span>\n  <span class=\"token keyword\">const</span> <span class=\"token punctuation\">&#123;</span> userName<span class=\"token operator\">:</span> curUserName <span class=\"token punctuation\">&#125;</span> <span class=\"token operator\">=</span> ctx<span class=\"token punctuation\">.</span>params\n  <span class=\"token comment\">// 获取微博第一页数据</span>\n  <span class=\"token comment\">// controller</span>\n  <span class=\"token keyword\">const</span> result <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> <span class=\"token function\">getProfileBlogList</span><span class=\"token punctuation\">(</span>curUserName<span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span>\n  <span class=\"token keyword\">const</span> <span class=\"token punctuation\">&#123;</span> isEmpty<span class=\"token punctuation\">,</span> blogList<span class=\"token punctuation\">,</span> pageSize<span class=\"token punctuation\">,</span> pageIndex<span class=\"token punctuation\">,</span> count <span class=\"token punctuation\">&#125;</span> <span class=\"token operator\">=</span> result<span class=\"token punctuation\">.</span>data\n  <span class=\"token keyword\">await</span> ctx<span class=\"token punctuation\">.</span><span class=\"token function\">render</span><span class=\"token punctuation\">(</span><span class=\"token string\">'profile'</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">&#123;</span>\n    blogData<span class=\"token operator\">:</span> <span class=\"token punctuation\">&#123;</span>\n      isEmpty<span class=\"token punctuation\">,</span>\n      blogList<span class=\"token punctuation\">,</span>\n      pageSize<span class=\"token punctuation\">,</span>\n      pageIndex<span class=\"token punctuation\">,</span>\n      count\n    <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span>\n    userData<span class=\"token operator\">:</span> <span class=\"token punctuation\">&#123;</span>\n      userInfo<span class=\"token operator\">:</span> ctx<span class=\"token punctuation\">.</span>session<span class=\"token punctuation\">.</span>userInfo<span class=\"token punctuation\">,</span>\n      fansData<span class=\"token operator\">:</span> <span class=\"token punctuation\">&#123;</span>\n        count<span class=\"token operator\">:</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span>\n        list<span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span>\n      <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span>\n      followersData<span class=\"token operator\">:</span> <span class=\"token punctuation\">&#123;</span>\n        count<span class=\"token operator\">:</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span>\n        list<span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span>\n      <span class=\"token punctuation\">&#125;</span>\n    <span class=\"token punctuation\">&#125;</span>\n  <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n</li>\n<li>\n<p>控制器层</p>\n<pre class=\"line-numbers language-javascript\" data-language=\"javascript\"><code class=\"language-javascript\"><span class=\"token comment\">/**\n * @description: 个人主页\n * @author: 小康\n * @url: https://xiaokang.me\n * @Date: 2020-12-19 09:47:36\n * @LastEditTime: 2020-12-19 09:47:36\n * @LastEditors: 小康\n */</span>\n\n<span class=\"token keyword\">const</span> <span class=\"token punctuation\">&#123;</span> getBlogListByUser <span class=\"token punctuation\">&#125;</span> <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'../services/blog'</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">const</span> <span class=\"token punctuation\">&#123;</span> <span class=\"token constant\">PAGE_SIZE</span> <span class=\"token punctuation\">&#125;</span> <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'../config/constant'</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">const</span> <span class=\"token punctuation\">&#123;</span> SuccessModel <span class=\"token punctuation\">&#125;</span> <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'../model/ResModel'</span><span class=\"token punctuation\">)</span>\n<span class=\"token comment\">/**\n * @author: 小康\n * @url: https://xiaokang.me\n * @param &#123;string&#125; userName 用户名\n * @param &#123;number&#125; pageIndex 当前页面索引 默认0\n * @description: 创建微博\n */</span>\n<span class=\"token keyword\">async</span> <span class=\"token keyword\">function</span> <span class=\"token function\">getProfileBlogList</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">userName<span class=\"token punctuation\">,</span> pageIndex <span class=\"token operator\">=</span> <span class=\"token number\">0</span></span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n  <span class=\"token keyword\">const</span> result <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> <span class=\"token function\">getBlogListByUser</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">&#123;</span> userName<span class=\"token punctuation\">,</span> pageIndex<span class=\"token punctuation\">,</span> <span class=\"token constant\">PAGE_SIZE</span> <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span>\n  <span class=\"token keyword\">const</span> blogList <span class=\"token operator\">=</span> result<span class=\"token punctuation\">.</span>blogList\n  <span class=\"token keyword\">return</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">SuccessModel</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">&#123;</span>\n    isEmpty<span class=\"token operator\">:</span> blogList<span class=\"token punctuation\">.</span>length <span class=\"token operator\">===</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span>\n    blogList<span class=\"token punctuation\">,</span>\n    pageSize<span class=\"token operator\">:</span> <span class=\"token constant\">PAGE_SIZE</span><span class=\"token punctuation\">,</span>\n    pageIndex<span class=\"token punctuation\">,</span>\n    count<span class=\"token operator\">:</span> result<span class=\"token punctuation\">.</span>count\n  <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">&#125;</span>\n\nmodule<span class=\"token punctuation\">.</span>exports <span class=\"token operator\">=</span> <span class=\"token punctuation\">&#123;</span> getProfileBlogList <span class=\"token punctuation\">&#125;</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n</li>\n<li>\n<p>服务层</p>\n<pre class=\"line-numbers language-javascript\" data-language=\"javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">const</span> <span class=\"token punctuation\">&#123;</span> Blog<span class=\"token punctuation\">,</span> User <span class=\"token punctuation\">&#125;</span> <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'../db/model/index'</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">const</span> <span class=\"token punctuation\">&#123;</span> formatUser <span class=\"token punctuation\">&#125;</span> <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'./_format'</span><span class=\"token punctuation\">)</span>\n<span class=\"token comment\">/**\n * @author: 小康\n * @url: https://xiaokang.me\n * @param &#123;*&#125; userName 用户名\n * @param &#123;*&#125; pageIndex 页面索引\n * @param &#123;*&#125; pageSize 页面大小\n * @description: 根据用户名查询微博\n */</span>\n<span class=\"token keyword\">async</span> <span class=\"token keyword\">function</span> <span class=\"token function\">getBlogListByUser</span><span class=\"token punctuation\">(</span><span class=\"token parameter\"><span class=\"token punctuation\">&#123;</span> userName<span class=\"token punctuation\">,</span> pageIndex <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> pageSize <span class=\"token operator\">=</span> <span class=\"token number\">10</span> <span class=\"token punctuation\">&#125;</span></span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n  <span class=\"token comment\">// 拼接查询条件</span>\n  <span class=\"token keyword\">const</span> userWhereOpts <span class=\"token operator\">=</span> <span class=\"token punctuation\">&#123;</span><span class=\"token punctuation\">&#125;</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>userName<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n    userWhereOpts<span class=\"token punctuation\">.</span>userName <span class=\"token operator\">=</span> userName\n  <span class=\"token punctuation\">&#125;</span>\n  <span class=\"token comment\">// 执行查询</span>\n  <span class=\"token keyword\">const</span> result <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> Blog<span class=\"token punctuation\">.</span><span class=\"token function\">findAndCountAll</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">&#123;</span>\n    limit<span class=\"token operator\">:</span> pageSize<span class=\"token punctuation\">,</span> <span class=\"token comment\">// 每页多少条</span>\n    offset<span class=\"token operator\">:</span> pageSize <span class=\"token operator\">*</span> pageIndex<span class=\"token punctuation\">,</span> <span class=\"token comment\">// 跳过多少条</span>\n    order<span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">[</span><span class=\"token string\">'id'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'desc'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n    include<span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span>\n      <span class=\"token punctuation\">&#123;</span>\n        model<span class=\"token operator\">:</span> User<span class=\"token punctuation\">,</span>\n        attributes<span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token string\">'userName'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'nickName'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'picture'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n        where<span class=\"token operator\">:</span> userWhereOpts\n      <span class=\"token punctuation\">&#125;</span>\n    <span class=\"token punctuation\">]</span>\n  <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span>\n  <span class=\"token comment\">// 获取dataValues</span>\n  <span class=\"token keyword\">let</span> blogList <span class=\"token operator\">=</span> result<span class=\"token punctuation\">.</span>rows<span class=\"token punctuation\">.</span><span class=\"token function\">map</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">row</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> row<span class=\"token punctuation\">.</span>dataValues<span class=\"token punctuation\">)</span>\n  blogList <span class=\"token operator\">=</span> blogList<span class=\"token punctuation\">.</span><span class=\"token function\">map</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">blogItem</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span>\n    <span class=\"token keyword\">const</span> user <span class=\"token operator\">=</span> blogItem<span class=\"token punctuation\">.</span>user<span class=\"token punctuation\">.</span>dataValues\n    blogItem<span class=\"token punctuation\">.</span>user <span class=\"token operator\">=</span> <span class=\"token function\">formatUser</span><span class=\"token punctuation\">(</span>user<span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">return</span> blogItem\n  <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span>\n  <span class=\"token keyword\">return</span> <span class=\"token punctuation\">&#123;</span>\n    count<span class=\"token operator\">:</span> result<span class=\"token punctuation\">.</span>count<span class=\"token punctuation\">,</span>\n    blogList\n  <span class=\"token punctuation\">&#125;</span>\n<span class=\"token punctuation\">&#125;</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n</li>\n</ol>\n<h2 id=\"格式化时间-用户数据\"><a class=\"markdownIt-Anchor\" href=\"#格式化时间-用户数据\"></a> 格式化时间、用户数据</h2>\n<p>用户数据主页是判断访问的用户是否存在。</p>\n<pre class=\"line-numbers language-javascript\" data-language=\"javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">const</span> <span class=\"token punctuation\">&#123;</span> isExist <span class=\"token punctuation\">&#125;</span> <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'../../controller/user'</span><span class=\"token punctuation\">)</span>\n\nrouter<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token string\">'/profile/:userName'</span><span class=\"token punctuation\">,</span> loginRedirect<span class=\"token punctuation\">,</span> <span class=\"token keyword\">async</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">ctx<span class=\"token punctuation\">,</span> next</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span>\n  <span class=\"token comment\">// 已登录用户的信息</span>\n  <span class=\"token keyword\">const</span> myUserInfo <span class=\"token operator\">=</span> ctx<span class=\"token punctuation\">.</span>session<span class=\"token punctuation\">.</span>userInfo\n  <span class=\"token keyword\">const</span> myUserName <span class=\"token operator\">=</span> myUserInfo<span class=\"token punctuation\">.</span>userName\n\n  <span class=\"token keyword\">let</span> curUserInfo\n  <span class=\"token keyword\">const</span> <span class=\"token punctuation\">&#123;</span> userName<span class=\"token operator\">:</span> curUserName <span class=\"token punctuation\">&#125;</span> <span class=\"token operator\">=</span> ctx<span class=\"token punctuation\">.</span>params\n  <span class=\"token keyword\">const</span> isMe <span class=\"token operator\">=</span> myUserName <span class=\"token operator\">===</span> curUserName\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>isMe<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n    <span class=\"token comment\">// 是当前登录用户</span>\n    curUserInfo <span class=\"token operator\">=</span> myUserInfo\n  <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">&#123;</span>\n    <span class=\"token comment\">// 不是当前登录用户</span>\n    <span class=\"token keyword\">const</span> existResult <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> <span class=\"token function\">isExist</span><span class=\"token punctuation\">(</span>curUserName<span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>existResult<span class=\"token punctuation\">.</span>errno <span class=\"token operator\">!==</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n      <span class=\"token comment\">// 用户名不存在</span>\n      <span class=\"token keyword\">return</span>\n    <span class=\"token punctuation\">&#125;</span>\n    <span class=\"token comment\">// 用户名存在</span>\n    curUserInfo <span class=\"token operator\">=</span> existResult<span class=\"token punctuation\">.</span>data\n  <span class=\"token punctuation\">&#125;</span>\n  <span class=\"token comment\">// ....</span>\n<span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n<p>格式化时间主要是格式化微博内容，处理在服务层。</p>\n<ol>\n<li><code>blog.js</code></li>\n</ol>\n<pre class=\"line-numbers language-javascript\" data-language=\"javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">const</span> <span class=\"token punctuation\">&#123;</span> formatUser<span class=\"token punctuation\">,</span> formatBlog <span class=\"token punctuation\">&#125;</span> <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'./_format'</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token comment\">// 获取dataValues</span>\n<span class=\"token keyword\">let</span> blogList <span class=\"token operator\">=</span> result<span class=\"token punctuation\">.</span>rows<span class=\"token punctuation\">.</span><span class=\"token function\">map</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">row</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> row<span class=\"token punctuation\">.</span>dataValues<span class=\"token punctuation\">)</span>\n\n<span class=\"token comment\">// 格式化</span>\nblogList <span class=\"token operator\">=</span> <span class=\"token function\">formatBlog</span><span class=\"token punctuation\">(</span>blogList<span class=\"token punctuation\">)</span>\nblogList <span class=\"token operator\">=</span> blogList<span class=\"token punctuation\">.</span><span class=\"token function\">map</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">blogItem</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span>\n  <span class=\"token keyword\">const</span> user <span class=\"token operator\">=</span> blogItem<span class=\"token punctuation\">.</span>user<span class=\"token punctuation\">.</span>dataValues\n  blogItem<span class=\"token punctuation\">.</span>user <span class=\"token operator\">=</span> <span class=\"token function\">formatUser</span><span class=\"token punctuation\">(</span>user<span class=\"token punctuation\">)</span>\n  <span class=\"token keyword\">return</span> blogItem\n<span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n<ol start=\"2\">\n<li><code>_format</code></li>\n</ol>\n<pre class=\"line-numbers language-javascript\" data-language=\"javascript\"><code class=\"language-javascript\"><span class=\"token comment\">/**\n * @description: 数据格式化\n * @author: 小康\n * @url: https://xiaokang.me\n * @Date: 2020-12-17 14:32:10\n * @LastEditTime: 2020-12-17 14:32:10\n * @LastEditors: 小康\n */</span>\n<span class=\"token keyword\">const</span> <span class=\"token punctuation\">&#123;</span> <span class=\"token constant\">DEFAULT_PICTURE</span><span class=\"token punctuation\">,</span> <span class=\"token constant\">REG_FOR_AT_WHO</span> <span class=\"token punctuation\">&#125;</span> <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'../config/constant'</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">const</span> <span class=\"token punctuation\">&#123;</span> timeFormat <span class=\"token punctuation\">&#125;</span> <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'../utils/dt'</span><span class=\"token punctuation\">)</span>\n<span class=\"token comment\">/**\n * 格式化头像\n * @author 小康\n * @date 2020-12-17\n * @param &#123;Object&#125; obj 用户对象\n * @returns &#123;Object&#125; 处理后的结果\n */</span>\n<span class=\"token keyword\">function</span> <span class=\"token function\">_formatUserPicture</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">obj</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>obj<span class=\"token punctuation\">.</span>picture <span class=\"token operator\">==</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n    obj<span class=\"token punctuation\">.</span>picture <span class=\"token operator\">=</span> <span class=\"token constant\">DEFAULT_PICTURE</span>\n  <span class=\"token punctuation\">&#125;</span>\n  <span class=\"token keyword\">return</span> obj\n<span class=\"token punctuation\">&#125;</span>\n\n<span class=\"token comment\">/**\n * 格式化用户\n * @author 小康\n * @date 2020-12-17\n * @param &#123;Array|Object&#125; list 用户列表或单个用户对象\n * @returns &#123;any&#125;\n */</span>\n<span class=\"token keyword\">function</span> <span class=\"token function\">formatUser</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">list</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>list <span class=\"token operator\">==</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n    <span class=\"token keyword\">return</span> list\n  <span class=\"token punctuation\">&#125;</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>list <span class=\"token keyword\">instanceof</span> <span class=\"token class-name\">Array</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n    <span class=\"token comment\">// 数组 用户列表</span>\n    <span class=\"token keyword\">return</span> list<span class=\"token punctuation\">.</span><span class=\"token function\">map</span><span class=\"token punctuation\">(</span>_formatUserPicture<span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">&#125;</span>\n  <span class=\"token comment\">// 单个对象</span>\n  <span class=\"token keyword\">let</span> result <span class=\"token operator\">=</span> list\n  result <span class=\"token operator\">=</span> <span class=\"token function\">_formatUserPicture</span><span class=\"token punctuation\">(</span>result<span class=\"token punctuation\">)</span>\n  <span class=\"token keyword\">return</span> result\n<span class=\"token punctuation\">&#125;</span>\n\n<span class=\"token comment\">/**\n * 格式化数据的时间\n * @param &#123;Object&#125; obj 数据\n */</span>\n<span class=\"token keyword\">function</span> <span class=\"token function\">_formatDBTime</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">obj</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n  obj<span class=\"token punctuation\">.</span>createdAtFormat <span class=\"token operator\">=</span> <span class=\"token function\">timeFormat</span><span class=\"token punctuation\">(</span>obj<span class=\"token punctuation\">.</span>createdAt<span class=\"token punctuation\">)</span>\n  obj<span class=\"token punctuation\">.</span>updatedAtFormat <span class=\"token operator\">=</span> <span class=\"token function\">timeFormat</span><span class=\"token punctuation\">(</span>obj<span class=\"token punctuation\">.</span>updatedAt<span class=\"token punctuation\">)</span>\n  <span class=\"token keyword\">return</span> obj\n<span class=\"token punctuation\">&#125;</span>\n\n<span class=\"token comment\">/**\n * 格式化微博内容\n * @param &#123;Object&#125; obj 微博数据对象\n */</span>\n<span class=\"token keyword\">function</span> <span class=\"token function\">_formatContent</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">obj</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n  obj<span class=\"token punctuation\">.</span>contentFormat <span class=\"token operator\">=</span> obj<span class=\"token punctuation\">.</span>content\n\n  <span class=\"token comment\">// 格式化 @</span>\n  <span class=\"token comment\">// from '哈喽 @张三 - zhangsan 你好'</span>\n  <span class=\"token comment\">// to '哈喽 &lt;a href=\"/profile/zhangsan\">张三&lt;/a> 你好'</span>\n  obj<span class=\"token punctuation\">.</span>contentFormat <span class=\"token operator\">=</span> obj<span class=\"token punctuation\">.</span>contentFormat<span class=\"token punctuation\">.</span><span class=\"token function\">replace</span><span class=\"token punctuation\">(</span>\n    <span class=\"token constant\">REG_FOR_AT_WHO</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">(</span><span class=\"token parameter\">matchStr<span class=\"token punctuation\">,</span> nickName<span class=\"token punctuation\">,</span> userName</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span>\n      <span class=\"token keyword\">return</span> <span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">&lt;a href=\"/profile/</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">$&#123;</span>userName<span class=\"token interpolation-punctuation punctuation\">&#125;</span></span><span class=\"token string\">\">@</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">$&#123;</span>nickName<span class=\"token interpolation-punctuation punctuation\">&#125;</span></span><span class=\"token string\">&lt;/a></span><span class=\"token template-punctuation string\">`</span></span>\n    <span class=\"token punctuation\">&#125;</span>\n  <span class=\"token punctuation\">)</span>\n\n  <span class=\"token keyword\">return</span> obj\n<span class=\"token punctuation\">&#125;</span>\n\n<span class=\"token comment\">/**\n * 格式化微博信息\n * @param &#123;Array|Object&#125; list 微博列表或者单个微博对象\n */</span>\n<span class=\"token keyword\">function</span> <span class=\"token function\">formatBlog</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">list</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>list <span class=\"token operator\">==</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n    <span class=\"token keyword\">return</span> list\n  <span class=\"token punctuation\">&#125;</span>\n\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>list <span class=\"token keyword\">instanceof</span> <span class=\"token class-name\">Array</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n    <span class=\"token comment\">// 数组</span>\n    <span class=\"token keyword\">return</span> list<span class=\"token punctuation\">.</span><span class=\"token function\">map</span><span class=\"token punctuation\">(</span>_formatDBTime<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">map</span><span class=\"token punctuation\">(</span>_formatContent<span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">&#125;</span>\n  <span class=\"token comment\">// 对象</span>\n  <span class=\"token keyword\">let</span> result <span class=\"token operator\">=</span> list\n  result <span class=\"token operator\">=</span> <span class=\"token function\">_formatDBTime</span><span class=\"token punctuation\">(</span>result<span class=\"token punctuation\">)</span>\n  result <span class=\"token operator\">=</span> <span class=\"token function\">_formatContent</span><span class=\"token punctuation\">(</span>result<span class=\"token punctuation\">)</span>\n  <span class=\"token keyword\">return</span> result\n<span class=\"token punctuation\">&#125;</span>\n\nmodule<span class=\"token punctuation\">.</span>exports <span class=\"token operator\">=</span> <span class=\"token punctuation\">&#123;</span> formatUser<span class=\"token punctuation\">,</span> formatBlog <span class=\"token punctuation\">&#125;</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n<ol start=\"3\">\n<li><code>dt.js</code></li>\n</ol>\n<pre class=\"line-numbers language-javascript\" data-language=\"javascript\"><code class=\"language-javascript\"><span class=\"token comment\">/**\n * @description:\n * @author: 小康\n * @url: https://xiaokang.me\n * @Date: 2020-12-19 10:54:11\n * @LastEditTime: 2020-12-19 10:54:12\n * @LastEditors: 小康\n */</span>\n\n<span class=\"token keyword\">const</span> <span class=\"token punctuation\">&#123;</span> format <span class=\"token punctuation\">&#125;</span> <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'date-fns'</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token comment\">/**\n * 格式化时间，如 09.05 23:02\n * @param &#123;string&#125; str 时间字符串\n */</span>\n<span class=\"token keyword\">function</span> <span class=\"token function\">timeFormat</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">str</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n  <span class=\"token keyword\">return</span> <span class=\"token function\">format</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">Date</span><span class=\"token punctuation\">(</span>str<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'MM.dd HH:mm'</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">&#125;</span>\n\nmodule<span class=\"token punctuation\">.</span>exports <span class=\"token operator\">=</span> <span class=\"token punctuation\">&#123;</span>\n  timeFormat\n<span class=\"token punctuation\">&#125;</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n<h2 id=\"加载更多\"><a class=\"markdownIt-Anchor\" href=\"#加载更多\"></a> 加载更多</h2>\n<ol>\n<li>\n<p><code>api</code>路由层</p>\n<pre class=\"line-numbers language-javascript\" data-language=\"javascript\"><code class=\"language-javascript\"><span class=\"token comment\">/**\n * @description: 个人主页 API 路由\n * @author: 小康\n * @url: https://xiaokang.me\n * @Date: 2020-12-19 11:20:02\n * @LastEditTime: 2020-12-19 11:20:02\n * @LastEditors: 小康\n */</span>\n\n<span class=\"token keyword\">const</span> router <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'koa-router'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token keyword\">const</span> <span class=\"token punctuation\">&#123;</span> getProfileBlogList <span class=\"token punctuation\">&#125;</span> <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'../../controller/blog-profile'</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">const</span> <span class=\"token punctuation\">&#123;</span> loginCheck <span class=\"token punctuation\">&#125;</span> <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'../../middlewares/loginChecks'</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">const</span> <span class=\"token punctuation\">&#123;</span> getBlogListStr <span class=\"token punctuation\">&#125;</span> <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'../../utils/blog'</span><span class=\"token punctuation\">)</span>\n\nrouter<span class=\"token punctuation\">.</span><span class=\"token function\">prefix</span><span class=\"token punctuation\">(</span><span class=\"token string\">'/api/profile'</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token comment\">// 加载更多</span>\nrouter<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token string\">'/loadMore/:userName/:pageIndex'</span><span class=\"token punctuation\">,</span> loginCheck<span class=\"token punctuation\">,</span> <span class=\"token keyword\">async</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">ctx<span class=\"token punctuation\">,</span> next</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span>\n  <span class=\"token keyword\">let</span> <span class=\"token punctuation\">&#123;</span> userName<span class=\"token punctuation\">,</span> pageIndex <span class=\"token punctuation\">&#125;</span> <span class=\"token operator\">=</span> ctx<span class=\"token punctuation\">.</span>params\n  pageIndex <span class=\"token operator\">=</span> <span class=\"token function\">parseInt</span><span class=\"token punctuation\">(</span>pageIndex<span class=\"token punctuation\">)</span>\n  <span class=\"token keyword\">const</span> result <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> <span class=\"token function\">getProfileBlogList</span><span class=\"token punctuation\">(</span>userName<span class=\"token punctuation\">,</span> pageIndex<span class=\"token punctuation\">)</span>\n  result<span class=\"token punctuation\">.</span>data<span class=\"token punctuation\">.</span>blogListTpl <span class=\"token operator\">=</span> <span class=\"token function\">getBlogListStr</span><span class=\"token punctuation\">(</span>result<span class=\"token punctuation\">.</span>data<span class=\"token punctuation\">.</span>blogList<span class=\"token punctuation\">)</span>\n  ctx<span class=\"token punctuation\">.</span>body <span class=\"token operator\">=</span> result\n<span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span>\n\nmodule<span class=\"token punctuation\">.</span>exports <span class=\"token operator\">=</span> router\n<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n</li>\n<li>\n<p>工具方法</p>\n<pre class=\"line-numbers language-javascript\" data-language=\"javascript\"><code class=\"language-javascript\"><span class=\"token comment\">/**\n * @description: 微博数据相关的工具方法\n * @author: 小康\n * @url: https://xiaokang.me\n * @Date: 2020-12-19 11:30:22\n * @LastEditTime: 2020-12-19 11:30:22\n * @LastEditors: 小康\n */</span>\n\n<span class=\"token keyword\">const</span> fs <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'fs'</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">const</span> path <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'path'</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">const</span> ejs <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'ejs'</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token comment\">// 获取 blog-list.ejs 文件内容</span>\n<span class=\"token keyword\">const</span> <span class=\"token constant\">BLOG_LIST_TPL</span> <span class=\"token operator\">=</span> fs\n  <span class=\"token punctuation\">.</span><span class=\"token function\">readFileSync</span><span class=\"token punctuation\">(</span>path<span class=\"token punctuation\">.</span><span class=\"token function\">join</span><span class=\"token punctuation\">(</span>__dirname<span class=\"token punctuation\">,</span> <span class=\"token string\">'..'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'views'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'widgets'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'blog-list.ejs'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">.</span><span class=\"token function\">toString</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token comment\">/**\n * @author: 小康\n * @url: https://xiaokang.me\n * @param &#123;Array&#125; blogList 微博列表\n * @param &#123;Boolean&#125; canReply 是否可以回复\n * @description: 根据blogList渲染出HTML字符串\n */</span>\n<span class=\"token keyword\">function</span> <span class=\"token function\">getBlogListStr</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">blogList <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> canReply <span class=\"token operator\">=</span> <span class=\"token boolean\">false</span></span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n  <span class=\"token keyword\">return</span> ejs<span class=\"token punctuation\">.</span><span class=\"token function\">render</span><span class=\"token punctuation\">(</span><span class=\"token constant\">BLOG_LIST_TPL</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">&#123;</span>\n    blogList<span class=\"token punctuation\">,</span>\n    canReply\n  <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">&#125;</span>\n\nmodule<span class=\"token punctuation\">.</span>exports <span class=\"token operator\">=</span> <span class=\"token punctuation\">&#123;</span> getBlogListStr <span class=\"token punctuation\">&#125;</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n</li>\n</ol>\n","categories":[{"name":"慕课网","path":"api/categories/慕课网.json"},{"name":"Koa2","path":"api/categories/Koa2.json"}],"tags":[{"name":"koa2","path":"api/tags/koa2.json"}]}