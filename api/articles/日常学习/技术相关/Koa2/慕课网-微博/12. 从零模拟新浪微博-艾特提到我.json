{"title":"十二、从零模拟新浪微博-艾特提到我","slug":"日常学习/技术相关/Koa2/慕课网-微博/12. 从零模拟新浪微博-艾特提到我","date":"2020-12-20T03:03:00.000Z","updated":"2022-02-21T04:45:27.392Z","comments":true,"path":"api/articles/日常学习/技术相关/Koa2/慕课网-微博/12. 从零模拟新浪微博-艾特提到我.json","excerpt":null,"covers":null,"content":"<p>代码仓库：<a href=\"https://github.com/changeclass/koa2-weibo\">https://github.com/changeclass/koa2-weibo</a></p>\n<h2 id=\"修改数据模型\"><a class=\"markdownIt-Anchor\" href=\"#修改数据模型\"></a> 修改数据模型</h2>\n<pre class=\"line-numbers language-javascript\" data-language=\"javascript\"><code class=\"language-javascript\"><span class=\"token comment\">/**\n * @description: 微博艾特用户的关系\n * @author: 小康\n * @url: https://xiaokang.me\n * @Date: 2020-12-20 11:10:05\n * @LastEditTime: 2020-12-20 11:10:05\n * @LastEditors: 小康\n */</span>\n<span class=\"token keyword\">const</span> seq <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'../seq'</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">const</span> <span class=\"token punctuation\">&#123;</span> <span class=\"token constant\">INTEGER</span><span class=\"token punctuation\">,</span> <span class=\"token constant\">BOOLEAN</span> <span class=\"token punctuation\">&#125;</span> <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'../type'</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token keyword\">const</span> AtRelation <span class=\"token operator\">=</span> seq<span class=\"token punctuation\">.</span><span class=\"token function\">define</span><span class=\"token punctuation\">(</span><span class=\"token string\">'atRelation'</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">&#123;</span>\n  userId<span class=\"token operator\">:</span> <span class=\"token punctuation\">&#123;</span>\n    type<span class=\"token operator\">:</span> <span class=\"token constant\">INTEGER</span><span class=\"token punctuation\">,</span>\n    allowNull<span class=\"token operator\">:</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">,</span>\n    comment<span class=\"token operator\">:</span> <span class=\"token string\">'用户 id'</span>\n  <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span>\n  blogId<span class=\"token operator\">:</span> <span class=\"token punctuation\">&#123;</span>\n    type<span class=\"token operator\">:</span> <span class=\"token constant\">INTEGER</span><span class=\"token punctuation\">,</span>\n    allowNull<span class=\"token operator\">:</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">,</span>\n    comment<span class=\"token operator\">:</span> <span class=\"token string\">'微博 id'</span>\n  <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span>\n  isRead<span class=\"token operator\">:</span> <span class=\"token punctuation\">&#123;</span>\n    type<span class=\"token operator\">:</span> <span class=\"token constant\">BOOLEAN</span><span class=\"token punctuation\">,</span>\n    allowNull<span class=\"token operator\">:</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">,</span>\n    defaultValue<span class=\"token operator\">:</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">,</span>\n    comment<span class=\"token operator\">:</span> <span class=\"token string\">'是否已读'</span>\n  <span class=\"token punctuation\">&#125;</span>\n<span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span>\n\nmodule<span class=\"token punctuation\">.</span>exports <span class=\"token operator\">=</span> AtRelation\n<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n<p>入口文件</p>\n<pre class=\"line-numbers language-javascript\" data-language=\"javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">const</span> AtRelation <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'./AtRelation'</span><span class=\"token punctuation\">)</span>\n\nBlog<span class=\"token punctuation\">.</span><span class=\"token function\">hasMany</span><span class=\"token punctuation\">(</span>AtRelation<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">&#123;</span>\n  foreignKey<span class=\"token operator\">:</span> <span class=\"token string\">'blogId'</span>\n<span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span>\n<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n<h2 id=\"建立关系\"><a class=\"markdownIt-Anchor\" href=\"#建立关系\"></a> 建立@关系</h2>\n<p>修改创建微博时的逻辑，应该在创建微博时创建艾特关系</p>\n<pre class=\"line-numbers language-javascript\" data-language=\"javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">const</span> <span class=\"token punctuation\">&#123;</span> createAtReplation <span class=\"token punctuation\">&#125;</span> <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'../services/at-relation'</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">const</span> <span class=\"token punctuation\">&#123;</span> getUserInfo <span class=\"token punctuation\">&#125;</span> <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'../services/user'</span><span class=\"token punctuation\">)</span>\n<span class=\"token comment\">/**\n * @author: 小康\n * @url: https://xiaokang.me\n * @param &#123;string&#125; userId\n * @param &#123;string&#125; content\n * @param &#123;string&#125; image\n * @description: 创建微博\n */</span>\n<span class=\"token keyword\">async</span> <span class=\"token keyword\">function</span> <span class=\"token function\">create</span><span class=\"token punctuation\">(</span><span class=\"token parameter\"><span class=\"token punctuation\">&#123;</span> userId<span class=\"token punctuation\">,</span> content<span class=\"token punctuation\">,</span> image <span class=\"token punctuation\">&#125;</span></span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n  <span class=\"token comment\">// 分析并手机 content 中的@用户</span>\n  <span class=\"token comment\">// content格式</span>\n  <span class=\"token keyword\">const</span> atUserNameList <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span>\n  content <span class=\"token operator\">=</span> content<span class=\"token punctuation\">.</span><span class=\"token function\">replace</span><span class=\"token punctuation\">(</span><span class=\"token constant\">REG_FOR_AT_WHO</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">matchStr<span class=\"token punctuation\">,</span> nickName<span class=\"token punctuation\">,</span> userName</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span>\n    <span class=\"token comment\">// 目的是获取用户名</span>\n    atUserNameList<span class=\"token punctuation\">.</span><span class=\"token function\">push</span><span class=\"token punctuation\">(</span>userName<span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">return</span> matchStr <span class=\"token comment\">//替换不生效</span>\n  <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span>\n  <span class=\"token comment\">// 根据 @ 用户名查询用户信息</span>\n  <span class=\"token keyword\">const</span> atUserList <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> Promise<span class=\"token punctuation\">.</span><span class=\"token function\">all</span><span class=\"token punctuation\">(</span>\n    atUserNameList<span class=\"token punctuation\">.</span><span class=\"token function\">map</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">userName</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token function\">getUserInfo</span><span class=\"token punctuation\">(</span>userName<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">)</span>\n  <span class=\"token comment\">// 根据用户信息 获取id</span>\n  <span class=\"token keyword\">const</span> atUserIdList <span class=\"token operator\">=</span> atUserList<span class=\"token punctuation\">.</span><span class=\"token function\">map</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">user</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> user<span class=\"token punctuation\">.</span>id<span class=\"token punctuation\">)</span>\n  <span class=\"token comment\">// servers</span>\n  <span class=\"token keyword\">try</span> <span class=\"token punctuation\">&#123;</span>\n    <span class=\"token keyword\">const</span> blog <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> <span class=\"token function\">createBlog</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">&#123;</span> userId<span class=\"token punctuation\">,</span> content<span class=\"token operator\">:</span> <span class=\"token function\">xss</span><span class=\"token punctuation\">(</span>content<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> image <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span>\n    <span class=\"token comment\">// 创建at关系</span>\n    <span class=\"token keyword\">await</span> Promise<span class=\"token punctuation\">.</span><span class=\"token function\">all</span><span class=\"token punctuation\">(</span>\n      atUserIdList<span class=\"token punctuation\">.</span><span class=\"token function\">map</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">userId</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span>\n        <span class=\"token function\">createAtReplation</span><span class=\"token punctuation\">(</span>blog<span class=\"token punctuation\">.</span>id<span class=\"token punctuation\">,</span> userId<span class=\"token punctuation\">)</span>\n      <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">)</span>\n    <span class=\"token comment\">// 返回</span>\n    <span class=\"token keyword\">return</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">SuccessModel</span><span class=\"token punctuation\">(</span>blog<span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span>error<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n    console<span class=\"token punctuation\">.</span><span class=\"token function\">error</span><span class=\"token punctuation\">(</span>error<span class=\"token punctuation\">.</span>message<span class=\"token punctuation\">,</span> error<span class=\"token punctuation\">.</span>stack<span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">return</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">ErrorModel</span><span class=\"token punctuation\">(</span>createBlogFailInfo<span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">&#125;</span>\n<span class=\"token punctuation\">&#125;</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n<p>服务层</p>\n<pre class=\"line-numbers language-javascript\" data-language=\"javascript\"><code class=\"language-javascript\"><span class=\"token comment\">/**\n * @description: 微博 @ 用户关系\n * @author: 小康\n * @url: https://xiaokang.me\n * @Date: 2020-12-20 11:39:05\n * @LastEditTime: 2020-12-20 11:39:06\n * @LastEditors: 小康\n */</span>\n\n<span class=\"token keyword\">const</span> <span class=\"token punctuation\">&#123;</span> AtRelation <span class=\"token punctuation\">&#125;</span> <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'../db/model'</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token comment\">/**\n * @author: 小康\n * @url: https://xiaokang.me\n * @param &#123;*&#125; blogId\n * @param &#123;*&#125; userId\n * @description: 创建微博艾特用户的关系\n */</span>\n<span class=\"token keyword\">async</span> <span class=\"token keyword\">function</span> <span class=\"token function\">createAtReplation</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">blogId<span class=\"token punctuation\">,</span> userId</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n  <span class=\"token keyword\">const</span> result <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> AtRelation<span class=\"token punctuation\">.</span><span class=\"token function\">create</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">&#123;</span>\n    blogId<span class=\"token punctuation\">,</span>\n    userId\n  <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span>\n  <span class=\"token keyword\">return</span> result<span class=\"token punctuation\">.</span>dataValues\n<span class=\"token punctuation\">&#125;</span>\n\nmodule<span class=\"token punctuation\">.</span>exports <span class=\"token operator\">=</span> <span class=\"token punctuation\">&#123;</span> createAtReplation <span class=\"token punctuation\">&#125;</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n<h2 id=\"显示at数量\"><a class=\"markdownIt-Anchor\" href=\"#显示at数量\"></a> 显示at数量</h2>\n<ol>\n<li>\n<p>视图路由层</p>\n<pre class=\"line-numbers language-javascript\" data-language=\"javascript\"><code class=\"language-javascript\"><span class=\"token comment\">// 获取 @ 数量</span>\n<span class=\"token keyword\">const</span> atCount <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> <span class=\"token function\">getAtMeCount</span><span class=\"token punctuation\">(</span>userId<span class=\"token punctuation\">)</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span></span></code></pre>\n<p>只需要调用控制器层的方法获取数量即可。</p>\n</li>\n<li>\n<p>控制器层</p>\n<pre class=\"line-numbers language-javascript\" data-language=\"javascript\"><code class=\"language-javascript\"><span class=\"token comment\">/**\n * @description: 微博 @ 关系\n * @author: 小康\n * @url: https://xiaokang.me\n * @Date: 2020-12-20 14:10:21\n * @LastEditTime: 2020-12-20 14:10:23\n * @LastEditors: 小康\n */</span>\n\n<span class=\"token keyword\">const</span> <span class=\"token punctuation\">&#123;</span> getAtRelationCount <span class=\"token punctuation\">&#125;</span> <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'../services/at-relation'</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">const</span> <span class=\"token punctuation\">&#123;</span> SuccessModel <span class=\"token punctuation\">&#125;</span> <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'../model/ResModel'</span><span class=\"token punctuation\">)</span>\n<span class=\"token comment\">/**\n * @author: 小康\n * @url: https://xiaokang.me\n * @param &#123;*&#125; userId\n * @description: 获取 @ 我的微博数量\n */</span>\n<span class=\"token keyword\">async</span> <span class=\"token keyword\">function</span> <span class=\"token function\">getAtMeCount</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">userId</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n  <span class=\"token keyword\">const</span> count <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> <span class=\"token function\">getAtRelationCount</span><span class=\"token punctuation\">(</span>userId<span class=\"token punctuation\">)</span>\n  <span class=\"token keyword\">return</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">SuccessModel</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">&#123;</span> count <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">&#125;</span>\n\nmodule<span class=\"token punctuation\">.</span>exports <span class=\"token operator\">=</span> <span class=\"token punctuation\">&#123;</span>\n  getAtMeCount\n<span class=\"token punctuation\">&#125;</span>\n<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n</li>\n<li>\n<p>服务层</p>\n<pre class=\"line-numbers language-javascript\" data-language=\"javascript\"><code class=\"language-javascript\"><span class=\"token comment\">/**\n * @author: 小康\n * @url: https://xiaokang.me\n * @param &#123;*&#125; userId\n * @description: 获取at用户的微博数量（未读）\n */</span>\n<span class=\"token keyword\">async</span> <span class=\"token keyword\">function</span> <span class=\"token function\">getAtRelationCount</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">userId</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n  <span class=\"token keyword\">const</span> result <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> AtRelation<span class=\"token punctuation\">.</span><span class=\"token function\">findAndCountAll</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">&#123;</span>\n    where<span class=\"token operator\">:</span> <span class=\"token punctuation\">&#123;</span>\n      userId<span class=\"token punctuation\">,</span>\n      isRead<span class=\"token operator\">:</span> <span class=\"token boolean\">false</span>\n    <span class=\"token punctuation\">&#125;</span>\n  <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span>\n  <span class=\"token keyword\">return</span> result<span class=\"token punctuation\">.</span>count\n<span class=\"token punctuation\">&#125;</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n</li>\n</ol>\n<h2 id=\"me页面\"><a class=\"markdownIt-Anchor\" href=\"#me页面\"></a> @me页面</h2>\n<ol>\n<li>\n<p>视图路由层</p>\n<pre class=\"line-numbers language-javascript\" data-language=\"javascript\"><code class=\"language-javascript\"><span class=\"token comment\">// @ 我的页面</span>\nrouter<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token string\">'/at-me'</span><span class=\"token punctuation\">,</span> loginRedirect<span class=\"token punctuation\">,</span> <span class=\"token keyword\">async</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">ctx<span class=\"token punctuation\">,</span> next</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span>\n  <span class=\"token keyword\">const</span> <span class=\"token punctuation\">&#123;</span> id<span class=\"token operator\">:</span> userId <span class=\"token punctuation\">&#125;</span> <span class=\"token operator\">=</span> ctx<span class=\"token punctuation\">.</span>session<span class=\"token punctuation\">.</span>userInfo\n  <span class=\"token comment\">// 获取 @ 我的数量</span>\n  <span class=\"token keyword\">const</span> atCountResult <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> <span class=\"token function\">getAtMeCount</span><span class=\"token punctuation\">(</span>userId<span class=\"token punctuation\">)</span>\n  <span class=\"token keyword\">const</span> <span class=\"token punctuation\">&#123;</span> count<span class=\"token operator\">:</span> atCount <span class=\"token punctuation\">&#125;</span> <span class=\"token operator\">=</span> atCountResult<span class=\"token punctuation\">.</span>data\n  <span class=\"token comment\">// 获取第一页列表</span>\n  <span class=\"token keyword\">const</span> result <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> <span class=\"token function\">getAtMeBlogList</span><span class=\"token punctuation\">(</span>userId<span class=\"token punctuation\">)</span>\n  <span class=\"token keyword\">const</span> <span class=\"token punctuation\">&#123;</span> isEmpty<span class=\"token punctuation\">,</span> blogList<span class=\"token punctuation\">,</span> pageSize<span class=\"token punctuation\">,</span> pageIndex<span class=\"token punctuation\">,</span> count <span class=\"token punctuation\">&#125;</span> <span class=\"token operator\">=</span> result<span class=\"token punctuation\">.</span>data\n  <span class=\"token comment\">// 渲染页面</span>\n  <span class=\"token keyword\">await</span> ctx<span class=\"token punctuation\">.</span><span class=\"token function\">render</span><span class=\"token punctuation\">(</span><span class=\"token string\">'atMe'</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">&#123;</span>\n    blogData<span class=\"token operator\">:</span> <span class=\"token punctuation\">&#123;</span>\n      isEmpty<span class=\"token punctuation\">,</span>\n      blogList<span class=\"token punctuation\">,</span>\n      pageSize<span class=\"token punctuation\">,</span>\n      pageIndex<span class=\"token punctuation\">,</span>\n      count\n    <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span>\n    atCount\n  <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span>\n  <span class=\"token comment\">// 标记为已读</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>atCount <span class=\"token operator\">></span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n  <span class=\"token punctuation\">&#125;</span>\n<span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n</li>\n<li>\n<p>控制器层</p>\n<pre class=\"line-numbers language-javascript\" data-language=\"javascript\"><code class=\"language-javascript\"><span class=\"token comment\">/**\n * @author: 小康\n * @url: https://xiaokang.me\n * @param &#123;*&#125; userId\n * @param &#123;*&#125; pageIndex\n * @description: 获取@ 用户的微博列表\n */</span>\n<span class=\"token keyword\">async</span> <span class=\"token keyword\">function</span> <span class=\"token function\">getAtMeBlogList</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">userId<span class=\"token punctuation\">,</span> pageIndex <span class=\"token operator\">=</span> <span class=\"token number\">0</span></span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n  <span class=\"token comment\">// service</span>\n  <span class=\"token keyword\">const</span> result <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> <span class=\"token function\">getUserBlogList</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">&#123;</span>\n    userId<span class=\"token punctuation\">,</span>\n    pageIndex<span class=\"token punctuation\">,</span>\n    pageSize<span class=\"token operator\">:</span> <span class=\"token constant\">PAGE_SIZE</span>\n  <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span>\n  <span class=\"token keyword\">const</span> <span class=\"token punctuation\">&#123;</span> count<span class=\"token punctuation\">,</span> blogList <span class=\"token punctuation\">&#125;</span> <span class=\"token operator\">=</span> result\n\n  <span class=\"token comment\">// 返回</span>\n  <span class=\"token keyword\">return</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">SuccessModel</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">&#123;</span>\n    isEmpty<span class=\"token operator\">:</span> blogList<span class=\"token punctuation\">.</span>length <span class=\"token operator\">===</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span>\n    blogList<span class=\"token punctuation\">,</span>\n    pageSize<span class=\"token operator\">:</span> <span class=\"token constant\">PAGE_SIZE</span><span class=\"token punctuation\">,</span>\n    pageIndex<span class=\"token punctuation\">,</span>\n    count\n  <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">&#125;</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n</li>\n<li>\n<p>服务层</p>\n<pre class=\"line-numbers language-javascript\" data-language=\"javascript\"><code class=\"language-javascript\"><span class=\"token comment\">/**\n * @author: 小康\n * @url: https://xiaokang.me\n * @param &#123;*&#125; userId\n * @param &#123;*&#125; pageIndex\n * @param &#123;*&#125; pageSize\n * @description: 获取 @ 用户的微博列表\n */</span>\n<span class=\"token keyword\">async</span> <span class=\"token keyword\">function</span> <span class=\"token function\">getUserBlogList</span><span class=\"token punctuation\">(</span><span class=\"token parameter\"><span class=\"token punctuation\">&#123;</span> userId<span class=\"token punctuation\">,</span> pageIndex<span class=\"token punctuation\">,</span> pageSize <span class=\"token operator\">=</span> <span class=\"token constant\">PAGE_SIZE</span> <span class=\"token punctuation\">&#125;</span></span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n  <span class=\"token keyword\">const</span> result <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> Blog<span class=\"token punctuation\">.</span><span class=\"token function\">findAndCountAll</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">&#123;</span>\n    limit<span class=\"token operator\">:</span> pageSize<span class=\"token punctuation\">,</span>\n    offset<span class=\"token operator\">:</span> pageSize <span class=\"token operator\">*</span> pageIndex<span class=\"token punctuation\">,</span>\n    order<span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">[</span><span class=\"token string\">'id'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'desc'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n    include<span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span>\n      <span class=\"token comment\">// @ 关系</span>\n      <span class=\"token punctuation\">&#123;</span>\n        model<span class=\"token operator\">:</span> AtRelation<span class=\"token punctuation\">,</span>\n        attributes<span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token string\">'userId'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'blogId'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n        where<span class=\"token operator\">:</span> <span class=\"token punctuation\">&#123;</span> userId <span class=\"token punctuation\">&#125;</span>\n      <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span>\n      <span class=\"token comment\">// 用户</span>\n      <span class=\"token punctuation\">&#123;</span>\n        model<span class=\"token operator\">:</span> User<span class=\"token punctuation\">,</span>\n        attributes<span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token string\">'userName'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'nickName'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'picture'</span><span class=\"token punctuation\">]</span>\n      <span class=\"token punctuation\">&#125;</span>\n    <span class=\"token punctuation\">]</span>\n  <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span>\n  <span class=\"token keyword\">let</span> blogList <span class=\"token operator\">=</span> result<span class=\"token punctuation\">.</span>rows<span class=\"token punctuation\">.</span><span class=\"token function\">map</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">row</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> row<span class=\"token punctuation\">.</span>dataValues<span class=\"token punctuation\">)</span>\n  blogList <span class=\"token operator\">=</span> <span class=\"token function\">formatBlog</span><span class=\"token punctuation\">(</span>blogList<span class=\"token punctuation\">)</span>\n  blogList <span class=\"token operator\">=</span> blogList<span class=\"token punctuation\">.</span><span class=\"token function\">map</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">blogItem</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span>\n    blogItem<span class=\"token punctuation\">.</span>user <span class=\"token operator\">=</span> <span class=\"token function\">formatUser</span><span class=\"token punctuation\">(</span>blogItem<span class=\"token punctuation\">.</span>user<span class=\"token punctuation\">.</span>dataValues<span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">return</span> blogItem\n  <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span>\n  <span class=\"token keyword\">return</span> <span class=\"token punctuation\">&#123;</span>\n    count<span class=\"token operator\">:</span> result<span class=\"token punctuation\">.</span>count<span class=\"token punctuation\">,</span>\n    blogList\n  <span class=\"token punctuation\">&#125;</span>\n<span class=\"token punctuation\">&#125;</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n</li>\n</ol>\n<h2 id=\"消息已读\"><a class=\"markdownIt-Anchor\" href=\"#消息已读\"></a> @消息已读</h2>\n<ol>\n<li>\n<p>试图层</p>\n<p>试图层调用方法即可</p>\n<pre class=\"line-numbers language-javascript\" data-language=\"javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>atCount <span class=\"token operator\">></span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n  <span class=\"token function\">markAsRead</span><span class=\"token punctuation\">(</span>userId<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">&#125;</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span></span></code></pre>\n</li>\n<li>\n<p>控制层</p>\n<pre class=\"line-numbers language-javascript\" data-language=\"javascript\"><code class=\"language-javascript\"><span class=\"token comment\">/**\n * @author: 小康\n * @url: https://xiaokang.me\n * @param &#123;*&#125; userId\n * @description: 标记已读\n */</span>\n<span class=\"token keyword\">async</span> <span class=\"token keyword\">function</span> <span class=\"token function\">markAsRead</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">userId</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n  <span class=\"token keyword\">try</span> <span class=\"token punctuation\">&#123;</span>\n    <span class=\"token keyword\">await</span> <span class=\"token function\">updataAtRelation</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">&#123;</span> newIsRead<span class=\"token operator\">:</span> <span class=\"token boolean\">true</span> <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">&#123;</span> userId<span class=\"token punctuation\">,</span> isRead<span class=\"token operator\">:</span> <span class=\"token boolean\">false</span> <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span>error<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n    console<span class=\"token punctuation\">.</span><span class=\"token function\">error</span><span class=\"token punctuation\">(</span>error<span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">&#125;</span>\n  <span class=\"token comment\">// 不需要返回</span>\n<span class=\"token punctuation\">&#125;</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n</li>\n<li>\n<p>服务层</p>\n<pre class=\"line-numbers language-javascript\" data-language=\"javascript\"><code class=\"language-javascript\"><span class=\"token comment\">/**\n * @author: 小康\n * @url: https://xiaokang.me\n * @param &#123;Object&#125; 要更新的内容\n * @param &#123;Object&#125; 条件\n * @description: 更新数据\n */</span>\n<span class=\"token keyword\">async</span> <span class=\"token keyword\">function</span> <span class=\"token function\">updataAtRelation</span><span class=\"token punctuation\">(</span><span class=\"token parameter\"><span class=\"token punctuation\">&#123;</span> newIsRead <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">&#123;</span> userId<span class=\"token punctuation\">,</span> isRead <span class=\"token punctuation\">&#125;</span></span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n  <span class=\"token comment\">// 拼接更新内容</span>\n  <span class=\"token keyword\">const</span> updataData <span class=\"token operator\">=</span> <span class=\"token punctuation\">&#123;</span><span class=\"token punctuation\">&#125;</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>newIsRead<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n    updataData<span class=\"token punctuation\">.</span>isRead <span class=\"token operator\">=</span> newIsRead\n  <span class=\"token punctuation\">&#125;</span>\n  <span class=\"token comment\">// 拼接查询条件</span>\n  <span class=\"token keyword\">const</span> whereData <span class=\"token operator\">=</span> <span class=\"token punctuation\">&#123;</span><span class=\"token punctuation\">&#125;</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>userId<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n    whereData<span class=\"token punctuation\">.</span>userId <span class=\"token operator\">=</span> userId\n  <span class=\"token punctuation\">&#125;</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>isRead<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n    whereData<span class=\"token punctuation\">.</span>isRead <span class=\"token operator\">=</span> isRead\n  <span class=\"token punctuation\">&#125;</span>\n  <span class=\"token comment\">// 执行更新</span>\n  <span class=\"token keyword\">const</span> result <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> AtRelation<span class=\"token punctuation\">.</span><span class=\"token function\">update</span><span class=\"token punctuation\">(</span>updataData<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">&#123;</span>\n    where<span class=\"token operator\">:</span> whereData\n  <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span>\n  <span class=\"token keyword\">return</span> result<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">></span> <span class=\"token number\">0</span>\n<span class=\"token punctuation\">&#125;</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n</li>\n</ol>\n","more":"<p>代码仓库：<a href=\"https://github.com/changeclass/koa2-weibo\">https://github.com/changeclass/koa2-weibo</a></p>\n<h2 id=\"修改数据模型\"><a class=\"markdownIt-Anchor\" href=\"#修改数据模型\"></a> 修改数据模型</h2>\n<pre class=\"line-numbers language-javascript\" data-language=\"javascript\"><code class=\"language-javascript\"><span class=\"token comment\">/**\n * @description: 微博艾特用户的关系\n * @author: 小康\n * @url: https://xiaokang.me\n * @Date: 2020-12-20 11:10:05\n * @LastEditTime: 2020-12-20 11:10:05\n * @LastEditors: 小康\n */</span>\n<span class=\"token keyword\">const</span> seq <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'../seq'</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">const</span> <span class=\"token punctuation\">&#123;</span> <span class=\"token constant\">INTEGER</span><span class=\"token punctuation\">,</span> <span class=\"token constant\">BOOLEAN</span> <span class=\"token punctuation\">&#125;</span> <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'../type'</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token keyword\">const</span> AtRelation <span class=\"token operator\">=</span> seq<span class=\"token punctuation\">.</span><span class=\"token function\">define</span><span class=\"token punctuation\">(</span><span class=\"token string\">'atRelation'</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">&#123;</span>\n  userId<span class=\"token operator\">:</span> <span class=\"token punctuation\">&#123;</span>\n    type<span class=\"token operator\">:</span> <span class=\"token constant\">INTEGER</span><span class=\"token punctuation\">,</span>\n    allowNull<span class=\"token operator\">:</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">,</span>\n    comment<span class=\"token operator\">:</span> <span class=\"token string\">'用户 id'</span>\n  <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span>\n  blogId<span class=\"token operator\">:</span> <span class=\"token punctuation\">&#123;</span>\n    type<span class=\"token operator\">:</span> <span class=\"token constant\">INTEGER</span><span class=\"token punctuation\">,</span>\n    allowNull<span class=\"token operator\">:</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">,</span>\n    comment<span class=\"token operator\">:</span> <span class=\"token string\">'微博 id'</span>\n  <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span>\n  isRead<span class=\"token operator\">:</span> <span class=\"token punctuation\">&#123;</span>\n    type<span class=\"token operator\">:</span> <span class=\"token constant\">BOOLEAN</span><span class=\"token punctuation\">,</span>\n    allowNull<span class=\"token operator\">:</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">,</span>\n    defaultValue<span class=\"token operator\">:</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">,</span>\n    comment<span class=\"token operator\">:</span> <span class=\"token string\">'是否已读'</span>\n  <span class=\"token punctuation\">&#125;</span>\n<span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span>\n\nmodule<span class=\"token punctuation\">.</span>exports <span class=\"token operator\">=</span> AtRelation\n<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n<p>入口文件</p>\n<pre class=\"line-numbers language-javascript\" data-language=\"javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">const</span> AtRelation <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'./AtRelation'</span><span class=\"token punctuation\">)</span>\n\nBlog<span class=\"token punctuation\">.</span><span class=\"token function\">hasMany</span><span class=\"token punctuation\">(</span>AtRelation<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">&#123;</span>\n  foreignKey<span class=\"token operator\">:</span> <span class=\"token string\">'blogId'</span>\n<span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span>\n<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n<h2 id=\"建立关系\"><a class=\"markdownIt-Anchor\" href=\"#建立关系\"></a> 建立@关系</h2>\n<p>修改创建微博时的逻辑，应该在创建微博时创建艾特关系</p>\n<pre class=\"line-numbers language-javascript\" data-language=\"javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">const</span> <span class=\"token punctuation\">&#123;</span> createAtReplation <span class=\"token punctuation\">&#125;</span> <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'../services/at-relation'</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">const</span> <span class=\"token punctuation\">&#123;</span> getUserInfo <span class=\"token punctuation\">&#125;</span> <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'../services/user'</span><span class=\"token punctuation\">)</span>\n<span class=\"token comment\">/**\n * @author: 小康\n * @url: https://xiaokang.me\n * @param &#123;string&#125; userId\n * @param &#123;string&#125; content\n * @param &#123;string&#125; image\n * @description: 创建微博\n */</span>\n<span class=\"token keyword\">async</span> <span class=\"token keyword\">function</span> <span class=\"token function\">create</span><span class=\"token punctuation\">(</span><span class=\"token parameter\"><span class=\"token punctuation\">&#123;</span> userId<span class=\"token punctuation\">,</span> content<span class=\"token punctuation\">,</span> image <span class=\"token punctuation\">&#125;</span></span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n  <span class=\"token comment\">// 分析并手机 content 中的@用户</span>\n  <span class=\"token comment\">// content格式</span>\n  <span class=\"token keyword\">const</span> atUserNameList <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span>\n  content <span class=\"token operator\">=</span> content<span class=\"token punctuation\">.</span><span class=\"token function\">replace</span><span class=\"token punctuation\">(</span><span class=\"token constant\">REG_FOR_AT_WHO</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">matchStr<span class=\"token punctuation\">,</span> nickName<span class=\"token punctuation\">,</span> userName</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span>\n    <span class=\"token comment\">// 目的是获取用户名</span>\n    atUserNameList<span class=\"token punctuation\">.</span><span class=\"token function\">push</span><span class=\"token punctuation\">(</span>userName<span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">return</span> matchStr <span class=\"token comment\">//替换不生效</span>\n  <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span>\n  <span class=\"token comment\">// 根据 @ 用户名查询用户信息</span>\n  <span class=\"token keyword\">const</span> atUserList <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> Promise<span class=\"token punctuation\">.</span><span class=\"token function\">all</span><span class=\"token punctuation\">(</span>\n    atUserNameList<span class=\"token punctuation\">.</span><span class=\"token function\">map</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">userName</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token function\">getUserInfo</span><span class=\"token punctuation\">(</span>userName<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">)</span>\n  <span class=\"token comment\">// 根据用户信息 获取id</span>\n  <span class=\"token keyword\">const</span> atUserIdList <span class=\"token operator\">=</span> atUserList<span class=\"token punctuation\">.</span><span class=\"token function\">map</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">user</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> user<span class=\"token punctuation\">.</span>id<span class=\"token punctuation\">)</span>\n  <span class=\"token comment\">// servers</span>\n  <span class=\"token keyword\">try</span> <span class=\"token punctuation\">&#123;</span>\n    <span class=\"token keyword\">const</span> blog <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> <span class=\"token function\">createBlog</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">&#123;</span> userId<span class=\"token punctuation\">,</span> content<span class=\"token operator\">:</span> <span class=\"token function\">xss</span><span class=\"token punctuation\">(</span>content<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> image <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span>\n    <span class=\"token comment\">// 创建at关系</span>\n    <span class=\"token keyword\">await</span> Promise<span class=\"token punctuation\">.</span><span class=\"token function\">all</span><span class=\"token punctuation\">(</span>\n      atUserIdList<span class=\"token punctuation\">.</span><span class=\"token function\">map</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">userId</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span>\n        <span class=\"token function\">createAtReplation</span><span class=\"token punctuation\">(</span>blog<span class=\"token punctuation\">.</span>id<span class=\"token punctuation\">,</span> userId<span class=\"token punctuation\">)</span>\n      <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">)</span>\n    <span class=\"token comment\">// 返回</span>\n    <span class=\"token keyword\">return</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">SuccessModel</span><span class=\"token punctuation\">(</span>blog<span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span>error<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n    console<span class=\"token punctuation\">.</span><span class=\"token function\">error</span><span class=\"token punctuation\">(</span>error<span class=\"token punctuation\">.</span>message<span class=\"token punctuation\">,</span> error<span class=\"token punctuation\">.</span>stack<span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">return</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">ErrorModel</span><span class=\"token punctuation\">(</span>createBlogFailInfo<span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">&#125;</span>\n<span class=\"token punctuation\">&#125;</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n<p>服务层</p>\n<pre class=\"line-numbers language-javascript\" data-language=\"javascript\"><code class=\"language-javascript\"><span class=\"token comment\">/**\n * @description: 微博 @ 用户关系\n * @author: 小康\n * @url: https://xiaokang.me\n * @Date: 2020-12-20 11:39:05\n * @LastEditTime: 2020-12-20 11:39:06\n * @LastEditors: 小康\n */</span>\n\n<span class=\"token keyword\">const</span> <span class=\"token punctuation\">&#123;</span> AtRelation <span class=\"token punctuation\">&#125;</span> <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'../db/model'</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token comment\">/**\n * @author: 小康\n * @url: https://xiaokang.me\n * @param &#123;*&#125; blogId\n * @param &#123;*&#125; userId\n * @description: 创建微博艾特用户的关系\n */</span>\n<span class=\"token keyword\">async</span> <span class=\"token keyword\">function</span> <span class=\"token function\">createAtReplation</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">blogId<span class=\"token punctuation\">,</span> userId</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n  <span class=\"token keyword\">const</span> result <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> AtRelation<span class=\"token punctuation\">.</span><span class=\"token function\">create</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">&#123;</span>\n    blogId<span class=\"token punctuation\">,</span>\n    userId\n  <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span>\n  <span class=\"token keyword\">return</span> result<span class=\"token punctuation\">.</span>dataValues\n<span class=\"token punctuation\">&#125;</span>\n\nmodule<span class=\"token punctuation\">.</span>exports <span class=\"token operator\">=</span> <span class=\"token punctuation\">&#123;</span> createAtReplation <span class=\"token punctuation\">&#125;</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n<h2 id=\"显示at数量\"><a class=\"markdownIt-Anchor\" href=\"#显示at数量\"></a> 显示at数量</h2>\n<ol>\n<li>\n<p>视图路由层</p>\n<pre class=\"line-numbers language-javascript\" data-language=\"javascript\"><code class=\"language-javascript\"><span class=\"token comment\">// 获取 @ 数量</span>\n<span class=\"token keyword\">const</span> atCount <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> <span class=\"token function\">getAtMeCount</span><span class=\"token punctuation\">(</span>userId<span class=\"token punctuation\">)</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span></span></code></pre>\n<p>只需要调用控制器层的方法获取数量即可。</p>\n</li>\n<li>\n<p>控制器层</p>\n<pre class=\"line-numbers language-javascript\" data-language=\"javascript\"><code class=\"language-javascript\"><span class=\"token comment\">/**\n * @description: 微博 @ 关系\n * @author: 小康\n * @url: https://xiaokang.me\n * @Date: 2020-12-20 14:10:21\n * @LastEditTime: 2020-12-20 14:10:23\n * @LastEditors: 小康\n */</span>\n\n<span class=\"token keyword\">const</span> <span class=\"token punctuation\">&#123;</span> getAtRelationCount <span class=\"token punctuation\">&#125;</span> <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'../services/at-relation'</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">const</span> <span class=\"token punctuation\">&#123;</span> SuccessModel <span class=\"token punctuation\">&#125;</span> <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'../model/ResModel'</span><span class=\"token punctuation\">)</span>\n<span class=\"token comment\">/**\n * @author: 小康\n * @url: https://xiaokang.me\n * @param &#123;*&#125; userId\n * @description: 获取 @ 我的微博数量\n */</span>\n<span class=\"token keyword\">async</span> <span class=\"token keyword\">function</span> <span class=\"token function\">getAtMeCount</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">userId</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n  <span class=\"token keyword\">const</span> count <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> <span class=\"token function\">getAtRelationCount</span><span class=\"token punctuation\">(</span>userId<span class=\"token punctuation\">)</span>\n  <span class=\"token keyword\">return</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">SuccessModel</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">&#123;</span> count <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">&#125;</span>\n\nmodule<span class=\"token punctuation\">.</span>exports <span class=\"token operator\">=</span> <span class=\"token punctuation\">&#123;</span>\n  getAtMeCount\n<span class=\"token punctuation\">&#125;</span>\n<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n</li>\n<li>\n<p>服务层</p>\n<pre class=\"line-numbers language-javascript\" data-language=\"javascript\"><code class=\"language-javascript\"><span class=\"token comment\">/**\n * @author: 小康\n * @url: https://xiaokang.me\n * @param &#123;*&#125; userId\n * @description: 获取at用户的微博数量（未读）\n */</span>\n<span class=\"token keyword\">async</span> <span class=\"token keyword\">function</span> <span class=\"token function\">getAtRelationCount</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">userId</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n  <span class=\"token keyword\">const</span> result <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> AtRelation<span class=\"token punctuation\">.</span><span class=\"token function\">findAndCountAll</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">&#123;</span>\n    where<span class=\"token operator\">:</span> <span class=\"token punctuation\">&#123;</span>\n      userId<span class=\"token punctuation\">,</span>\n      isRead<span class=\"token operator\">:</span> <span class=\"token boolean\">false</span>\n    <span class=\"token punctuation\">&#125;</span>\n  <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span>\n  <span class=\"token keyword\">return</span> result<span class=\"token punctuation\">.</span>count\n<span class=\"token punctuation\">&#125;</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n</li>\n</ol>\n<h2 id=\"me页面\"><a class=\"markdownIt-Anchor\" href=\"#me页面\"></a> @me页面</h2>\n<ol>\n<li>\n<p>视图路由层</p>\n<pre class=\"line-numbers language-javascript\" data-language=\"javascript\"><code class=\"language-javascript\"><span class=\"token comment\">// @ 我的页面</span>\nrouter<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token string\">'/at-me'</span><span class=\"token punctuation\">,</span> loginRedirect<span class=\"token punctuation\">,</span> <span class=\"token keyword\">async</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">ctx<span class=\"token punctuation\">,</span> next</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span>\n  <span class=\"token keyword\">const</span> <span class=\"token punctuation\">&#123;</span> id<span class=\"token operator\">:</span> userId <span class=\"token punctuation\">&#125;</span> <span class=\"token operator\">=</span> ctx<span class=\"token punctuation\">.</span>session<span class=\"token punctuation\">.</span>userInfo\n  <span class=\"token comment\">// 获取 @ 我的数量</span>\n  <span class=\"token keyword\">const</span> atCountResult <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> <span class=\"token function\">getAtMeCount</span><span class=\"token punctuation\">(</span>userId<span class=\"token punctuation\">)</span>\n  <span class=\"token keyword\">const</span> <span class=\"token punctuation\">&#123;</span> count<span class=\"token operator\">:</span> atCount <span class=\"token punctuation\">&#125;</span> <span class=\"token operator\">=</span> atCountResult<span class=\"token punctuation\">.</span>data\n  <span class=\"token comment\">// 获取第一页列表</span>\n  <span class=\"token keyword\">const</span> result <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> <span class=\"token function\">getAtMeBlogList</span><span class=\"token punctuation\">(</span>userId<span class=\"token punctuation\">)</span>\n  <span class=\"token keyword\">const</span> <span class=\"token punctuation\">&#123;</span> isEmpty<span class=\"token punctuation\">,</span> blogList<span class=\"token punctuation\">,</span> pageSize<span class=\"token punctuation\">,</span> pageIndex<span class=\"token punctuation\">,</span> count <span class=\"token punctuation\">&#125;</span> <span class=\"token operator\">=</span> result<span class=\"token punctuation\">.</span>data\n  <span class=\"token comment\">// 渲染页面</span>\n  <span class=\"token keyword\">await</span> ctx<span class=\"token punctuation\">.</span><span class=\"token function\">render</span><span class=\"token punctuation\">(</span><span class=\"token string\">'atMe'</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">&#123;</span>\n    blogData<span class=\"token operator\">:</span> <span class=\"token punctuation\">&#123;</span>\n      isEmpty<span class=\"token punctuation\">,</span>\n      blogList<span class=\"token punctuation\">,</span>\n      pageSize<span class=\"token punctuation\">,</span>\n      pageIndex<span class=\"token punctuation\">,</span>\n      count\n    <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span>\n    atCount\n  <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span>\n  <span class=\"token comment\">// 标记为已读</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>atCount <span class=\"token operator\">></span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n  <span class=\"token punctuation\">&#125;</span>\n<span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n</li>\n<li>\n<p>控制器层</p>\n<pre class=\"line-numbers language-javascript\" data-language=\"javascript\"><code class=\"language-javascript\"><span class=\"token comment\">/**\n * @author: 小康\n * @url: https://xiaokang.me\n * @param &#123;*&#125; userId\n * @param &#123;*&#125; pageIndex\n * @description: 获取@ 用户的微博列表\n */</span>\n<span class=\"token keyword\">async</span> <span class=\"token keyword\">function</span> <span class=\"token function\">getAtMeBlogList</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">userId<span class=\"token punctuation\">,</span> pageIndex <span class=\"token operator\">=</span> <span class=\"token number\">0</span></span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n  <span class=\"token comment\">// service</span>\n  <span class=\"token keyword\">const</span> result <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> <span class=\"token function\">getUserBlogList</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">&#123;</span>\n    userId<span class=\"token punctuation\">,</span>\n    pageIndex<span class=\"token punctuation\">,</span>\n    pageSize<span class=\"token operator\">:</span> <span class=\"token constant\">PAGE_SIZE</span>\n  <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span>\n  <span class=\"token keyword\">const</span> <span class=\"token punctuation\">&#123;</span> count<span class=\"token punctuation\">,</span> blogList <span class=\"token punctuation\">&#125;</span> <span class=\"token operator\">=</span> result\n\n  <span class=\"token comment\">// 返回</span>\n  <span class=\"token keyword\">return</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">SuccessModel</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">&#123;</span>\n    isEmpty<span class=\"token operator\">:</span> blogList<span class=\"token punctuation\">.</span>length <span class=\"token operator\">===</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span>\n    blogList<span class=\"token punctuation\">,</span>\n    pageSize<span class=\"token operator\">:</span> <span class=\"token constant\">PAGE_SIZE</span><span class=\"token punctuation\">,</span>\n    pageIndex<span class=\"token punctuation\">,</span>\n    count\n  <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">&#125;</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n</li>\n<li>\n<p>服务层</p>\n<pre class=\"line-numbers language-javascript\" data-language=\"javascript\"><code class=\"language-javascript\"><span class=\"token comment\">/**\n * @author: 小康\n * @url: https://xiaokang.me\n * @param &#123;*&#125; userId\n * @param &#123;*&#125; pageIndex\n * @param &#123;*&#125; pageSize\n * @description: 获取 @ 用户的微博列表\n */</span>\n<span class=\"token keyword\">async</span> <span class=\"token keyword\">function</span> <span class=\"token function\">getUserBlogList</span><span class=\"token punctuation\">(</span><span class=\"token parameter\"><span class=\"token punctuation\">&#123;</span> userId<span class=\"token punctuation\">,</span> pageIndex<span class=\"token punctuation\">,</span> pageSize <span class=\"token operator\">=</span> <span class=\"token constant\">PAGE_SIZE</span> <span class=\"token punctuation\">&#125;</span></span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n  <span class=\"token keyword\">const</span> result <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> Blog<span class=\"token punctuation\">.</span><span class=\"token function\">findAndCountAll</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">&#123;</span>\n    limit<span class=\"token operator\">:</span> pageSize<span class=\"token punctuation\">,</span>\n    offset<span class=\"token operator\">:</span> pageSize <span class=\"token operator\">*</span> pageIndex<span class=\"token punctuation\">,</span>\n    order<span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">[</span><span class=\"token string\">'id'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'desc'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n    include<span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span>\n      <span class=\"token comment\">// @ 关系</span>\n      <span class=\"token punctuation\">&#123;</span>\n        model<span class=\"token operator\">:</span> AtRelation<span class=\"token punctuation\">,</span>\n        attributes<span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token string\">'userId'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'blogId'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n        where<span class=\"token operator\">:</span> <span class=\"token punctuation\">&#123;</span> userId <span class=\"token punctuation\">&#125;</span>\n      <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span>\n      <span class=\"token comment\">// 用户</span>\n      <span class=\"token punctuation\">&#123;</span>\n        model<span class=\"token operator\">:</span> User<span class=\"token punctuation\">,</span>\n        attributes<span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token string\">'userName'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'nickName'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'picture'</span><span class=\"token punctuation\">]</span>\n      <span class=\"token punctuation\">&#125;</span>\n    <span class=\"token punctuation\">]</span>\n  <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span>\n  <span class=\"token keyword\">let</span> blogList <span class=\"token operator\">=</span> result<span class=\"token punctuation\">.</span>rows<span class=\"token punctuation\">.</span><span class=\"token function\">map</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">row</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> row<span class=\"token punctuation\">.</span>dataValues<span class=\"token punctuation\">)</span>\n  blogList <span class=\"token operator\">=</span> <span class=\"token function\">formatBlog</span><span class=\"token punctuation\">(</span>blogList<span class=\"token punctuation\">)</span>\n  blogList <span class=\"token operator\">=</span> blogList<span class=\"token punctuation\">.</span><span class=\"token function\">map</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">blogItem</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span>\n    blogItem<span class=\"token punctuation\">.</span>user <span class=\"token operator\">=</span> <span class=\"token function\">formatUser</span><span class=\"token punctuation\">(</span>blogItem<span class=\"token punctuation\">.</span>user<span class=\"token punctuation\">.</span>dataValues<span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">return</span> blogItem\n  <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span>\n  <span class=\"token keyword\">return</span> <span class=\"token punctuation\">&#123;</span>\n    count<span class=\"token operator\">:</span> result<span class=\"token punctuation\">.</span>count<span class=\"token punctuation\">,</span>\n    blogList\n  <span class=\"token punctuation\">&#125;</span>\n<span class=\"token punctuation\">&#125;</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n</li>\n</ol>\n<h2 id=\"消息已读\"><a class=\"markdownIt-Anchor\" href=\"#消息已读\"></a> @消息已读</h2>\n<ol>\n<li>\n<p>试图层</p>\n<p>试图层调用方法即可</p>\n<pre class=\"line-numbers language-javascript\" data-language=\"javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>atCount <span class=\"token operator\">></span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n  <span class=\"token function\">markAsRead</span><span class=\"token punctuation\">(</span>userId<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">&#125;</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span></span></code></pre>\n</li>\n<li>\n<p>控制层</p>\n<pre class=\"line-numbers language-javascript\" data-language=\"javascript\"><code class=\"language-javascript\"><span class=\"token comment\">/**\n * @author: 小康\n * @url: https://xiaokang.me\n * @param &#123;*&#125; userId\n * @description: 标记已读\n */</span>\n<span class=\"token keyword\">async</span> <span class=\"token keyword\">function</span> <span class=\"token function\">markAsRead</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">userId</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n  <span class=\"token keyword\">try</span> <span class=\"token punctuation\">&#123;</span>\n    <span class=\"token keyword\">await</span> <span class=\"token function\">updataAtRelation</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">&#123;</span> newIsRead<span class=\"token operator\">:</span> <span class=\"token boolean\">true</span> <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">&#123;</span> userId<span class=\"token punctuation\">,</span> isRead<span class=\"token operator\">:</span> <span class=\"token boolean\">false</span> <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span>error<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n    console<span class=\"token punctuation\">.</span><span class=\"token function\">error</span><span class=\"token punctuation\">(</span>error<span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">&#125;</span>\n  <span class=\"token comment\">// 不需要返回</span>\n<span class=\"token punctuation\">&#125;</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n</li>\n<li>\n<p>服务层</p>\n<pre class=\"line-numbers language-javascript\" data-language=\"javascript\"><code class=\"language-javascript\"><span class=\"token comment\">/**\n * @author: 小康\n * @url: https://xiaokang.me\n * @param &#123;Object&#125; 要更新的内容\n * @param &#123;Object&#125; 条件\n * @description: 更新数据\n */</span>\n<span class=\"token keyword\">async</span> <span class=\"token keyword\">function</span> <span class=\"token function\">updataAtRelation</span><span class=\"token punctuation\">(</span><span class=\"token parameter\"><span class=\"token punctuation\">&#123;</span> newIsRead <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">&#123;</span> userId<span class=\"token punctuation\">,</span> isRead <span class=\"token punctuation\">&#125;</span></span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n  <span class=\"token comment\">// 拼接更新内容</span>\n  <span class=\"token keyword\">const</span> updataData <span class=\"token operator\">=</span> <span class=\"token punctuation\">&#123;</span><span class=\"token punctuation\">&#125;</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>newIsRead<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n    updataData<span class=\"token punctuation\">.</span>isRead <span class=\"token operator\">=</span> newIsRead\n  <span class=\"token punctuation\">&#125;</span>\n  <span class=\"token comment\">// 拼接查询条件</span>\n  <span class=\"token keyword\">const</span> whereData <span class=\"token operator\">=</span> <span class=\"token punctuation\">&#123;</span><span class=\"token punctuation\">&#125;</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>userId<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n    whereData<span class=\"token punctuation\">.</span>userId <span class=\"token operator\">=</span> userId\n  <span class=\"token punctuation\">&#125;</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>isRead<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n    whereData<span class=\"token punctuation\">.</span>isRead <span class=\"token operator\">=</span> isRead\n  <span class=\"token punctuation\">&#125;</span>\n  <span class=\"token comment\">// 执行更新</span>\n  <span class=\"token keyword\">const</span> result <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> AtRelation<span class=\"token punctuation\">.</span><span class=\"token function\">update</span><span class=\"token punctuation\">(</span>updataData<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">&#123;</span>\n    where<span class=\"token operator\">:</span> whereData\n  <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span>\n  <span class=\"token keyword\">return</span> result<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">></span> <span class=\"token number\">0</span>\n<span class=\"token punctuation\">&#125;</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n</li>\n</ol>\n","categories":[{"name":"慕课网","path":"api/categories/慕课网.json"},{"name":"Koa2","path":"api/categories/Koa2.json"}],"tags":[{"name":"koa2","path":"api/tags/koa2.json"}]}